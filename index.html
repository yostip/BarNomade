<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Gestion FÃ»ts - Hellfest 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: system-ui, -apple-system, sans-serif; overscroll-behavior: none; }
    #loading-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    #loading-screen.hidden { display: none; }
    .loader { width: 50px; height: 50px; border: 4px solid #333; border-top-color: #39ff14; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <div id="loading-screen">
    <div class="loader"></div>
    <p style="margin-top: 20px; font-size: 14px; color: #39ff14;">HELLFEST 2026</p>
  </div>
  
  <div id="root"></div>
  
  <!-- Firebase et dÃ©pendances (chargÃ©s EN PREMIER) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
  
  <!-- Preact + htm (ultra lÃ©ger ~5KB) -->
  <script type="module">
import { h, render } from 'https://esm.sh/preact@10.19.3';
import { useState, useEffect, useRef, useCallback } from 'https://esm.sh/preact@10.19.3/hooks';
import htm from 'https://esm.sh/htm@3.1.1';

const html = htm.bind(h);

// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyCgl30syyCEJif9q96E2jzv-aTXxXgvgv0",
  authDomain: "gestion-futs-hellfest.firebaseapp.com",
  databaseURL: "https://gestion-futs-hellfest-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gestion-futs-hellfest",
  storageBucket: "gestion-futs-hellfest.firebasestorage.app",
  messagingSenderId: "107509834680",
  appId: "1:107509834680:web:3a58295d3268b5d19f654d"
};
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Hash mots de passe
const HASH_SUPER_ADMIN = "a1f86d4b304cb14f61f415122ab573659b81a20cb6c33f4cdb813578fa9b01ec";
const HASH_ADMIN = "992a785802be9620a8fbabefd5bf0468624d22be7d376943f7a0f1184bb61d6a";
const verifyPassword = (password, targetRole) => {
  const hash = sha256(password);
  if (targetRole === "superadmin") return hash === HASH_SUPER_ADMIN;
  if (targetRole === "admin") return hash === HASH_ADMIN;
  return false;
};

// RÃ´les et permissions
const ROLES = { SUPERADMIN: "superadmin", ADMIN: "admin", SECRETAIRE: "secretaire", VISITEUR: "visiteur" };
const PERMISSIONS = {
  view_bars: ["superadmin", "admin", "secretaire", "visiteur"],
  attribuer_fut: ["superadmin", "admin", "secretaire"],
  retourner_fut: ["superadmin", "admin", "secretaire"],
  enregistrer_vente: ["superadmin", "admin", "secretaire"],
  saisir_benevoles: ["superadmin", "admin", "secretaire"],
  gerer_bars: ["superadmin", "admin"],
  exports: ["superadmin", "admin"],
  voir_historiques: ["superadmin", "admin"],
  annuler_mouvement: ["superadmin", "admin"],
  dashboard: ["superadmin", "admin"],
  ejecter_secretaire: ["superadmin", "admin"],
  promouvoir_secretaire: ["superadmin", "admin"],
  ejecter_admin: ["superadmin"],
  modifier_config: ["superadmin"],
  reinitialisation_rgpd: ["superadmin"],
  promouvoir_admin: ["superadmin"]
};
const canDo = (role, action) => PERMISSIONS[action]?.includes(role) || false;
const getRoleLabel = (role) => ({ superadmin: "ğŸ‘‘ Super Admin", admin: "ğŸ” Admin", secretaire: "ğŸ“ SecrÃ©taire", visiteur: "ğŸ‘ï¸ Visiteur" }[role] || "ğŸ‘ï¸ Visiteur");
const getRoleColor = (role) => ({ superadmin: "text-yellow-400", admin: "text-blue-400", secretaire: "text-green-400", visiteur: "text-neutral-400" }[role] || "text-neutral-400");

// Utilitaires
const hideLoadingScreen = () => document.getElementById('loading-screen')?.classList.add('hidden');
const formatDate = (ts) => ts ? new Date(ts).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

// Badge rÃ´le
const RoleBadge = ({ role }) => html`<span class="text-xs px-2 py-0.5 rounded-full bg-neutral-800 ${getRoleColor(role)}">${getRoleLabel(role)}</span>`;

// ==================== LOGIN SCREEN ====================
const LoginScreen = ({ onLogin }) => {
  const [mode, setMode] = useState('choice');
  const [sessionCode, setSessionCode] = useState('');
  const [userName, setUserName] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [showSuperAdminPanel, setShowSuperAdminPanel] = useState(false);
  const [allSessions, setAllSessions] = useState([]);

  useEffect(() => {
    hideLoadingScreen();
    const saved = localStorage.getItem('gestionFuts_session');
    if (saved) {
      const { session, userName, isCreator, role } = JSON.parse(saved);
      database.ref(`sessions/${session}`).once('value', snap => {
        if (snap.exists()) onLogin(session, userName, isCreator, role || 'visiteur');
        else localStorage.removeItem('gestionFuts_session');
      });
    }
  }, []);

  const loadAllSessions = async () => {
    const snap = await database.ref('sessions').once('value');
    if (snap.exists()) {
      setAllSessions(Object.entries(snap.val()).map(([code, data]) => ({
        code, createdAt: data.config?.createdAt, createdBy: data.config?.createdBy,
        usersCount: data.users ? Object.keys(data.users).length : 0
      })));
    }
  };

  const createSession = async () => {
    if (!userName.trim()) return setError('Nom requis');
    if (!verifyPassword(password, 'superadmin')) return setError('Mot de passe Super Admin incorrect');
    setLoading(true);
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    const config = {
      stockInitialBiere: 150, stockInitialCidre: 50, maxFutsParBar: 3, nombreJours: 4,
      prixPinte: 7, prixPichet: 17, prixGobelet: 5, volumePinte: 0.5, volumePichet: 1.5,
      volumeFutBiere: 30, volumeFutCidre: 20, seuilPerte: 15, createdAt: Date.now(), createdBy: userName.trim()
    };
    const creneaux = [{ id: 'c1', label: '14h-16h' }, { id: 'c2', label: '16h-18h' }, { id: 'c3', label: '18h-20h' }, { id: 'c4', label: '20h-22h' }, { id: 'c5', label: '22h-00h' }, { id: 'c6', label: '00h-02h' }];
    const bars = [{ id: 'bar1', nom: 'Bar Central', type: 'biere', futs: [] }, { id: 'bar2', nom: 'Bar Nord', type: 'biere', futs: [] }, { id: 'bar3', nom: 'Bar Cidre', type: 'cidre', futs: [] }];
    
    await database.ref(`sessions/${code}`).set({ config, jourActuel: 1, creneaux, barsNomades: bars.reduce((acc, b) => ({ ...acc, [b.id]: b }), {}) });
    await database.ref(`sessions/${code}/users/${userName.trim()}`).set({ role: 'superadmin', joinedAt: Date.now(), lastActive: Date.now() });
    
    localStorage.setItem('gestionFuts_session', JSON.stringify({ session: code, userName: userName.trim(), isCreator: true, role: 'superadmin' }));
    onLogin(code, userName.trim(), true, 'superadmin');
  };

  const joinSession = async () => {
    if (!sessionCode.trim() || !userName.trim()) return setError('Code et nom requis');
    setLoading(true);
    const code = sessionCode.trim().toUpperCase();
    const snap = await database.ref(`sessions/${code}`).once('value');
    if (!snap.exists()) { setLoading(false); return setError('Session introuvable'); }
    
    let role = 'visiteur';
    if (password && verifyPassword(password, 'superadmin')) role = 'superadmin';
    else if (password && verifyPassword(password, 'admin')) role = 'admin';
    
    let finalName = userName.trim();
    const usersSnap = await database.ref(`sessions/${code}/users`).once('value');
    if (usersSnap.exists() && usersSnap.val()[finalName]) {
      finalName = `${finalName}_${Date.now().toString(36).slice(-4)}`;
    }
    
    await database.ref(`sessions/${code}/users/${finalName}`).set({ role, joinedAt: Date.now(), lastActive: Date.now() });
    localStorage.setItem('gestionFuts_session', JSON.stringify({ session: code, userName: finalName, isCreator: false, role }));
    onLogin(code, finalName, false, role);
  };

  const deleteSession = async (code) => {
    if (!confirm(`Supprimer la session ${code} ?`)) return;
    await database.ref(`sessions/${code}`).remove();
    loadAllSessions();
  };

  // Rendu
  if (showSuperAdminPanel) {
    return html`
      <div class="min-h-screen bg-black p-4">
        <div class="max-w-lg mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-yellow-400">ğŸ‘‘ Panel Super Admin</h2>
            <button onClick=${() => setShowSuperAdminPanel(false)} class="text-neutral-400">âœ•</button>
          </div>
          <div class="space-y-2">
            ${allSessions.map(s => html`
              <div key=${s.code} class="flex items-center justify-between bg-neutral-900 p-3 rounded-lg">
                <div>
                  <p class="font-mono font-bold">${s.code}</p>
                  <p class="text-xs text-neutral-400">${s.createdBy} â€¢ ${s.usersCount} users</p>
                </div>
                <button onClick=${() => deleteSession(s.code)} class="text-red-400 text-sm">ğŸ—‘ï¸</button>
              </div>
            `)}
            ${allSessions.length === 0 && html`<p class="text-neutral-500 text-center py-4">Aucune session</p>`}
          </div>
          <button onClick=${() => { localStorage.clear(); location.reload(); }} class="w-full mt-6 py-3 bg-red-900 rounded-lg">ğŸ§¹ Purger localStorage</button>
        </div>
      </div>
    `;
  }

  return html`
    <div class="min-h-screen bg-black flex items-center justify-center p-4">
      <div class="w-full max-w-sm">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-black text-white">ğŸº GESTION FÃ›TS</h1>
          <p class="text-[#39ff14] font-bold">HELLFEST 2026</p>
        </div>
        
        ${error && html`<div class="bg-red-900/50 text-red-300 p-3 rounded-lg mb-4 text-sm">${error}</div>`}
        
        ${mode === 'choice' && html`
          <div class="space-y-3">
            <button onClick=${() => setMode('create')} class="w-full py-4 bg-red-600 hover:bg-red-700 rounded-xl font-bold text-lg">â• CrÃ©er une session</button>
            <button onClick=${() => setMode('join')} class="w-full py-4 bg-neutral-800 hover:bg-neutral-700 rounded-xl font-bold text-lg">ğŸ”— Rejoindre</button>
            <button onClick=${() => { loadAllSessions(); setShowSuperAdminPanel(true); }} class="w-full py-3 bg-yellow-600/20 text-yellow-400 rounded-xl text-sm">ğŸ‘‘ Panel Super Admin</button>
          </div>
        `}
        
        ${mode === 'create' && html`
          <div class="space-y-4">
            <input type="text" value=${userName} onInput=${e => setUserName(e.target.value)} placeholder="Votre nom" class="w-full px-4 py-3 bg-neutral-900 rounded-xl" />
            <input type="password" value=${password} onInput=${e => setPassword(e.target.value)} placeholder="Mot de passe Super Admin" class="w-full px-4 py-3 bg-neutral-900 rounded-xl" />
            <button onClick=${createSession} disabled=${loading} class="w-full py-4 bg-red-600 rounded-xl font-bold disabled:opacity-50">${loading ? '...' : 'ğŸš€ CrÃ©er'}</button>
            <button onClick=${() => setMode('choice')} class="w-full py-3 text-neutral-400">â† Retour</button>
          </div>
        `}
        
        ${mode === 'join' && html`
          <div class="space-y-4">
            <input type="text" value=${sessionCode} onInput=${e => setSessionCode(e.target.value.toUpperCase())} placeholder="Code session" class="w-full px-4 py-3 bg-neutral-900 rounded-xl font-mono text-center text-xl tracking-widest" maxlength="6" />
            <input type="text" value=${userName} onInput=${e => setUserName(e.target.value)} placeholder="Votre nom" class="w-full px-4 py-3 bg-neutral-900 rounded-xl" />
            <input type="password" value=${password} onInput=${e => setPassword(e.target.value)} placeholder="Mot de passe (optionnel)" class="w-full px-4 py-3 bg-neutral-900 rounded-xl" />
            <button onClick=${joinSession} disabled=${loading} class="w-full py-4 bg-emerald-600 rounded-xl font-bold disabled:opacity-50">${loading ? '...' : 'ğŸ”— Rejoindre'}</button>
            <button onClick=${() => setMode('choice')} class="w-full py-3 text-neutral-400">â† Retour</button>
          </div>
        `}
      </div>
    </div>
  `;
};

// ==================== MAIN APP ====================
const MainApp = ({ session, userName, isCreator, initialRole, onLogout }) => {
  // Ã‰tats donnÃ©es
  const [config, setConfig] = useState({ stockInitialBiere: 150, stockInitialCidre: 50, maxFutsParBar: 3, nombreJours: 4, prixPinte: 7, prixPichet: 17, prixGobelet: 5, volumePinte: 0.5, volumePichet: 1.5, volumeFutBiere: 30, volumeFutCidre: 20, seuilPerte: 15 });
  const [jourActuel, setJourActuel] = useState(1);
  const [barsNomades, setBarsNomades] = useState([]);
  const [historique, setHistorique] = useState([]);
  const [historiqueVentes, setHistoriqueVentes] = useState([]);
  const [creneaux, setCreneaux] = useState([]);
  const [users, setUsers] = useState({});
  const [role, setRole] = useState(initialRole);
  const [futsEnAttente, setFutsEnAttente] = useState([]);
  const [barPositions, setBarPositions] = useState({});
  const [benevoles, setBenevoles] = useState({});
  const [adminEmail, setAdminEmail] = useState('');
  
  // Ã‰tats UI
  const [notification, setNotification] = useState('');
  const [showModalSession, setShowModalSession] = useState(false);
  const [showModalAttribution, setShowModalAttribution] = useState(false);
  const [showModalVente, setShowModalVente] = useState(false);
  const [showModalParametres, setShowModalParametres] = useState(false);
  const [showModalHistorique, setShowModalHistorique] = useState(false);
  const [showModalHistoriqueVentes, setShowModalHistoriqueVentes] = useState(false);
  const [showModalDashboard, setShowModalDashboard] = useState(false);
  const [showModalPlan, setShowModalPlan] = useState(false);
  const [showModalExport, setShowModalExport] = useState(false);
  const [showModalBenevoles, setShowModalBenevoles] = useState(false);
  const [showModalReset, setShowModalReset] = useState(false);
  const [showModalQR, setShowModalQR] = useState(false);
  const [editingPlan, setEditingPlan] = useState(false);
  const [newArrivals, setNewArrivals] = useState([]);
  
  const isDisconnectingRef = useRef(false);
  const sessionRef = database.ref(`sessions/${session}`);
  
  const isAdmin = role === 'admin' || role === 'superadmin';
  const isSuperAdmin = role === 'superadmin';
  const isSecretaire = role === 'secretaire' || isAdmin;

  // Notifications
  const showNotification = (msg) => { setNotification(msg); setTimeout(() => setNotification(''), 3000); };

  // Firebase listeners
  useEffect(() => {
    hideLoadingScreen();
    const refs = [];
    const addRef = (path, cb) => { const ref = sessionRef.child(path); ref.on('value', cb); refs.push(ref); };
    
    addRef('config', snap => { if (snap.exists()) { const cfg = snap.val(); setConfig(cfg); if (cfg.adminEmail) setAdminEmail(cfg.adminEmail); } });
    addRef('jourActuel', snap => { if (snap.exists()) setJourActuel(snap.val()); });
    addRef('barsNomades', snap => { if (snap.exists()) setBarsNomades(Object.values(snap.val())); });
    addRef('historique', snap => { if (snap.exists()) setHistorique(Object.values(snap.val()).sort((a, b) => b.timestamp - a.timestamp)); else setHistorique([]); });
    addRef('historiqueVentes', snap => { if (snap.exists()) setHistoriqueVentes(Object.values(snap.val()).sort((a, b) => b.timestamp - a.timestamp)); else setHistoriqueVentes([]); });
    addRef('creneaux', snap => { if (snap.exists()) setCreneaux(snap.val()); });
    addRef('users', snap => {
      if (snap.exists()) {
        const u = snap.val();
        setUsers(u);
        if (u[userName]) setRole(u[userName].role);
        else if (!isDisconnectingRef.current) { alert('Vous avez Ã©tÃ© dÃ©connectÃ©'); onLogout(); }
        // Nouveaux arrivants
        const now = Date.now();
        const arrivals = Object.entries(u).filter(([name, data]) => data.role === 'visiteur' && (now - data.joinedAt) < 60000).map(([name]) => name);
        setNewArrivals(arrivals);
      }
    });
    addRef('futsEnAttente', snap => { if (snap.exists()) setFutsEnAttente(Object.values(snap.val())); else setFutsEnAttente([]); });
    addRef('barPositions', snap => { if (snap.exists()) setBarPositions(snap.val()); });
    addRef('benevoles', snap => { if (snap.exists()) setBenevoles(snap.val()); else setBenevoles({}); });
    
    // Heartbeat
    const hb = setInterval(() => sessionRef.child(`users/${userName}/lastActive`).set(Date.now()), 30000);
    
    return () => { refs.forEach(r => r.off()); clearInterval(hb); };
  }, []);

  // Calculs stocks
  const futsSortisBiere = historique.filter(m => m.type === 'SORTIE' && m.typeFut === 'biere' && m.jour === jourActuel).length;
  const futsSortisCidre = historique.filter(m => m.type === 'SORTIE' && m.typeFut === 'cidre' && m.jour === jourActuel).length;
  const futsRetoursBiere = historique.filter(m => m.type === 'RETOUR_PLEIN' && m.typeFut === 'biere' && m.jour === jourActuel).length;
  const futsRetoursCidre = historique.filter(m => m.type === 'RETOUR_PLEIN' && m.typeFut === 'cidre' && m.jour === jourActuel).length;
  const stockBiere = config.stockInitialBiere - futsSortisBiere + futsRetoursBiere;
  const stockCidre = config.stockInitialCidre - futsSortisCidre + futsRetoursCidre;

  // Actions
  const attribuerFut = async (barId, typeFut, futAttenteId = null) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (!bar) return;
    if ((bar.futs?.length || 0) >= config.maxFutsParBar) return showNotification('âŒ Bar au maximum');
    
    const futId = futAttenteId || `fut_${Date.now()}`;
    const newFut = { id: futId, dateAttribution: Date.now() };
    
    await sessionRef.child(`barsNomades/${barId}/futs`).set([...(bar.futs || []), newFut]);
    await sessionRef.child('historique').push({ id: futId, type: 'SORTIE', barId, barNom: bar.nom, typeFut: futAttenteId ? futsEnAttente.find(f => f.id === futAttenteId)?.typeFut : typeFut, jour: jourActuel, timestamp: Date.now(), user: userName });
    
    if (futAttenteId) await sessionRef.child(`futsEnAttente/${futAttenteId}`).remove();
    showNotification(`âœ… FÃ»t attribuÃ© Ã  ${bar.nom}`);
  };

  const retournerFut = async (barId, futId, etat) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (!bar) return;
    const fut = bar.futs?.find(f => f.id === futId);
    if (!fut) return;
    
    const newFuts = bar.futs.filter(f => f.id !== futId);
    await sessionRef.child(`barsNomades/${barId}/futs`).set(newFuts.length ? newFuts : null);
    
    const typeRetour = etat === 'vide' ? 'RETOUR_VIDE' : etat === 'casse' ? 'RETOUR_CASSE' : 'RETOUR_PLEIN';
    await sessionRef.child('historique').push({ id: futId, type: typeRetour, barId, barNom: bar.nom, typeFut: bar.type, jour: jourActuel, timestamp: Date.now(), user: userName });
    
    if (etat === 'plein') {
      await sessionRef.child(`futsEnAttente/${futId}`).set({ id: futId, typeFut: bar.type, fromBar: bar.nom, timestamp: Date.now() });
    }
    showNotification(`âœ… FÃ»t ${etat}`);
  };

  const enregistrerVente = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const barId = fd.get('barId');
    const bar = barsNomades.find(b => b.id === barId);
    const creneau = creneaux.find(c => c.id === fd.get('creneauId'));
    
    await sessionRef.child('historiqueVentes').push({
      id: `vente_${Date.now()}`, barId, barNom: bar?.nom, barType: bar?.type,
      creneauId: creneau?.id, creneauLabel: creneau?.label,
      montant: parseFloat(fd.get('montant')) || 0,
      pintes: parseInt(fd.get('pintes')) || 0, pichets: parseInt(fd.get('pichets')) || 0, gobelets: parseInt(fd.get('gobelets')) || 0,
      jour: jourActuel, timestamp: Date.now(), user: userName
    });
    setShowModalVente(false);
    showNotification('âœ… Vente enregistrÃ©e');
  };

  const promouvoir = async (name, newRole) => {
    await sessionRef.child(`users/${name}/role`).set(newRole);
    showNotification(`âœ… ${name} â†’ ${getRoleLabel(newRole)}`);
  };

  const ejecter = async (name) => {
    if (!confirm(`Ã‰jecter ${name} ?`)) return;
    await sessionRef.child(`users/${name}`).remove();
    showNotification(`âœ… ${name} Ã©jectÃ©`);
  };

  const disconnect = () => {
    isDisconnectingRef.current = true;
    sessionRef.child(`users/${userName}`).remove();
    localStorage.removeItem('gestionFuts_session');
    onLogout();
  };

  const changerJour = async (delta) => {
    const newJour = Math.max(1, Math.min(config.nombreJours, jourActuel + delta));
    await sessionRef.child('jourActuel').set(newJour);
  };

  const ajouterBar = async (nom, type) => {
    const id = `bar_${Date.now()}`;
    await sessionRef.child(`barsNomades/${id}`).set({ id, nom, type, futs: [] });
    showNotification('âœ… Bar ajoutÃ©');
  };

  const supprimerBar = async (barId) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (bar?.futs?.length > 0) return showNotification('âŒ Retournez les fÃ»ts d\'abord');
    await sessionRef.child(`barsNomades/${barId}`).remove();
    showNotification('âœ… Bar supprimÃ©');
  };

  const annulerMouvement = async (mvt) => {
    if (!confirm('Annuler ce mouvement ?')) return;
    await sessionRef.child(`historique/${Object.keys((await sessionRef.child('historique').once('value')).val() || {}).find(k => (sessionRef.child('historique').once('value')).val()?.[k]?.id === mvt.id)}`).remove();
    showNotification('âœ… Mouvement annulÃ©');
  };

  const resetRGPD = async () => {
    if (!confirm('âš ï¸ ATTENTION: Cette action supprimera TOUTES les donnÃ©es de la session (historiques, ventes, bÃ©nÃ©voles). Continuer ?')) return;
    await sessionRef.child('historique').remove();
    await sessionRef.child('historiqueVentes').remove();
    await sessionRef.child('benevoles').remove();
    await sessionRef.child('futsEnAttente').remove();
    for (const bar of barsNomades) {
      await sessionRef.child(`barsNomades/${bar.id}/futs`).remove();
    }
    setShowModalReset(false);
    showNotification('âœ… DonnÃ©es rÃ©initialisÃ©es');
  };

  // Export PDF
  const exportPDF = async () => {
    // Charger les libs
    if (!window.jspdf) await new Promise(r => { const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; s.onload = r; document.head.appendChild(s); });
    if (!window.jspdfAutoTableLoaded) await new Promise(r => { const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js'; s.onload = () => { window.jspdfAutoTableLoaded = true; r(); }; document.head.appendChild(s); });
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    let y = 20;
    
    // Calculs
    const caTotal = historiqueVentes.reduce((sum, v) => sum + (v.montant || 0), 0);
    const futsConsommes = historique.filter(m => ['RETOUR_VIDE', 'RETOUR_CASSE'].includes(m.type));
    const futsCasses = historique.filter(m => m.type === 'RETOUR_CASSE').length;
    
    // Page 1: Titre + SynthÃ¨se
    pdf.setFillColor(0, 0, 0);
    pdf.rect(0, 0, pageWidth, 40, 'F');
    pdf.setTextColor(57, 255, 20);
    pdf.setFontSize(22);
    pdf.text('RAPPORT HELLFEST 2026', pageWidth / 2, 18, { align: 'center' });
    pdf.setFontSize(11);
    pdf.setTextColor(200, 200, 200);
    pdf.text(`Session: ${session} | ${new Date().toLocaleString('fr-FR')}`, pageWidth / 2, 30, { align: 'center' });
    y = 50;
    
    // KPIs
    pdf.setTextColor(0, 0, 0);
    pdf.setFontSize(14);
    pdf.text('SYNTHÃˆSE', 15, y);
    y += 8;
    
    pdf.autoTable({
      startY: y,
      head: [['Indicateur', 'Valeur']],
      body: [
        ['CA Total', `${caTotal.toFixed(2)} â‚¬`],
        ['FÃ»ts consommÃ©s', `${futsConsommes.length}`],
        ['FÃ»ts cassÃ©s', `${futsCasses}`],
      ],
      theme: 'striped',
      headStyles: { fillColor: [57, 255, 20], textColor: [0, 0, 0] },
      styles: { fontSize: 10 }
    });
    y = pdf.lastAutoTable.finalY + 12;
    
    // CA par jour
    pdf.setFontSize(14);
    pdf.text('CA PAR JOUR', 15, y);
    y += 8;
    
    const jourData = Array.from({ length: config.nombreJours }, (_, i) => {
      const j = i + 1;
      const caJ = historiqueVentes.filter(v => v.jour === j).reduce((sum, v) => sum + (v.montant || 0), 0);
      return [`J${j}`, `${caJ.toFixed(2)} â‚¬`];
    });
    
    pdf.autoTable({
      startY: y,
      head: [['Jour', 'CA']],
      body: jourData,
      theme: 'striped',
      headStyles: { fillColor: [245, 158, 11], textColor: [0, 0, 0] },
      styles: { fontSize: 10, halign: 'center' }
    });
    y = pdf.lastAutoTable.finalY + 12;
    
    // CA par bar
    pdf.setFontSize(14);
    pdf.text('CA PAR BAR', 15, y);
    y += 8;
    
    const barData = barsNomades.map(bar => {
      const ca = historiqueVentes.filter(v => v.barId === bar.id).reduce((sum, v) => sum + (v.montant || 0), 0);
      return [bar.nom, `${ca.toFixed(2)} â‚¬`];
    }).sort((a, b) => parseFloat(b[1]) - parseFloat(a[1]));
    
    pdf.autoTable({
      startY: y,
      head: [['Bar', 'CA']],
      body: barData,
      theme: 'striped',
      headStyles: { fillColor: [34, 197, 94], textColor: [0, 0, 0] },
      styles: { fontSize: 10 }
    });
    
    pdf.save(`rapport_hellfest_${session}.pdf`);
    showNotification('ğŸ“„ PDF gÃ©nÃ©rÃ©');
  };

  // Export CSV
  const exportCSV = (type) => {
    let csv, filename;
    if (type === 'futs') {
      const headers = ['Date', 'Type', 'Bar', 'Type FÃ»t', 'Jour', 'Utilisateur'];
      const rows = historique.map(m => [formatDate(m.timestamp), m.type, m.barNom, m.typeFut, `J${m.jour}`, m.user]);
      csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      filename = `historique_futs_${session}.csv`;
    } else {
      const headers = ['Date', 'Bar', 'CrÃ©neau', 'Montant', 'Pintes', 'Pichets', 'Gobelets', 'Jour'];
      const rows = historiqueVentes.map(v => [formatDate(v.timestamp), v.barNom, v.creneauLabel, v.montant?.toFixed(2), v.pintes, v.pichets, v.gobelets, `J${v.jour}`]);
      csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      filename = `historique_ventes_${session}.csv`;
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    showNotification('ğŸ“¥ CSV exportÃ©');
  };

  // ========== RENDER ==========
  return html`
    <div class="min-h-screen bg-black text-white pb-24">
      <!-- Header -->
      <div class="bg-neutral-900 px-4 py-3 flex items-center justify-between sticky top-0 z-40">
        <div>
          <h1 class="font-bold text-lg">ğŸº Hellfest J${jourActuel}</h1>
          <p class="text-xs text-neutral-400">${userName} â€¢ <${RoleBadge} role=${role} /></p>
        </div>
        <button onClick=${() => setShowModalSession(true)} class="bg-neutral-800 px-3 py-2 rounded-lg text-sm font-mono">${session}</button>
      </div>
      
      <!-- Notification nouveaux arrivants -->
      ${isAdmin && newArrivals.length > 0 && html`
        <div class="mx-4 mt-2 p-3 bg-blue-900/50 rounded-lg border border-blue-600">
          <p class="text-sm font-medium">ğŸ†• Nouveaux arrivants: ${newArrivals.join(', ')}</p>
          <div class="flex gap-2 mt-2">
            ${newArrivals.map(name => html`
              <button key=${name} onClick=${() => promouvoir(name, 'secretaire')} class="text-xs bg-green-600 px-2 py-1 rounded">${name} â†’ SecrÃ©taire</button>
            `)}
          </div>
        </div>
      `}
      
      <!-- Stocks -->
      <div class="p-4 grid grid-cols-2 gap-3">
        <div class="bg-amber-900/30 p-4 rounded-xl border border-amber-700">
          <p class="text-xs text-amber-300">ğŸº Stock BiÃ¨re</p>
          <p class="text-3xl font-black text-amber-400">${stockBiere}</p>
          <p class="text-xs text-neutral-400">sur ${config.stockInitialBiere}</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-xl border border-green-700">
          <p class="text-xs text-green-300">ğŸ Stock Cidre</p>
          <p class="text-3xl font-black text-green-400">${stockCidre}</p>
          <p class="text-xs text-neutral-400">sur ${config.stockInitialCidre}</p>
        </div>
      </div>
      
      <!-- FÃ»ts en attente -->
      ${futsEnAttente.length > 0 && html`
        <div class="mx-4 mb-4 p-3 bg-purple-900/30 rounded-xl border border-purple-600">
          <p class="text-sm font-medium text-purple-300">ğŸ“¦ ${futsEnAttente.length} fÃ»t(s) en attente de rÃ©attribution</p>
        </div>
      `}
      
      <!-- Bars -->
      <div class="px-4 space-y-3">
        <h2 class="font-bold text-lg">Bars Nomades</h2>
        ${barsNomades.map(bar => html`
          <div key=${bar.id} class="bg-neutral-900 rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <p class="font-bold">${bar.type === 'biere' ? 'ğŸº' : 'ğŸ'} ${bar.nom}</p>
                <p class="text-xs text-neutral-400">${bar.futs?.length || 0}/${config.maxFutsParBar} fÃ»ts</p>
              </div>
              ${isSecretaire && html`
                <button onClick=${() => attribuerFut(bar.id, bar.type)} disabled=${(bar.futs?.length || 0) >= config.maxFutsParBar || (bar.type === 'biere' ? stockBiere : stockCidre) <= 0} class="bg-red-600 px-3 py-2 rounded-lg text-sm disabled:opacity-50">+ FÃ»t</button>
              `}
            </div>
            ${bar.futs?.length > 0 && html`
              <div class="space-y-2">
                ${bar.futs.map(fut => html`
                  <div key=${fut.id} class="flex items-center justify-between bg-neutral-800 p-2 rounded-lg text-sm">
                    <span class="font-mono text-xs">${fut.id.slice(-6)}</span>
                    ${isSecretaire && html`
                      <div class="flex gap-1">
                        <button onClick=${() => retournerFut(bar.id, fut.id, 'vide')} class="px-2 py-1 bg-orange-600 rounded text-xs">Vide</button>
                        <button onClick=${() => retournerFut(bar.id, fut.id, 'casse')} class="px-2 py-1 bg-red-600 rounded text-xs">CassÃ©</button>
                        <button onClick=${() => retournerFut(bar.id, fut.id, 'plein')} class="px-2 py-1 bg-blue-600 rounded text-xs">Plein</button>
                      </div>
                    `}
                  </div>
                `)}
              </div>
            `}
          </div>
        `)}
      </div>
      
      <!-- Barre d'actions -->
      <div class="fixed bottom-0 left-0 right-0 bg-neutral-900 border-t border-neutral-800 px-4 py-3">
        <div class="flex gap-2 justify-center flex-wrap">
          ${isSecretaire && html`<button onClick=${() => setShowModalVente(true)} class="px-4 py-2 bg-emerald-600 rounded-lg text-sm">ğŸ’° Vente</button>`}
          ${isAdmin && html`<button onClick=${() => setShowModalDashboard(true)} class="px-4 py-2 bg-amber-600 rounded-lg text-sm">ğŸ“Š Dashboard</button>`}
          <button onClick=${() => setShowModalPlan(true)} class="px-4 py-2 bg-blue-600 rounded-lg text-sm">ğŸ—ºï¸ Plan</button>
          ${isAdmin && html`<button onClick=${() => setShowModalHistorique(true)} class="px-4 py-2 bg-purple-600 rounded-lg text-sm">ğŸ“‹ Histo</button>`}
          ${isAdmin && html`<button onClick=${() => setShowModalExport(true)} class="px-4 py-2 bg-red-600 rounded-lg text-sm">ğŸ“¥ Export</button>`}
          ${isAdmin && html`<button onClick=${() => setShowModalParametres(true)} class="px-4 py-2 bg-neutral-700 rounded-lg text-sm">âš™ï¸</button>`}
        </div>
      </div>
      
      <!-- Notification toast -->
      ${notification && html`
        <div class="fixed top-16 left-4 right-4 bg-neutral-800 p-3 rounded-lg text-center z-50 animate-pulse">${notification}</div>
      `}
      
      <!-- MODALS -->
      
      <!-- Modal Session -->
      ${showModalSession && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
          <div class="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">ğŸ“± Session</h3>
            <div class="bg-neutral-800 p-4 rounded-xl mb-4 text-center">
              <p class="text-3xl font-mono font-bold tracking-widest">${session}</p>
              <button onClick=${() => setShowModalQR(true)} class="text-sm text-blue-400 mt-2">ğŸ“· QR Code</button>
            </div>
            
            <h4 class="font-bold mb-2">Utilisateurs (${Object.keys(users).length})</h4>
            <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">
              ${Object.entries(users).map(([name, data]) => html`
                <div key=${name} class="flex items-center justify-between bg-neutral-800 p-2 rounded-lg">
                  <div>
                    <p class="font-medium">${name} ${name === userName ? '(vous)' : ''}</p>
                    <${RoleBadge} role=${data.role} />
                  </div>
                  ${isAdmin && name !== userName && html`
                    <div class="flex gap-1">
                      ${canDo(role, 'promouvoir_secretaire') && data.role === 'visiteur' && html`
                        <button onClick=${() => promouvoir(name, 'secretaire')} class="text-xs bg-green-600 px-2 py-1 rounded">â†’ Sec</button>
                      `}
                      ${canDo(role, 'promouvoir_admin') && data.role === 'secretaire' && html`
                        <button onClick=${() => promouvoir(name, 'admin')} class="text-xs bg-blue-600 px-2 py-1 rounded">â†’ Adm</button>
                      `}
                      ${canDo(role, 'retrograder_visiteur') && data.role === 'secretaire' && html`
                        <button onClick=${() => promouvoir(name, 'visiteur')} class="text-xs bg-orange-600 px-2 py-1 rounded">â†’ Vis</button>
                      `}
                      ${((data.role === 'visiteur' && canDo(role, 'ejecter_visiteur')) || (data.role === 'secretaire' && canDo(role, 'ejecter_secretaire')) || (data.role === 'admin' && canDo(role, 'ejecter_admin'))) && html`
                        <button onClick=${() => ejecter(name)} class="text-xs bg-red-600 px-2 py-1 rounded">âœ•</button>
                      `}
                    </div>
                  `}
                </div>
              `)}
            </div>
            
            <div class="flex gap-2">
              <button onClick=${() => setShowModalSession(false)} class="flex-1 py-3 bg-neutral-700 rounded-lg">Fermer</button>
              <button onClick=${disconnect} class="py-3 px-4 bg-red-600 rounded-lg">Quitter</button>
            </div>
          </div>
        </div>
      `}
      
      <!-- Modal Vente -->
      ${showModalVente && isSecretaire && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
          <div class="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">ğŸ’° Nouvelle vente</h3>
            <form onSubmit=${enregistrerVente} class="space-y-4">
              <select name="barId" required class="w-full px-4 py-3 bg-neutral-800 rounded-lg">
                <option value="">SÃ©lectionner un bar</option>
                ${barsNomades.map(bar => html`<option key=${bar.id} value=${bar.id}>${bar.type === 'biere' ? 'ğŸº' : 'ğŸ'} ${bar.nom}</option>`)}
              </select>
              <select name="creneauId" required class="w-full px-4 py-3 bg-neutral-800 rounded-lg">
                ${creneaux.map(c => html`<option key=${c.id} value=${c.id}>${c.label}</option>`)}
              </select>
              <input type="number" name="montant" step="0.01" required placeholder="Montant (â‚¬)" class="w-full px-4 py-3 bg-neutral-800 rounded-lg" />
              <div class="grid grid-cols-3 gap-2">
                <input type="number" name="pintes" placeholder="Pintes" class="px-3 py-2 bg-neutral-800 rounded-lg text-center" />
                <input type="number" name="pichets" placeholder="Pichets" class="px-3 py-2 bg-neutral-800 rounded-lg text-center" />
                <input type="number" name="gobelets" placeholder="Gobelets" class="px-3 py-2 bg-neutral-800 rounded-lg text-center" />
              </div>
              <div class="flex gap-2">
                <button type="button" onClick=${() => setShowModalVente(false)} class="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                <button type="submit" class="flex-1 py-3 bg-emerald-600 rounded-lg font-medium">Valider</button>
              </div>
            </form>
          </div>
        </div>
      `}
      
      <!-- Modal Dashboard -->
      ${showModalDashboard && isAdmin && html`
        <div class="fixed inset-0 bg-black/90 flex flex-col z-50">
          <div class="bg-amber-900 px-4 py-3 flex items-center justify-between">
            <h3 class="text-xl font-bold">ğŸ“Š Dashboard J${jourActuel}</h3>
            <button onClick=${() => setShowModalDashboard(false)} class="text-2xl">âœ•</button>
          </div>
          <div class="flex-1 overflow-y-auto p-4">
            <div class="max-w-2xl mx-auto space-y-4">
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-900/30 p-4 rounded-xl border border-emerald-700">
                  <p class="text-xs text-emerald-300">ğŸ’° CA Jour</p>
                  <p class="text-3xl font-black text-emerald-400">${historiqueVentes.filter(v => v.jour === jourActuel).reduce((sum, v) => sum + (v.montant || 0), 0).toFixed(0)} â‚¬</p>
                </div>
                <div class="bg-blue-900/30 p-4 rounded-xl border border-blue-700">
                  <p class="text-xs text-blue-300">ğŸ›¢ï¸ FÃ»ts sortis</p>
                  <p class="text-3xl font-black text-blue-400">${historique.filter(m => m.type === 'SORTIE' && m.jour === jourActuel).length}</p>
                </div>
              </div>
              
              <div class="bg-neutral-800 p-4 rounded-xl">
                <h4 class="font-bold mb-3">ğŸ“Š CA par bar</h4>
                ${barsNomades.map(bar => {
                  const ca = historiqueVentes.filter(v => v.barId === bar.id && v.jour === jourActuel).reduce((sum, v) => sum + (v.montant || 0), 0);
                  return html`
                    <div key=${bar.id} class="flex items-center justify-between py-2 border-b border-neutral-700 last:border-0">
                      <span>${bar.type === 'biere' ? 'ğŸº' : 'ğŸ'} ${bar.nom}</span>
                      <span class="font-bold text-emerald-400">${ca.toFixed(0)} â‚¬</span>
                    </div>
                  `;
                })}
              </div>
              
              <div class="bg-neutral-800 p-4 rounded-xl">
                <h4 class="font-bold mb-3">ğŸ“… CA Total Festival</h4>
                <p class="text-2xl font-bold text-emerald-400">${historiqueVentes.reduce((sum, v) => sum + (v.montant || 0), 0).toFixed(0)} â‚¬</p>
              </div>
            </div>
          </div>
        </div>
      `}
      
      <!-- Modal Plan -->
      ${showModalPlan && html`
        <div class="fixed inset-0 bg-black/90 flex flex-col z-50">
          <div class="bg-blue-900 px-4 py-3 flex items-center justify-between">
            <h3 class="text-xl font-bold">ğŸ—ºï¸ Plan</h3>
            <div class="flex gap-2">
              ${isAdmin && html`
                <button onClick=${() => setEditingPlan(!editingPlan)} class=${`px-3 py-1 rounded text-sm ${editingPlan ? 'bg-green-600' : 'bg-neutral-700'}`}>${editingPlan ? 'âœ“ OK' : 'âœï¸ Ã‰diter'}</button>
              `}
              <button onClick=${() => setShowModalPlan(false)} class="text-2xl">âœ•</button>
            </div>
          </div>
          <div class="flex-1 relative bg-neutral-900" onClick=${(e) => {
            if (!editingPlan || !isAdmin) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            // Popup pour sÃ©lectionner un bar
          }}>
            ${barsNomades.map(bar => {
              const pos = barPositions[bar.id] || { x: 50, y: 50 };
              const futsCount = bar.futs?.length || 0;
              const color = futsCount === 0 ? 'bg-green-500' : futsCount >= config.maxFutsParBar ? 'bg-red-500' : 'bg-yellow-500';
              return html`
                <div key=${bar.id} class="absolute transform -translate-x-1/2 -translate-y-1/2" style=${{ left: `${pos.x}%`, top: `${pos.y}%` }}>
                  <div class=${`${color} px-2 py-1 rounded text-xs font-bold whitespace-nowrap`}>
                    ${bar.type === 'biere' ? 'ğŸº' : 'ğŸ'} ${bar.nom} (${futsCount})
                  </div>
                </div>
              `;
            })}
            <div class="absolute bottom-4 left-4 text-xs text-neutral-500">
              ğŸŸ¢ Disponible | ğŸŸ¡ En service | ğŸ”´ Complet
            </div>
          </div>
        </div>
      `}
      
      <!-- Modal Historique -->
      ${showModalHistorique && isAdmin && html`
        <div class="fixed inset-0 bg-black/90 flex flex-col z-50">
          <div class="bg-purple-900 px-4 py-3 flex items-center justify-between">
            <h3 class="text-xl font-bold">ğŸ“‹ Historique FÃ»ts</h3>
            <button onClick=${() => setShowModalHistorique(false)} class="text-2xl">âœ•</button>
          </div>
          <div class="flex-1 overflow-y-auto p-4">
            <div class="space-y-2">
              ${historique.slice(0, 50).map(mvt => html`
                <div key=${mvt.id} class="flex items-center justify-between bg-neutral-800 p-3 rounded-lg">
                  <div>
                    <p class="font-medium">${mvt.type} - ${mvt.barNom}</p>
                    <p class="text-xs text-neutral-400">${formatDate(mvt.timestamp)} â€¢ ${mvt.user}</p>
                  </div>
                  ${canDo(role, 'annuler_mouvement') && html`
                    <button onClick=${() => annulerMouvement(mvt)} class="text-red-400 text-sm">âœ•</button>
                  `}
                </div>
              `)}
              ${historique.length === 0 && html`<p class="text-center text-neutral-500 py-8">Aucun mouvement</p>`}
            </div>
          </div>
        </div>
      `}
      
      <!-- Modal Export -->
      ${showModalExport && isAdmin && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
          <div class="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">ğŸ“¥ Exporter</h3>
            <div class="space-y-2">
              <button onClick=${() => exportCSV('futs')} disabled=${historique.length === 0} class="w-full py-3 bg-purple-600 rounded-lg disabled:opacity-50">ğŸ“‹ CSV FÃ»ts (${historique.length})</button>
              <button onClick=${() => exportCSV('ventes')} disabled=${historiqueVentes.length === 0} class="w-full py-3 bg-emerald-600 rounded-lg disabled:opacity-50">ğŸ’° CSV Ventes (${historiqueVentes.length})</button>
              <button onClick=${exportPDF} class="w-full py-3 bg-red-600 rounded-lg">ğŸ“„ PDF Rapport</button>
            </div>
            <button onClick=${() => setShowModalExport(false)} class="w-full py-3 bg-neutral-700 rounded-lg mt-4">Fermer</button>
          </div>
        </div>
      `}
      
      <!-- Modal ParamÃ¨tres -->
      ${showModalParametres && isAdmin && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
          <div class="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">âš™ï¸ ParamÃ¨tres</h3>
            
            ${isSuperAdmin && html`
              <div class="space-y-4 mb-6">
                <h4 class="font-bold text-sm text-neutral-400">Stocks initiaux</h4>
                <div class="grid grid-cols-2 gap-3">
                  <div><label class="block text-xs text-neutral-400 mb-1">ğŸº BiÃ¨re</label><input type="number" id="cfg_biere" value=${config.stockInitialBiere} class="w-full px-3 py-2 bg-neutral-800 rounded-lg" /></div>
                  <div><label class="block text-xs text-neutral-400 mb-1">ğŸ Cidre</label><input type="number" id="cfg_cidre" value=${config.stockInitialCidre} class="w-full px-3 py-2 bg-neutral-800 rounded-lg" /></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div><label class="block text-xs text-neutral-400 mb-1">Max fÃ»ts/bar</label><input type="number" id="cfg_max" value=${config.maxFutsParBar} class="w-full px-3 py-2 bg-neutral-800 rounded-lg" /></div>
                  <div><label class="block text-xs text-neutral-400 mb-1">Nb jours</label><input type="number" id="cfg_jours" value=${config.nombreJours} class="w-full px-3 py-2 bg-neutral-800 rounded-lg" /></div>
                </div>
              </div>
            `}
            
            <div class="mb-6">
              <h4 class="font-bold text-sm text-neutral-400 mb-2">Jour actuel</h4>
              <div class="flex items-center gap-2">
                <button onClick=${() => changerJour(-1)} disabled=${jourActuel <= 1} class="px-4 py-2 bg-neutral-700 rounded-lg disabled:opacity-50">â†</button>
                <span class="flex-1 text-center text-2xl font-bold">J${jourActuel}</span>
                <button onClick=${() => changerJour(1)} disabled=${jourActuel >= config.nombreJours} class="px-4 py-2 bg-neutral-700 rounded-lg disabled:opacity-50">â†’</button>
              </div>
            </div>
            
            <div class="mb-6">
              <h4 class="font-bold text-sm text-neutral-400 mb-3">Bars Nomades</h4>
              <div class="space-y-2 mb-3 max-h-40 overflow-y-auto">
                ${barsNomades.map(bar => html`
                  <div key=${bar.id} class="flex items-center justify-between bg-neutral-800 p-2 rounded-lg">
                    <span>${bar.type === 'biere' ? 'ğŸº' : 'ğŸ'} ${bar.nom}</span>
                    <button onClick=${() => supprimerBar(bar.id)} class="text-red-400 text-sm px-2">âœ•</button>
                  </div>
                `)}
              </div>
              <div class="flex gap-2">
                <input type="text" id="newBarNom" placeholder="Nom" class="flex-1 px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                <select id="newBarType" class="px-3 py-2 bg-neutral-800 rounded-lg text-sm">
                  <option value="biere">ğŸº</option>
                  <option value="cidre">ğŸ</option>
                </select>
                <button onClick=${() => {
                  const nom = document.getElementById('newBarNom').value.trim();
                  const type = document.getElementById('newBarType').value;
                  if (nom) { ajouterBar(nom, type); document.getElementById('newBarNom').value = ''; }
                }} class="px-4 py-2 bg-red-600 rounded-lg text-sm">+</button>
              </div>
            </div>
            
            <div class="flex gap-2">
              <button onClick=${() => setShowModalParametres(false)} class="flex-1 py-3 bg-neutral-700 rounded-lg">Fermer</button>
              ${isSuperAdmin && html`
                <button onClick=${async () => {
                  await sessionRef.child('config').update({
                    stockInitialBiere: parseInt(document.getElementById('cfg_biere')?.value) || config.stockInitialBiere,
                    stockInitialCidre: parseInt(document.getElementById('cfg_cidre')?.value) || config.stockInitialCidre,
                    maxFutsParBar: parseInt(document.getElementById('cfg_max')?.value) || config.maxFutsParBar,
                    nombreJours: parseInt(document.getElementById('cfg_jours')?.value) || config.nombreJours
                  });
                  setShowModalParametres(false);
                  showNotification('âœ… SauvegardÃ©');
                }} class="flex-1 py-3 bg-red-600 rounded-lg font-medium">ğŸ’¾ Sauver</button>
              `}
            </div>
            
            ${isSuperAdmin && html`
              <button onClick=${() => { setShowModalParametres(false); setShowModalReset(true); }} class="w-full mt-4 py-3 bg-red-900 hover:bg-red-800 rounded-lg border border-red-600">ğŸ”’ RÃ©initialisation RGPD</button>
            `}
          </div>
        </div>
      `}
      
      <!-- Modal Reset RGPD -->
      ${showModalReset && isSuperAdmin && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
          <div class="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4 text-red-400">âš ï¸ RÃ©initialisation RGPD</h3>
            <p class="text-sm text-neutral-400 mb-4">Cette action supprimera dÃ©finitivement tous les historiques, ventes et bÃ©nÃ©voles.</p>
            <div class="flex gap-2">
              <button onClick=${() => setShowModalReset(false)} class="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
              <button onClick=${resetRGPD} class="flex-1 py-3 bg-red-600 rounded-lg font-medium">Confirmer</button>
            </div>
          </div>
        </div>
      `}
      
      <!-- Modal QR -->
      ${showModalQR && html`
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick=${() => setShowModalQR(false)}>
          <div class="bg-neutral-900 rounded-2xl p-6 text-center" onClick=${e => e.stopPropagation()}>
            <h3 class="text-xl font-bold mb-4">ğŸ“· QR Code</h3>
            <div class="bg-white p-4 rounded-xl inline-block mb-4">
              <img src=${'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(session)} alt="QR" />
            </div>
            <p class="text-3xl font-mono font-bold">${session}</p>
          </div>
        </div>
      `}
    </div>
  `;
};

// ==================== APP ROOT ====================
const App = () => {
  const [session, setSession] = useState(null);
  const [userName, setUserName] = useState('');
  const [isCreator, setIsCreator] = useState(false);
  const [role, setRole] = useState('visiteur');

  const handleLogin = (sess, user, creator, r) => {
    setSession(sess);
    setUserName(user);
    setIsCreator(creator);
    setRole(r);
  };

  const handleLogout = () => {
    setSession(null);
    setUserName('');
    setIsCreator(false);
    setRole('visiteur');
  };

  if (!session) return html`<${LoginScreen} onLogin=${handleLogin} />`;
  return html`<${MainApp} session=${session} userName=${userName} isCreator=${isCreator} initialRole=${role} onLogout=${handleLogout} />`;
};

// Render
render(html`<${App} />`, document.getElementById('root'));
  </script>
</body>
</html>
