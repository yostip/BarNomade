<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bar Nomade">
  <meta name="theme-color" content="#39ff14">
  <meta name="description" content="Gestion des f√ªts pour les bars nomades du Hellfest 2026">
  <title>Gestion F√ªts - Hellfest 2026</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  
  <!-- Preconnect pour acc√©l√©rer les connexions CDN -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; background: #000; }
    @media (display-mode: standalone) {
      body { padding-top: env(safe-area-inset-top); }
    }
    /* √âcran de chargement - simplifi√© */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #39ff14;
    }
    #loading-screen.hidden { display: none; }
    .loader-logo {
      width: 80px;
      height: 80px;
    }
  </style>
  
  <!-- Scripts critiques (chargement imm√©diat) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase (critique) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <!-- Scripts diff√©r√©s (chargement apr√®s le rendu initial) -->
  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body class="bg-black">
  <!-- √âcran de chargement affich√© imm√©diatement -->
  <div id="loading-screen">
    <img src="logo-hellfest.png" alt="Hellfest" class="loader-logo">
    <p style="margin-top: 20px; font-size: 18px;">Chargement...</p>
    <p style="margin-top: 8px; font-size: 12px; color: #39ff14; font-weight: bold;">HELLFEST 2026</p>
  </div>
  
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // Masquer l'√©cran de chargement d√®s que React est pr√™t
    const hideLoadingScreen = () => {
      const loader = document.getElementById('loading-screen');
      if (loader) loader.classList.add('hidden');
    };

    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCgl30syyCEJif9q96E2jzv-aTXxXgvgv0",
      authDomain: "gestion-futs-hellfest.firebaseapp.com",
      databaseURL: "https://gestion-futs-hellfest-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gestion-futs-hellfest",
      storageBucket: "gestion-futs-hellfest.firebasestorage.app",
      messagingSenderId: "107509834680",
      appId: "1:107509834680:web:3a58295d3268b5d19f654d"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ==================== V√âRIFICATION MOT DE PASSE (GLOBAL) ====================
    const verifyPassword = (input, type) => {
      if (type === 'super_admin') {
        return input === 'HF2026Admin';
      } else {
        return input === 'Hellfest26';
      }
    };

    // ==================== ICONS ====================
    const Icon = ({ name, className }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          ref.current.appendChild(icon);
        }
      }, [name]);
      return <span ref={ref} className={className} style={{ display: 'inline-flex', alignItems: 'center' }} />;
    };

    // ==================== SESSION SCREEN ====================
    const SessionScreen = ({ onJoinSession }) => {
      const [mode, setMode] = useState('choice');
      const [sessionCode, setSessionCode] = useState('');
      const [userName, setUserName] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      
      // Session r√©cente m√©moris√©e
      const [recentSession, setRecentSession] = useState(null);
      const [checkingRecent, setCheckingRecent] = useState(true);
      
      // Super Admin
      const [showSuperAdmin, setShowSuperAdmin] = useState(false);
      const [superAdminPassword, setSuperAdminPassword] = useState('');
      const [superAdminAuth, setSuperAdminAuth] = useState(false);
      const [allSessions, setAllSessions] = useState([]);
      const [loadingSessions, setLoadingSessions] = useState(false);
      const [createPassword, setCreatePassword] = useState('');

      // Lire le param√®tre URL ?session=XXX au chargement
      React.useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionFromUrl = urlParams.get('session');
        if (sessionFromUrl) {
          setSessionCode(sessionFromUrl.toUpperCase());
          setMode('join');
          // Nettoyer l'URL sans recharger la page
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }, []);

      // V√©rifier s'il y a une session r√©cente au chargement
      React.useEffect(() => {
        const savedSession = localStorage.getItem('gestionFuts_session');
        const savedUserName = localStorage.getItem('gestionFuts_userName');
        const savedIsAdmin = localStorage.getItem('gestionFuts_isAdmin');
        const savedIsCreator = localStorage.getItem('gestionFuts_isCreator');
        
        if (savedSession && savedUserName) {
          // V√©rifier que la session existe encore
          database.ref(`sessions/${savedSession}`).once('value', (snap) => {
            if (snap.exists()) {
              setRecentSession({
                code: savedSession,
                userName: savedUserName,
                isAdmin: savedIsAdmin === 'true',
                isCreator: savedIsCreator === 'true'
              });
            } else {
              // Session supprim√©e, nettoyer
              localStorage.removeItem('gestionFuts_session');
              localStorage.removeItem('gestionFuts_userName');
              localStorage.removeItem('gestionFuts_isAdmin');
              localStorage.removeItem('gestionFuts_isCreator');
            }
            setCheckingRecent(false);
          });
        } else {
          setCheckingRecent(false);
        }
      }, []);

      // Reprendre la session r√©cente
      const reprendreSession = async () => {
        if (!recentSession) return;
        setLoading(true);
        
        // Mettre √† jour lastActive dans Firebase
        await database.ref(`sessions/${recentSession.code}/users/${recentSession.userName}`).update({
          lastActive: Date.now()
        });
        
        onJoinSession(recentSession.code, recentSession.userName, recentSession.isCreator);
      };

      // Oublier la session r√©cente
      const oublierSession = () => {
        localStorage.removeItem('gestionFuts_session');
        localStorage.removeItem('gestionFuts_userName');
        localStorage.removeItem('gestionFuts_isAdmin');
        localStorage.removeItem('gestionFuts_isCreator');
        setRecentSession(null);
      };

      const loadAllSessions = async () => {
        setLoadingSessions(true);
        const snapshot = await database.ref('sessions').once('value');
        const data = snapshot.val() || {};
        const sessionsList = Object.entries(data).map(([code, sessionData]) => ({
          code,
          createdAt: sessionData.config?.createdAt || 0,
          nombreBars: sessionData.bars ? Object.keys(sessionData.bars).length : 0,
          nombreUsers: sessionData.users ? Object.keys(sessionData.users).length : 0,
          historiqueCount: sessionData.historique ? Object.keys(sessionData.historique).length : 0,
          ventesCount: sessionData.historiqueVentes ? Object.keys(sessionData.historiqueVentes).length : 0
        }));
        sessionsList.sort((a, b) => b.createdAt - a.createdAt);
        setAllSessions(sessionsList);
        setLoadingSessions(false);
      };

      const supprimerSession = async (code) => {
        if (confirm(`Supprimer d√©finitivement la session ${code} ?\n\nToutes les donn√©es seront perdues (RGPD).`)) {
          await database.ref(`sessions/${code}`).remove();
          setAllSessions(prev => prev.filter(s => s.code !== code));
        }
      };

      const supprimerToutesSessions = async () => {
        if (confirm(`‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nSupprimer TOUTES les ${allSessions.length} sessions ?\n\nCette action est IRR√âVERSIBLE !`)) {
          if (confirm(`Derni√®re confirmation :\nVoulez-vous vraiment supprimer toutes les donn√©es ?`)) {
            await database.ref('sessions').remove();
            setAllSessions([]);
          }
        }
      };

      const authentifierSuperAdmin = () => {
        const isValid = verifyPassword(superAdminPassword, 'super_admin');
        if (isValid) {
          setSuperAdminAuth(true);
          loadAllSessions();
        } else {
          alert('Mot de passe incorrect');
        }
      };

      const generateSessionCode = () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = 'HF26-';
        for (let i = 0; i < 4; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      };

      const createSession = async () => {
        if (!userName.trim()) {
          setError('Entre ton pr√©nom');
          return;
        }
        const isValidPassword = verifyPassword(createPassword, 'super_admin');
        if (!isValidPassword) {
          setError('Mot de passe incorrect. Seul un administrateur peut cr√©er une session.');
          return;
        }

        setLoading(true);
        setError('');
        
        const newCode = generateSessionCode();
        const sessionRef = database.ref(`sessions/${newCode}`);
        
        const initialData = {
          config: {
            stockInitialBiere: 50,
            stockInitialCidre: 20,
            maxFutsParBar: 3,
            nombreJours: 4,
            createdAt: Date.now(),
            createdBy: userName.trim()
          },
          creneaux: [
            { id: 'c1', label: '11h30-13h' },
            { id: 'c2', label: '13h-15h' },
            { id: 'c3', label: '15h-18h' },
            { id: 'c4', label: '18h-22h30' },
            { id: 'c5', label: '22h30-00h30' }
          ],
          jourActuel: 1,
          users: {
            [userName.trim()]: { joinedAt: Date.now(), lastActive: Date.now() }
          }
        };

        await sessionRef.set(initialData);
        
        onJoinSession(newCode, userName.trim(), true); // true = cr√©ateur = Super Admin
      };

      const joinSession = async () => {
        if (!userName.trim()) {
          setError('Entre ton pr√©nom');
          return;
        }
        if (!sessionCode.trim()) {
          setError('Entre le code de session');
          return;
        }
        setLoading(true);
        setError('');

        const code = sessionCode.trim().toUpperCase();
        const sessionRef = database.ref(`sessions/${code}`);
        const snapshot = await sessionRef.once('value');
        
        if (!snapshot.exists()) {
          setError('Session introuvable');
          setLoading(false);
          return;
        }

        await sessionRef.child(`users/${userName.trim()}`).set({
          joinedAt: Date.now(),
          lastActive: Date.now()
        });

        onJoinSession(code, userName.trim());
      };

      if (mode === 'choice') {
        return (
          <div className="min-h-screen bg-black flex items-center justify-center p-4">
            <div className="w-full max-w-sm">
              <div className="text-center mb-8">
                <img src="logo-hellfest.png" alt="Hellfest" className="w-24 h-24 mx-auto mb-4" />
                <h1 className="text-2xl font-bold text-white mb-2">Gestion F√ªts</h1>
                <p className="text-green-400 font-bold">HELLFEST 2026</p>
              </div>

              {/* Session r√©cente */}
              {checkingRecent ? (
                <div className="mb-6 p-4 bg-neutral-800 rounded-xl text-center">
                  <p className="text-neutral-400">Chargement...</p>
                </div>
              ) : recentSession && (
                <div className="mb-6 p-4 bg-green-900/30 border border-green-700 rounded-xl">
                  <div className="flex items-center justify-between mb-3">
                    <span className="text-green-400 font-bold">üìÇ Session r√©cente</span>
                    <button 
                      onClick={oublierSession}
                      className="text-xs text-neutral-500 hover:text-red-400"
                      title="Oublier cette session"
                    >‚úï</button>
                  </div>
                  <div className="mb-3">
                    <p className="text-white font-mono text-lg">{recentSession.code}</p>
                    <p className="text-sm text-neutral-400">
                      Connect√© en tant que <span className="text-green-300">{recentSession.userName}</span>
                      {recentSession.isCreator && <span className="ml-2 text-xs bg-red-800 px-2 py-0.5 rounded">Cr√©ateur</span>}
                      {recentSession.isAdmin && !recentSession.isCreator && <span className="ml-2 text-xs bg-green-800 px-2 py-0.5 rounded">Admin</span>}
                    </p>
                  </div>
                  <button
                    onClick={reprendreSession}
                    disabled={loading}
                    className="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold transition-colors disabled:opacity-50"
                  >
                    {loading ? '‚è≥ Connexion...' : 'üîÑ Reprendre cette session'}
                  </button>
                </div>
              )}
              
              <div className="space-y-4">
                <button
                  onClick={() => setMode('create')}
                  className="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-lg hover:bg-red-700 transition-colors"
                >
                  üÜï Cr√©er une session
                </button>
                <button
                  onClick={() => setMode('join')}
                  className="w-full py-4 bg-neutral-800 text-white rounded-xl font-bold text-lg hover:bg-neutral-700 transition-colors border border-neutral-700"
                >
                  üîó Rejoindre une session
                </button>
              </div>
              
              {/* Bouton Super Admin discret */}
              <button
                onClick={() => setShowSuperAdmin(true)}
                className="mt-8 text-neutral-600 text-xs hover:text-neutral-400 transition-colors"
              >
                üîê Administration
              </button>
            </div>

            {/* Modal Super Admin */}
            {showSuperAdmin && (
              <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
                <div className="bg-neutral-900 rounded-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto border border-neutral-700">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-red-400">üîê Super Admin</h3>
                    <button 
                      onClick={() => { setShowSuperAdmin(false); setSuperAdminAuth(false); setSuperAdminPassword(''); }}
                      className="text-neutral-400 hover:text-white"
                    >‚úï</button>
                  </div>

                  {!superAdminAuth ? (
                    <div className="space-y-4">
                      <p className="text-neutral-400 text-sm">Acc√®s r√©serv√© √† l'administrateur principal.</p>
                      <div>
                        <label className="block text-sm text-neutral-400 mb-1">Mot de passe Super Admin</label>
                        <input 
                          type="password"
                          value={superAdminPassword}
                          onChange={(e) => setSuperAdminPassword(e.target.value)}
                          className="w-full px-4 py-3 bg-neutral-800 rounded-lg"
                          placeholder="Mot de passe..."
                          onKeyPress={(e) => e.key === 'Enter' && authentifierSuperAdmin()}
                        />
                      </div>
                      <button 
                        onClick={authentifierSuperAdmin}
                        className="w-full py-3 bg-red-600 rounded-lg font-medium"
                      >
                        Acc√©der
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      <div className="flex items-center justify-between">
                        <p className="text-green-400 text-sm">‚úì Authentifi√©</p>
                        <button 
                          onClick={loadAllSessions}
                          className="text-xs text-neutral-400 hover:text-white"
                        >
                          üîÑ Actualiser
                        </button>
                      </div>

                      <div className="bg-yellow-900/30 border border-yellow-700 rounded-lg p-3">
                        <p className="text-yellow-400 text-sm">‚ö†Ô∏è RGPD : La suppression est d√©finitive et irr√©versible.</p>
                      </div>

                      {loadingSessions ? (
                        <p className="text-center text-neutral-400 py-4">Chargement...</p>
                      ) : allSessions.length === 0 ? (
                        <p className="text-center text-neutral-500 py-4">Aucune session trouv√©e</p>
                      ) : (
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                          {allSessions.map(s => (
                            <div key={s.code} className="bg-neutral-800 rounded-lg p-3 flex items-center justify-between">
                              <div>
                                <p className="font-mono font-bold text-white">{s.code}</p>
                                <p className="text-xs text-neutral-400">
                                  {s.createdAt ? new Date(s.createdAt).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                  {' ‚Ä¢ '}{s.nombreUsers} user(s) ‚Ä¢ {s.historiqueCount + s.ventesCount} enregistrements
                                </p>
                              </div>
                              <button 
                                onClick={() => supprimerSession(s.code)}
                                className="px-3 py-1 bg-red-600 hover:bg-red-500 rounded text-sm"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          ))}
                        </div>
                      )}

                      {allSessions.length > 0 && (
                        <button 
                          onClick={supprimerToutesSessions}
                          className="w-full py-3 bg-red-900 hover:bg-red-800 rounded-lg font-medium border border-red-600 mt-4"
                        >
                          üóëÔ∏è Supprimer TOUTES les sessions ({allSessions.length})
                        </button>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-black flex items-center justify-center p-4">
          <div className="w-full max-w-sm">
            <button onClick={() => { setMode('choice'); setError(''); setCreatePassword(''); }} className="text-neutral-400 mb-6 flex items-center gap-2">
              <Icon name="ArrowLeft" className="w-4 h-4" /> Retour
            </button>
            
            <h2 className="text-xl font-bold text-white mb-6">
              {mode === 'create' ? 'üÜï Nouvelle session' : 'üîó Rejoindre'}
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-neutral-400 text-sm mb-2">Ton pr√©nom</label>
                <input
                  type="text"
                  value={userName}
                  onChange={(e) => setUserName(e.target.value)}
                  className="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-xl text-white text-lg"
                  placeholder="Ex: Kevin"
                />
              </div>

              {mode === 'create' && (
                <div>
                  <label className="block text-neutral-400 text-sm mb-2">üîê Mot de passe administrateur</label>
                  <input
                    type="password"
                    value={createPassword}
                    onChange={(e) => setCreatePassword(e.target.value)}
                    className="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-xl text-white text-lg"
                    placeholder="Mot de passe..."
                  />
                  <p className="text-neutral-500 text-xs mt-1">Requis pour cr√©er une nouvelle session</p>
                </div>
              )}

              {mode === 'join' && (
                <div>
                  <label className="block text-neutral-400 text-sm mb-2">Code de session</label>
                  <input
                    type="text"
                    value={sessionCode}
                    onChange={(e) => setSessionCode(e.target.value.toUpperCase())}
                    className="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-xl text-white text-lg text-center tracking-widest"
                    placeholder="HF26-XXXX"
                    maxLength={9}
                  />
                </div>
              )}

              {error && (
                <div className="p-3 bg-red-900/50 border border-red-700 rounded-xl text-red-300 text-sm">
                  {error}
                </div>
              )}

              <button
                onClick={mode === 'create' ? createSession : joinSession}
                disabled={loading}
                className="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-lg hover:bg-red-700 transition-colors disabled:opacity-50"
              >
                {loading ? '‚è≥ Connexion...' : (mode === 'create' ? '‚ú® Cr√©er' : 'üöÄ Rejoindre')}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MAIN APP ====================
    const App = () => {
      const [session, setSession] = useState(null);
      const [userName, setUserName] = useState('');
      const [isOnline, setIsOnline] = useState(true);
      const [connectedUsers, setConnectedUsers] = useState([]);

      // Masquer l'√©cran de chargement au montage
      useEffect(() => {
        hideLoadingScreen();
      }, []);

      // Config & Data
      const [config, setConfig] = useState({
        stockInitialBiere: 50,
        stockInitialCidre: 20,
        maxFutsParBar: 3,
        nombreJours: 4,
        // Tarifs
        prixPinte: 6,
        prixPichet: 15,
        prixGobelet: 2,
        // Volumes
        volumePinte: 0.5,
        volumePichet: 1.5,
        volumeFutBiere: 30,
        volumeFutCidre: 20,
        // Seuil alerte
        seuilPerte: 10
      });
      const [barsNomades, setBarsNomades] = useState([]);
      const [futsEnAttente, setFutsEnAttente] = useState([]);
      const [historique, setHistorique] = useState([]);
      const [historiqueVentes, setHistoriqueVentes] = useState([]);
      const [benevoles, setBenevoles] = useState([]);
      const [jourActuel, setJourActuel] = useState(1);
      
      // Cr√©neaux et Affectations
      const [creneaux, setCreneaux] = useState([
        { id: 'c1', label: '11h30-13h' },
        { id: 'c2', label: '13h-15h' },
        { id: 'c3', label: '15h-18h' },
        { id: 'c4', label: '18h-22h30' },
        { id: 'c5', label: '22h30-00h30' }
      ]);
      const [affectations, setAffectations] = useState({});

      // UI States
      const [isAdmin, setIsAdmin] = useState(false);
      const [isCreator, setIsCreator] = useState(false);
      const [showModalAdmin, setShowModalAdmin] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [pendingAdminAction, setPendingAdminAction] = useState(null);
      const [showParametres, setShowParametres] = useState(false);
      const [showHistorique, setShowHistorique] = useState(false);
      const [showHistoriqueVentes, setShowHistoriqueVentes] = useState(false);
      const [showModalExport, setShowModalExport] = useState(false);
      const [showModalRetour, setShowModalRetour] = useState(null);
      const [retourEtape, setRetourEtape] = useState('choix'); // 'choix' ou 'commentaire'
      const [retourType, setRetourType] = useState('');
      const [retourCommentaire, setRetourCommentaire] = useState('');
      const [showModalVentes, setShowModalVentes] = useState(false);
      const [showModalBenevoles, setShowModalBenevoles] = useState(false);
      const [showModalAffectation, setShowModalAffectation] = useState(false);
      const [showSessionInfo, setShowSessionInfo] = useState(false);
      
      // B√©n√©voles UI
      const [benevoleOnglet, setBenevoleOnglet] = useState('planning');
      const [selectedBarPlanning, setSelectedBarPlanning] = useState(null);
      const [editAffectation, setEditAffectation] = useState(null);
      const [tempCreneaux, setTempCreneaux] = useState([]);
      const [nouveauCreneau, setNouveauCreneau] = useState('');

      // Ventes form
      const [venteBarId, setVenteBarId] = useState('');
      const [venteCreneau, setVenteCreneau] = useState('');
      const [venteMontant, setVenteMontant] = useState('');
      const [venteNbPintes, setVenteNbPintes] = useState('');
      const [venteNbPichets, setVenteNbPichets] = useState('');
      const [venteNbGobelets, setVenteNbGobelets] = useState('');
      const [venteCommentaire, setVenteCommentaire] = useState('');
      const [venteEquipDefaillant, setVenteEquipDefaillant] = useState(false);
      const [venteNumEquipement, setVenteNumEquipement] = useState('');
      const [venteDonneesPartielles, setVenteDonneesPartielles] = useState(false);
      const [creneauxUtilises, setCreneauxUtilises] = useState({});
      const [creneauxEnAttente, setCreneauxEnAttente] = useState({});
      
      // R√©initialisation
      const [showModalReinit, setShowModalReinit] = useState(false);
      const [reinitPassword, setReinitPassword] = useState('');

      // √âdition nom bar
      const [editingBarId, setEditingBarId] = useState(null);
      const [editingBarNom, setEditingBarNom] = useState('');

      // Toast notifications
      const [toast, setToast] = useState(null);
      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      // Loading states (anti-double-clic)
      const [isLoading, setIsLoading] = useState(false);

      // Filtres historique
      const [filtreJourHistorique, setFiltreJourHistorique] = useState('tous');
      const [filtreJourVentes, setFiltreJourVentes] = useState('tous');
      const [rechercheHistorique, setRechercheHistorique] = useState('');
      const [rechercheVentes, setRechercheVentes] = useState('');

      // Dashboard
      const [showDashboard, setShowDashboard] = useState(false);
      const [dashboardOnglet, setDashboardOnglet] = useState('synthese'); // 'synthese', 'ecarts', 'comparatif'

      // QR Code
      const [showQRCode, setShowQRCode] = useState(false);

      // Logs d'audit
      const [auditLogs, setAuditLogs] = useState([]);

      // Mode hors-ligne
      const [offlineQueue, setOfflineQueue] = useState([]);
      const [isSyncing, setIsSyncing] = useState(false);

      // Annonces
      const [annonces, setAnnonces] = useState([]);
      const [showAnnonceInput, setShowAnnonceInput] = useState(false);
      const [nouvelleAnnonce, setNouvelleAnnonce] = useState('');

      // Raccourcis rapides
      const [showQuickFut, setShowQuickFut] = useState(false);
      const [quickFutConfirm, setQuickFutConfirm] = useState(null); // { barId, barNom, barType, currentFuts, maxFuts }

      // Tutoriel
      const [showTutoriel, setShowTutoriel] = useState(false);
      const [tutorielStep, setTutorielStep] = useState(0);

      // Email bilan
      const [adminEmail, setAdminEmail] = useState('');
      const [showEmailConfig, setShowEmailConfig] = useState(false);

      // Vue Plan du festival
      const [showPlanView, setShowPlanView] = useState(false);
      const [planEditMode, setPlanEditMode] = useState(false);
      const [barPositions, setBarPositions] = useState({});
      const [selectedBarForPlan, setSelectedBarForPlan] = useState(null);
      const [selectedPlanPopup, setSelectedPlanPopup] = useState(null);

      // Timer refresh pour les f√ªts
      const [, setTimerRefresh] = useState(0);

      // Fonction pour formater la dur√©e
      const formatDuration = (timestamp) => {
        const now = Date.now();
        const diff = now - timestamp;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        if (hours > 0) {
          return `${hours}h${minutes.toString().padStart(2, '0')}`;
        }
        return `${minutes}min`;
      };

      // Couleur selon dur√©e du f√ªt
      const getFutDurationColor = (timestamp) => {
        const hours = (Date.now() - timestamp) / (1000 * 60 * 60);
        if (hours >= 4) return 'bg-red-600 text-white';
        if (hours >= 3) return 'bg-orange-500 text-white';
        if (hours >= 1.5) return 'bg-yellow-500 text-black';
        return 'bg-neutral-700';
      };

      // Couleurs des bars
      const barColors = [
        'bg-red-600', 'bg-blue-600', 'bg-green-600', 'bg-yellow-600', 
        'bg-purple-600', 'bg-pink-600', 'bg-indigo-600', 'bg-teal-600',
        'bg-orange-600', 'bg-cyan-600'
      ];
      const getBarColor = (barId) => {
        const index = barsNomades.findIndex(b => b.id === barId);
        return barColors[index % barColors.length];
      };

      // ==================== FIREBASE SYNC ====================
      useEffect(() => {
        if (!session) return;

        const sessionRef = database.ref(`sessions/${session}`);
        
        // Sync config
        sessionRef.child('config').on('value', (snap) => {
          if (snap.val()) setConfig(snap.val());
        });

        // Sync admin email
        sessionRef.child('config/adminEmail').on('value', (snap) => {
          if (snap.val()) setAdminEmail(snap.val());
        });

        // Sync bars
        sessionRef.child('barsNomades').on('value', (snap) => {
          if (snap.val()) {
            const bars = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            setBarsNomades(bars);
            if (bars.length > 0 && !selectedBarPlanning) {
              setSelectedBarPlanning(bars[0].id);
            }
          } else {
            setBarsNomades([]);
          }
        });

        // Sync positions des bars sur le plan
        sessionRef.child('barPositions').on('value', (snap) => {
          if (snap.val()) {
            setBarPositions(snap.val());
          } else {
            setBarPositions({});
          }
        });

        // Sync historique
        sessionRef.child('historique').on('value', (snap) => {
          if (snap.val()) {
            const hist = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            hist.sort((a, b) => b.timestamp - a.timestamp);
            setHistorique(hist);
          } else {
            setHistorique([]);
          }
        });

        // Sync ventes
        sessionRef.child('historiqueVentes').on('value', (snap) => {
          if (snap.val()) {
            const ventes = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            ventes.sort((a, b) => b.timestamp - a.timestamp);
            setHistoriqueVentes(ventes);
          } else {
            setHistoriqueVentes([]);
          }
        });

        // Sync cr√©neaux utilis√©s
        sessionRef.child('creneauxUtilises').on('value', (snap) => {
          if (snap.val()) {
            setCreneauxUtilises(snap.val());
          } else {
            setCreneauxUtilises({});
          }
        });

        // Sync cr√©neaux en attente de donn√©es
        sessionRef.child('creneauxEnAttente').on('value', (snap) => {
          if (snap.val()) {
            setCreneauxEnAttente(snap.val());
          } else {
            setCreneauxEnAttente({});
          }
        });

        // Sync benevoles
        sessionRef.child('benevoles').on('value', (snap) => {
          if (snap.val()) {
            const ben = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            setBenevoles(ben);
          } else {
            setBenevoles([]);
          }
        });

        // Sync users
        sessionRef.child('users').on('value', (snap) => {
          if (snap.val()) {
            const users = Object.keys(snap.val());
            setConnectedUsers(users);
          }
        });

        // Sync jour
        sessionRef.child('jourActuel').on('value', (snap) => {
          if (snap.val()) setJourActuel(snap.val());
        });

        // Sync cr√©neaux
        sessionRef.child('creneaux').on('value', (snap) => {
          if (snap.val()) {
            const cren = Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val());
            setCreneaux(cren);
          }
        });

        // Sync affectations - dans le useEffect principal, on ne charge plus ici
        // Les affectations sont maintenant charg√©es dans un useEffect s√©par√© d√©pendant du jour

        // Sync f√ªts en attente (non termin√©s)
        sessionRef.child('futsEnAttente').on('value', (snap) => {
          if (snap.val()) {
            const arr = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            setFutsEnAttente(arr);
          } else {
            setFutsEnAttente([]);
          }
        });

        // Online status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          setIsOnline(snap.val() === true);
        });

        // Update lastActive
        const interval = setInterval(() => {
          sessionRef.child(`users/${userName}/lastActive`).set(Date.now());
        }, 30000);

        // D√©tecter si on a √©t√© √©ject√©
        sessionRef.child(`users/${userName}`).on('value', (snap) => {
          if (!snap.exists() && session) {
            // L'utilisateur a √©t√© supprim√© = √©ject√©
            alert('Vous avez √©t√© d√©connect√© par un administrateur.');
            setSession(null);
            setUserName('');
            setIsAdmin(false);
          }
        });

        return () => {
          sessionRef.off();
          connectedRef.off();
          clearInterval(interval);
        };
      }, [session, userName]);

      // ==================== TIMER REFRESH POUR F√õTS ====================
      useEffect(() => {
        const timerInterval = setInterval(() => {
          setTimerRefresh(prev => prev + 1);
        }, 60000); // Refresh toutes les minutes
        return () => clearInterval(timerInterval);
      }, []);

      // ==================== ENVOI BILAN EMAIL √Ä 00H30 ====================
      useEffect(() => {
        if (!session || !isCreator || !adminEmail) return;
        
        let bilanEnvoye = false;
        
        const checkMidnight = setInterval(() => {
          const now = new Date();
          const heure = now.getHours();
          const minute = now.getMinutes();
          
          // D√©clencher √† 00h30
          if (heure === 0 && minute === 30 && !bilanEnvoye) {
            bilanEnvoye = true;
            envoyerBilanEmail();
            
            // Reset le flag apr√®s 2 minutes pour √©viter les doublons
            setTimeout(() => { bilanEnvoye = false; }, 120000);
          }
        }, 30000); // V√©rifier toutes les 30 secondes
        
        return () => clearInterval(checkMidnight);
      }, [session, isCreator, adminEmail, jourActuel]);

      // Fonction pour envoyer le bilan par email
      const envoyerBilanEmail = () => {
        // G√©n√©rer le PDF
        const doc = exporterBilanPDF();
        
        // T√©l√©charger le PDF automatiquement
        doc.save(`Bilan_J${jourActuel}_${new Date().toISOString().split('T')[0]}.pdf`);
        
        // Pr√©parer le contenu de l'email
        const stats = getStatistiques();
        const comparaison = getComparaisonJour();
        
        let sujet = `[Hellfest 2026] Bilan J${jourActuel} - ${stats.totalVentesJour.toFixed(2)}‚Ç¨`;
        let corps = `Bilan automatique J${jourActuel} - ${new Date().toLocaleDateString('fr-FR')}%0D%0A%0D%0A`;
        corps += `R√âSUM√â:%0D%0A`;
        corps += `- Ventes du jour: ${stats.totalVentesJour.toFixed(2)}‚Ç¨%0D%0A`;
        corps += `- F√ªts en circulation: ${stats.futsEnCirculation}%0D%0A`;
        
        if (comparaison) {
          corps += `%0D%0ACOMPARAISON J${comparaison.jour} vs J${comparaison.jourMoins1}:%0D%0A`;
          corps += `- √âcart ventes: ${comparaison.ecartVentes >= 0 ? '+' : ''}${comparaison.ecartVentes.toFixed(2)}‚Ç¨ (${comparaison.ecartPourcent}%)%0D%0A`;
        }
        
        corps += `%0D%0ALe PDF d√©taill√© a √©t√© t√©l√©charg√© automatiquement.%0D%0A`;
        corps += `Session: ${session}`;
        
        // Ouvrir le client mail
        window.open(`mailto:${adminEmail}?subject=${encodeURIComponent(sujet)}&body=${corps}`, '_blank');
        
        showToast('üìß Bilan g√©n√©r√© - V√©rifiez votre client mail');
      };

      // ==================== SYNC ANNONCES ====================
      useEffect(() => {
        if (!session) return;
        
        const annoncesRef = database.ref(`sessions/${session}/annonces`);
        annoncesRef.orderByChild('timestamp').limitToLast(5).on('value', (snap) => {
          if (snap.val()) {
            const anns = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            anns.sort((a, b) => b.timestamp - a.timestamp);
            setAnnonces(anns);
          } else {
            setAnnonces([]);
          }
        });

        return () => annoncesRef.off();
      }, [session]);

      // ==================== SYNC OFFLINE QUEUE ====================
      useEffect(() => {
        if (isOnline && offlineQueue.length > 0 && !isSyncing) {
          syncOfflineQueue();
        }
      }, [isOnline, offlineQueue]);

      // Fonction de sync hors-ligne
      const syncOfflineQueue = async () => {
        if (offlineQueue.length === 0) return;
        setIsSyncing(true);
        
        for (const action of offlineQueue) {
          try {
            if (action.type === 'SORTIE') {
              await database.ref(`sessions/${session}/barsNomades/${action.barId}/futs`).set(action.futs);
              await database.ref(`sessions/${session}/historique`).push(action.historique);
            } else if (action.type === 'VENTE') {
              await database.ref(`sessions/${session}/historiqueVentes`).push(action.data);
            }
          } catch (error) {
            console.error('Erreur sync:', error);
          }
        }
        
        setOfflineQueue([]);
        setIsSyncing(false);
        showToast(`‚úÖ ${offlineQueue.length} action(s) synchronis√©e(s)`);
      };

      // Ajouter √† la queue offline
      const addToOfflineQueue = (action) => {
        setOfflineQueue(prev => [...prev, action]);
        showToast(`‚è≥ Action en attente (hors-ligne)`, 'warning');
      };

      // ==================== BACKUP AUTOMATIQUE ====================
      useEffect(() => {
        if (!session) return;
        
        const backupInterval = setInterval(() => {
          const backupData = {
            session,
            timestamp: Date.now(),
            config,
            barsNomades,
            historique,
            historiqueVentes,
            affectations,
            jourActuel
          };
          
          const backups = JSON.parse(localStorage.getItem('gestionFuts_backups') || '[]');
          backups.unshift(backupData);
          // Garder seulement les 24 derniers backups
          const trimmedBackups = backups.slice(0, 24);
          localStorage.setItem('gestionFuts_backups', JSON.stringify(trimmedBackups));
          
          console.log('Backup automatique effectu√©:', new Date().toLocaleString());
        }, 3600000); // Toutes les heures

        // Backup imm√©diat au chargement
        setTimeout(() => {
          const backupData = {
            session,
            timestamp: Date.now(),
            config,
            barsNomades,
            historique,
            historiqueVentes,
            affectations,
            jourActuel
          };
          const backups = JSON.parse(localStorage.getItem('gestionFuts_backups') || '[]');
          backups.unshift(backupData);
          localStorage.setItem('gestionFuts_backups', JSON.stringify(backups.slice(0, 24)));
        }, 5000);

        return () => clearInterval(backupInterval);
      }, [session, config, barsNomades, historique, historiqueVentes, affectations, jourActuel]);

      // ==================== SYNC AFFECTATIONS PAR JOUR ====================
      useEffect(() => {
        if (!session || !jourActuel) return;
        
        const affectationsRef = database.ref(`sessions/${session}/affectations/jour${jourActuel}`);
        
        affectationsRef.on('value', (snap) => {
          if (snap.val()) {
            setAffectations(snap.val());
          } else {
            setAffectations({});
          }
        });

        return () => {
          affectationsRef.off();
        };
      }, [session, jourActuel]);

      // ==================== SYNC AUDIT LOGS ====================
      useEffect(() => {
        if (!session) return;
        
        const auditRef = database.ref(`sessions/${session}/auditLogs`);
        
        auditRef.orderByChild('timestamp').limitToLast(100).on('value', (snap) => {
          if (snap.val()) {
            const logs = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            logs.sort((a, b) => b.timestamp - a.timestamp);
            setAuditLogs(logs);
          } else {
            setAuditLogs([]);
          }
        });

        return () => {
          auditRef.off();
        };
      }, [session]);

      // Fonction pour √©jecter un utilisateur (admin only)
      const ejecterUtilisateur = async (user) => {
        if (!isAdmin || user === userName) return;
        if (confirm(`√ätes-vous s√ªr de vouloir √©jecter ${user} ?`)) {
          await database.ref(`sessions/${session}/users/${user}`).remove();
        }
      };

      // ==================== COMPUTED VALUES ====================
      const stockBiere = config.stockInitialBiere 
        - historique.filter(h => !h.annule && h.type === 'SORTIE' && h.typeFut === 'biere').length
        + historique.filter(h => !h.annule && h.type === 'RETOUR_PLEIN' && h.typeFut === 'biere').length;
      const stockCidre = config.stockInitialCidre 
        - historique.filter(h => !h.annule && h.type === 'SORTIE' && h.typeFut === 'cidre').length
        + historique.filter(h => !h.annule && h.type === 'RETOUR_PLEIN' && h.typeFut === 'cidre').length;
      const stockVides = historique.filter(h => !h.annule && h.type === 'RETOUR_VIDE').length;
      const stockCasse = historique.filter(h => !h.annule && h.type === 'RETOUR_CASSE').length;
      const stockReutilisables = historique.filter(h => !h.annule && h.type === 'RETOUR_REUTILISABLE').length;
      const stockPleins = historique.filter(h => !h.annule && h.type === 'RETOUR_PLEIN').length;

      const totalVentes = historiqueVentes
        .filter(v => !v.annule)
        .reduce((acc, v) => acc + (v.montant || 0), 0);

      const compterAffectations = () => {
        let total = 0;
        Object.values(affectations).forEach(bar => {
          Object.values(bar || {}).forEach(creneau => {
            if (creneau && (creneau.vendeur?.nom || creneau.serveur?.nom || creneau.runner?.nom)) {
              total++;
            }
          });
        });
        return total;
      };

      const nbAffectations = compterAffectations();

      // ==================== ACTIONS ====================
      const handleJoinSession = (code, name, isSessionCreator = false) => {
        setSession(code);
        setUserName(name);
        // Si c'est le cr√©ateur de la session (Super Admin), il est automatiquement admin ET cr√©ateur
        if (isSessionCreator) {
          setIsAdmin(true);
          setIsCreator(true);
        }
        // Sauvegarder dans localStorage pour proposer la reprise
        localStorage.setItem('gestionFuts_session', code);
        localStorage.setItem('gestionFuts_userName', name);
        if (isSessionCreator) {
          localStorage.setItem('gestionFuts_isAdmin', 'true');
          localStorage.setItem('gestionFuts_isCreator', 'true');
        }
        
        // Afficher le tutoriel si c'est la premi√®re fois
        const tutorielVu = localStorage.getItem('gestionFuts_tutorielVu');
        if (!tutorielVu) {
          setTimeout(() => {
            setShowTutoriel(true);
            setTutorielStep(0);
          }, 500);
        }
      };

      // Fonction de d√©connexion (retour √† l'accueil)
      const deconnexion = () => {
        if (confirm('Voulez-vous vous d√©connecter de cette session ?')) {
          setSession(null);
          setUserName('');
          setIsAdmin(false);
          setIsCreator(false);
          // On garde le localStorage pour proposer la reprise
        }
      };

      // Effacer la session m√©moris√©e
      const effacerSessionMemorisee = () => {
        localStorage.removeItem('gestionFuts_session');
        localStorage.removeItem('gestionFuts_userName');
        localStorage.removeItem('gestionFuts_isAdmin');
        localStorage.removeItem('gestionFuts_isCreator');
      };

      const demanderAccesAdmin = (action) => {
        if (isAdmin) {
          executerActionAdmin(action);
        } else {
          setPendingAdminAction(action);
          setAdminPassword('');
          setShowModalAdmin(true);
        }
      };

      const validerAdmin = () => {
        const isValid = verifyPassword(adminPassword, 'admin');
        if (isValid) {
          setIsAdmin(true);
          setShowModalAdmin(false);
          if (pendingAdminAction) {
            executerActionAdmin(pendingAdminAction);
            setPendingAdminAction(null);
          }
        } else {
          alert('Mot de passe incorrect');
        }
      };

      const executerActionAdmin = (action) => {
        switch (action) {
          case 'parametres': setShowParametres(true); break;
          case 'export': setShowModalExport(true); break;
          case 'historique': setShowHistorique(!showHistorique); break;
          case 'ventes': setShowHistoriqueVentes(!showHistoriqueVentes); break;
          case 'jour_prev': 
            if (jourActuel > 1) {
              database.ref(`sessions/${session}/jourActuel`).set(jourActuel - 1);
            }
            break;
          case 'jour_next':
            if (jourActuel < config.nombreJours) {
              database.ref(`sessions/${session}/jourActuel`).set(jourActuel + 1);
            }
            break;
        }
      };

      const ajouterBar = async (nom, type) => {
        const newRef = database.ref(`sessions/${session}/barsNomades`).push();
        await newRef.set({ nom, type, futs: [] });
      };

      const supprimerBar = async (barId) => {
        const bar = barsNomades.find(b => b.id === barId);
        if (bar?.futs?.length > 0) {
          alert('Impossible de supprimer un bar avec des f√ªts en cours');
          return;
        }
        await database.ref(`sessions/${session}/barsNomades/${barId}`).remove();
        // Supprimer aussi les affectations de ce bar pour tous les jours
        for (let j = 1; j <= config.nombreJours; j++) {
          await database.ref(`sessions/${session}/affectations/jour${j}/${barId}`).remove();
        }
      };

      const renommerBar = async (barId, nouveauNom) => {
        if (!nouveauNom.trim()) return;
        await database.ref(`sessions/${session}/barsNomades/${barId}/nom`).set(nouveauNom.trim());
        showToast(`‚úÖ Bar renomm√© en "${nouveauNom.trim()}"`);
      };

      // Fonction pour ajouter un log d'audit
      const addAuditLog = async (action, details) => {
        const log = {
          action,
          details,
          user: userName,
          timestamp: Date.now(),
          jour: jourActuel
        };
        await database.ref(`sessions/${session}/auditLogs`).push(log);
      };

      const attribuerFut = async (barId) => {
        if (isLoading) return;
        
        const bar = barsNomades.find(b => b.id === barId);
        if (!bar) return;

        const currentFuts = bar.futs || [];
        if (currentFuts.length >= config.maxFutsParBar) return;

        const typeFut = bar.type;
        if (typeFut === 'biere' && stockBiere <= 0) return;
        if (typeFut === 'cidre' && stockCidre <= 0) return;

        setIsLoading(true);
        try {
          const newFut = {
            id: Date.now().toString(),
            type: typeFut,
            dateAttribution: Date.now()
          };

          const updatedFuts = [...currentFuts, newFut];
          await database.ref(`sessions/${session}/barsNomades/${barId}/futs`).set(updatedFuts);

          await database.ref(`sessions/${session}/historique`).push({
            type: 'SORTIE',
            typeFut,
            barId,
            barNom: bar.nom,
            jour: jourActuel,
            timestamp: Date.now(),
            user: userName
          });

          await addAuditLog('SORTIE_FUT', `${typeFut === 'biere' ? 'üç∫ Bi√®re' : 'üçé Cidre'} ‚Üí ${bar.nom}`);
          showToast(`‚úÖ F√ªt ${typeFut === 'biere' ? 'üç∫' : 'üçé'} attribu√© √† ${bar.nom}`);
        } catch (error) {
          showToast('‚ùå Erreur lors de l\'attribution', 'error');
        } finally {
          setTimeout(() => setIsLoading(false), 1000);
        }
      };

      const retournerFut = async (barId, futIndex, typeRetour, commentaire = '') => {
        if (isLoading) return;
        
        const bar = barsNomades.find(b => b.id === barId);
        if (!bar) return;

        const currentFuts = bar.futs || [];
        const fut = currentFuts[futIndex];
        if (!fut) return;

        setIsLoading(true);
        try {
          const updatedFuts = currentFuts.filter((_, i) => i !== futIndex);
          await database.ref(`sessions/${session}/barsNomades/${barId}/futs`).set(updatedFuts.length > 0 ? updatedFuts : null);

          // Enregistrer dans l'historique
          const historiqueData = {
            type: typeRetour,
            typeFut: fut.type,
            barId,
            barNom: bar.nom,
            jour: jourActuel,
            timestamp: Date.now(),
            user: userName
          };

          // Ajouter le commentaire si pr√©sent (obligatoire pour cass√©)
          if (commentaire.trim()) {
            historiqueData.commentaire = commentaire.trim();
          }

          await database.ref(`sessions/${session}/historique`).push(historiqueData);

          // Si f√ªt non termin√©, le mettre en attente pour le jour suivant
          if (typeRetour === 'RETOUR_REUTILISABLE') {
            await database.ref(`sessions/${session}/futsEnAttente`).push({
              typeFut: fut.type,
              barId,
              barNom: bar.nom,
              jourOrigine: jourActuel,
              timestamp: Date.now(),
              user: userName
            });
          }

          const typeLabels = {
            'RETOUR_VIDE': 'üì¶ Vide',
            'RETOUR_CASSE': 'üí• Cass√©',
            'RETOUR_REUTILISABLE': '‚ôªÔ∏è Non termin√©',
            'RETOUR_PLEIN': 'üîÑ Plein (r√©int√©gr√© au stock)'
          };
          await addAuditLog('RETOUR_FUT', `${typeLabels[typeRetour]} de ${bar.nom}`);
          showToast(`‚úÖ F√ªt retourn√© (${typeLabels[typeRetour]})`);
        } catch (error) {
          showToast('‚ùå Erreur lors du retour', 'error');
        } finally {
          setTimeout(() => setIsLoading(false), 1000);
        }

        // Reset modal
        setShowModalRetour(null);
        setRetourEtape('choix');
        setRetourType('');
        setRetourCommentaire('');
      };

      // Fonction pour reprendre un f√ªt en attente
      const reprendreFutEnAttente = async (futAttenteId, barId) => {
        const bar = barsNomades.find(b => b.id === barId);
        if (!bar) return;

        // R√©cup√©rer le f√ªt en attente
        const snapshot = await database.ref(`sessions/${session}/futsEnAttente/${futAttenteId}`).once('value');
        const futAttente = snapshot.val();
        if (!futAttente) return;

        // Ajouter le f√ªt au bar
        const currentFuts = bar.futs || [];
        const newFut = { type: futAttente.typeFut, addedAt: Date.now(), reprisDe: futAttente.jourOrigine };
        const updatedFuts = [...currentFuts, newFut];
        await database.ref(`sessions/${session}/barsNomades/${barId}/futs`).set(updatedFuts);

        // Enregistrer dans l'historique
        await database.ref(`sessions/${session}/historique`).push({
          type: 'REPRISE',
          typeFut: futAttente.typeFut,
          barId,
          barNom: bar.nom,
          jour: jourActuel,
          timestamp: Date.now(),
          user: userName,
          commentaire: `Reprise du J${futAttente.jourOrigine}`
        });

        // Supprimer de la liste d'attente
        await database.ref(`sessions/${session}/futsEnAttente/${futAttenteId}`).remove();
      };

      const enregistrerVente = async () => {
        if (!venteBarId || isLoading) return;
        
        // Validation : cr√©neau obligatoire
        if (!venteCreneau) {
          showToast('‚ùå S√©lectionnez un cr√©neau horaire', 'error');
          return;
        }
        
        // Validation : pintes, pichets et gobelets obligatoires
        if (venteNbPintes === '' || venteNbPichets === '' || venteNbGobelets === '') {
          showToast('‚ùå Renseignez le nombre de pintes, pichets et gobelets', 'error');
          return;
        }
        
        // Validation : montant obligatoire
        const montant = parseFloat(venteMontant) || 0;
        if (montant <= 0) {
          showToast('‚ùå Le montant doit √™tre sup√©rieur √† 0', 'error');
          return;
        }

        const bar = barsNomades.find(b => b.id === venteBarId);

        setIsLoading(true);
        try {
          await database.ref(`sessions/${session}/historiqueVentes`).push({
            barId: venteBarId,
            barNom: bar?.nom || 'Bar inconnu',
            creneau: venteCreneau,
            montant,
            nbPintes: parseInt(venteNbPintes) || 0,
            nbPichets: parseInt(venteNbPichets) || 0,
            nbGobelets: parseInt(venteNbGobelets) || 0,
            equipementDefaillant: venteEquipDefaillant,
            numEquipement: venteEquipDefaillant ? venteNumEquipement.trim() : '',
            donneesPartielles: venteEquipDefaillant ? venteDonneesPartielles : false,
            commentaire: venteCommentaire,
            jour: jourActuel,
            timestamp: Date.now(),
            user: userName
          });

          // Si pas de probl√®me √©quipement, marquer le cr√©neau comme utilis√© pour ce bar
          if (!venteEquipDefaillant) {
            const creneauKey = `J${jourActuel}_${venteBarId}_${venteCreneau}`;
            await database.ref(`sessions/${session}/creneauxUtilises/${creneauKey}`).set({
              barId: venteBarId,
              creneau: venteCreneau,
              jour: jourActuel,
              timestamp: Date.now(),
              user: userName
            });
            // Si ce cr√©neau √©tait en attente, le retirer de la liste
            if (creneauxEnAttente[creneauKey]) {
              await database.ref(`sessions/${session}/creneauxEnAttente/${creneauKey}`).remove();
            }
          }

          await addAuditLog('VENTE', `${montant.toFixed(2)}‚Ç¨ - ${bar?.nom || 'Bar inconnu'} (${venteCreneau})`);
          showToast(`‚úÖ Vente enregistr√©e (${montant.toFixed(2)}‚Ç¨)`);
          
          setShowModalVentes(false);
          setVenteBarId('');
          setVenteCreneau('');
          setVenteMontant('');
          setVenteNbPintes('');
          setVenteNbPichets('');
          setVenteNbGobelets('');
          setVenteEquipDefaillant(false);
          setVenteNumEquipement('');
          setVenteDonneesPartielles(false);
          setVenteCommentaire('');
        } catch (error) {
          showToast('‚ùå Erreur lors de l\'enregistrement', 'error');
        } finally {
          setTimeout(() => setIsLoading(false), 1000);
        }
      };

      // Marquer un cr√©neau comme "en attente de donn√©es"
      const marquerCreneauEnAttente = async (barId, creneau) => {
        if (!barId || !creneau) return;
        
        const bar = barsNomades.find(b => b.id === barId);
        const creneauKey = `J${jourActuel}_${barId}_${creneau}`;
        
        await database.ref(`sessions/${session}/creneauxEnAttente/${creneauKey}`).set({
          barId,
          barNom: bar?.nom || 'Bar inconnu',
          creneau,
          jour: jourActuel,
          timestamp: Date.now(),
          user: userName
        });
        
        await addAuditLog('CRENEAU_ATTENTE', `${bar?.nom || 'Bar'} - ${creneau} marqu√© en attente`);
        showToast(`‚è≥ Cr√©neau ${creneau} marqu√© "en attente de donn√©es"`);
        
        setShowModalVentes(false);
        setVenteBarId('');
        setVenteCreneau('');
      };

      // Compl√©ter un cr√©neau en attente (le retirer de la liste en attente apr√®s enregistrement)
      const completerCreneauEnAttente = async (barId, creneau) => {
        const creneauKey = `J${jourActuel}_${barId}_${creneau}`;
        await database.ref(`sessions/${session}/creneauxEnAttente/${creneauKey}`).remove();
      };

      // Annuler un cr√©neau en attente
      const annulerCreneauEnAttente = async (creneauKey) => {
        await database.ref(`sessions/${session}/creneauxEnAttente/${creneauKey}`).remove();
        showToast('‚úÖ Cr√©neau retir√© de la liste d\'attente');
      };

      const sauvegarderConfig = async (newConfig) => {
        await database.ref(`sessions/${session}/config`).update(newConfig);
        setShowParametres(false);
      };

      // ==================== GESTION VUE PLAN ====================
      const sauvegarderPositionBar = async (barId, x, y) => {
        await database.ref(`sessions/${session}/barPositions/${barId}`).set({ x, y });
      };

      const handlePlanClick = (e) => {
        if (!planEditMode || !selectedBarForPlan) return;
        
        const rect = e.currentTarget.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        
        sauvegarderPositionBar(selectedBarForPlan, x, y);
        
        // Passer au bar suivant non positionn√©
        const barsNonPositionnes = barsNomades.filter(b => !barPositions[b.id]);
        const currentIndex = barsNonPositionnes.findIndex(b => b.id === selectedBarForPlan);
        if (currentIndex < barsNonPositionnes.length - 1) {
          setSelectedBarForPlan(barsNonPositionnes[currentIndex + 1].id);
        } else {
          setSelectedBarForPlan(null);
          setPlanEditMode(false);
          showToast('‚úÖ Tous les bars sont positionn√©s !');
        }
      };

      const supprimerPositionBar = async (barId) => {
        await database.ref(`sessions/${session}/barPositions/${barId}`).remove();
      };

      const resetAllPositions = async () => {
        if (confirm('R√©initialiser toutes les positions des bars sur le plan ?')) {
          await database.ref(`sessions/${session}/barPositions`).remove();
          showToast('Positions r√©initialis√©es');
        }
      };

      // ==================== R√âINITIALISATION ====================
      const reinitialiserDonnees = async (avecExport) => {
        const isValid = verifyPassword(reinitPassword, 'admin');
        if (!isValid) {
          alert('Mot de passe incorrect');
          return;
        }

        // Export si demand√©
        if (avecExport) {
          exporterHistoriqueFuts();
          exporterHistoriqueVentes();
          exporterBenevoles();
        }

        // Supprimer les donn√©es (garder config et liste des bars)
        await database.ref(`sessions/${session}/historique`).remove();
        await database.ref(`sessions/${session}/historiqueVentes`).remove();
        await database.ref(`sessions/${session}/affectations`).remove();
        await database.ref(`sessions/${session}/futsEnAttente`).remove();
        await database.ref(`sessions/${session}/creneauxUtilises`).remove();
        await database.ref(`sessions/${session}/creneauxEnAttente`).remove();

        // R√©initialiser les bars avec 0 f√ªts
        for (const bar of barsNomades) {
          await database.ref(`sessions/${session}/barsNomades/${bar.id}/futs`).set(null);
        }

        setShowModalReinit(false);
        setReinitPassword('');
        alert('R√©initialisation effectu√©e !');
      };

      // ==================== FONCTIONS ANNULATION ====================
      const annulerVente = async (venteId) => {
        // R√©cup√©rer la vente pour avoir les infos du cr√©neau
        const vente = historiqueVentes.find(v => v.id === venteId);
        if (!vente) return;
        
        if (!confirm('Annuler cette vente ?\n\nLe cr√©neau sera de nouveau disponible pour une nouvelle saisie.')) return;
        
        // Marquer la vente comme annul√©e
        await database.ref(`sessions/${session}/historiqueVentes/${venteId}`).update({
          annule: true,
          annulePar: userName,
          annuleLe: Date.now()
        });
        
        // LIB√âRER LE CR√âNEAU pour permettre une nouvelle saisie
        const creneauKey = `J${vente.jour}_${vente.barId}_${vente.creneau}`;
        await database.ref(`sessions/${session}/creneauxUtilises/${creneauKey}`).remove();
        
        showToast('‚úÖ Vente annul√©e, cr√©neau lib√©r√©');
      };

      const annulerMouvementFut = async (mouvementId) => {
        const mouvement = historique.find(h => h.id === mouvementId);
        if (!mouvement) return;

        let confirmMessage = 'Annuler ce mouvement de f√ªt ?\n\n';
        if (mouvement.type === 'SORTIE' || mouvement.type === 'REPRISE') {
          confirmMessage += `‚Üí Le f√ªt ${mouvement.typeFut === 'biere' ? 'üç∫ Bi√®re' : 'üçé Cidre'} sera RETIR√â du bar "${mouvement.barNom}"`;
        } else {
          confirmMessage += `‚Üí Le f√ªt ${mouvement.typeFut === 'biere' ? 'üç∫ Bi√®re' : 'üçé Cidre'} sera REMIS dans le bar "${mouvement.barNom}"`;
        }

        if (!confirm(confirmMessage)) return;

        // Marquer comme annul√©
        await database.ref(`sessions/${session}/historique/${mouvementId}`).update({
          annule: true,
          annulePar: userName,
          annuleLe: Date.now()
        });

        // R√©cup√©rer les f√ªts du bar
        const barRef = database.ref(`sessions/${session}/barsNomades/${mouvement.barId}/futs`);
        const snapshot = await barRef.once('value');
        let futs = snapshot.val() || [];
        
        // Convertir en tableau si c'est un objet (Firebase peut transformer les tableaux en objets)
        if (!Array.isArray(futs)) {
          futs = Object.values(futs);
        }

        if (mouvement.type === 'SORTIE' || mouvement.type === 'REPRISE') {
          // Annuler une SORTIE ou REPRISE ‚Üí Retirer le f√ªt du bar
          let lastIndex = -1;
          for (let i = futs.length - 1; i >= 0; i--) {
            if (futs[i] && futs[i].type === mouvement.typeFut) {
              lastIndex = i;
              break;
            }
          }
          if (lastIndex !== -1) {
            futs.splice(lastIndex, 1);
            await barRef.set(futs.length > 0 ? futs : null);
          }
          // Si c'√©tait une REPRISE, remettre en attente
          if (mouvement.type === 'REPRISE') {
            await database.ref(`sessions/${session}/futsEnAttente`).push({
              typeFut: mouvement.typeFut,
              barId: mouvement.barId,
              barNom: mouvement.barNom,
              jourOrigine: jourActuel,
              timestamp: Date.now(),
              user: userName
            });
          }
        } else if (mouvement.type === 'RETOUR_VIDE' || mouvement.type === 'RETOUR_CASSE' || mouvement.type === 'RETOUR_REUTILISABLE') {
          // Annuler un RETOUR ‚Üí Remettre le f√ªt dans le bar
          futs.push({ type: mouvement.typeFut, addedAt: Date.now() });
          await barRef.set(futs);
          
          // Si c'√©tait un RETOUR_REUTILISABLE, supprimer de la liste d'attente
          if (mouvement.type === 'RETOUR_REUTILISABLE') {
            // Chercher et supprimer le f√ªt en attente correspondant
            const futsAttenteSnapshot = await database.ref(`sessions/${session}/futsEnAttente`).once('value');
            const futsAttenteData = futsAttenteSnapshot.val();
            if (futsAttenteData) {
              for (const [id, fut] of Object.entries(futsAttenteData)) {
                // Correspondance par barId, typeFut et jour
                if (fut.barId === mouvement.barId && fut.typeFut === mouvement.typeFut && fut.jourOrigine === mouvement.jour) {
                  await database.ref(`sessions/${session}/futsEnAttente/${id}`).remove();
                  break; // On n'en supprime qu'un
                }
              }
            }
          }
        }
      };

      // ==================== FONCTIONS B√âN√âVOLES ====================
      const ouvrirModalBenevoles = () => {
        setBenevoleOnglet('planning');
        if (barsNomades.length > 0 && !selectedBarPlanning) {
          setSelectedBarPlanning(barsNomades[0].id);
        }
        setShowModalBenevoles(true);
      };

      const getAffectation = (barId, creneauId) => {
        return affectations[barId]?.[creneauId] || null;
      };

      const ouvrirEditionAffectation = (barId, creneauId) => {
        const existante = getAffectation(barId, creneauId) || {
          vendeur: { nom: '', prenom: '' },
          serveur: { nom: '', prenom: '' },
          runner: { nom: '', prenom: '' }
        };
        setEditAffectation({
          barId,
          creneauId,
          vendeur: { ...existante.vendeur },
          serveur: { ...existante.serveur },
          runner: { ...existante.runner }
        });
        setShowModalAffectation(true);
      };

      const sauvegarderAffectation = async () => {
        if (!editAffectation) return;
        const { barId, creneauId, vendeur, serveur, runner } = editAffectation;
        
        await database.ref(`sessions/${session}/affectations/jour${jourActuel}/${barId}/${creneauId}`).set({
          vendeur, serveur, runner
        });
        
        setShowModalAffectation(false);
        setEditAffectation(null);
      };

      const supprimerAffectation = async (barId, creneauId) => {
        await database.ref(`sessions/${session}/affectations/jour${jourActuel}/${barId}/${creneauId}`).remove();
      };

      const ouvrirParametresCreneaux = () => {
        setTempCreneaux([...creneaux]);
        setNouveauCreneau('');
        setBenevoleOnglet('parametres');
      };

      const ajouterCreneau = () => {
        if (nouveauCreneau.trim() && tempCreneaux.length < 10) {
          const newId = 'c' + Date.now();
          setTempCreneaux([...tempCreneaux, { id: newId, label: nouveauCreneau.trim() }]);
          setNouveauCreneau('');
        }
      };

      const supprimerCreneauTemp = (id) => {
        setTempCreneaux(tempCreneaux.filter(c => c.id !== id));
      };

      const sauvegarderCreneaux = async () => {
        await database.ref(`sessions/${session}/creneaux`).set(tempCreneaux);
        setBenevoleOnglet('planning');
      };

      const getNomComplet = (personne) => {
        if (!personne || (!personne.nom && !personne.prenom)) return '-';
        return `${personne.prenom || ''} ${personne.nom || ''}`.trim();
      };

      // ==================== EXPORTS ====================
      const formatDate = (ts) => new Date(ts).toLocaleString('fr-FR');
      const formatDateFilename = () => {
        const now = new Date();
        return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
      };

      const exportCSV = (filename, content) => {
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const exporterHistoriqueFuts = () => {
        if (historique.length === 0) return;
        const headers = ['Date/Heure', 'Type', 'F√ªt', 'Bar', 'Jour', 'Utilisateur', 'Commentaire', 'Annul√©', 'Annul√© par', 'Date annulation'];
        const rows = historique.map(h => [
          `"${formatDate(h.timestamp)}"`,
          `"${h.type}"`,
          `"${h.typeFut}"`,
          `"${h.barNom}"`,
          h.jour,
          `"${h.user}"`,
          `"${h.commentaire || ''}"`,
          h.annule ? 'Oui' : 'Non',
          `"${h.annulePar || ''}"`,
          h.annuleLe ? `"${formatDate(h.annuleLe)}"` : '""'
        ].join(';'));
        exportCSV(`Historique_Futs_${formatDateFilename()}.csv`, headers.join(';') + '\n' + rows.join('\n'));
      };

      const exporterHistoriqueVentes = () => {
        if (historiqueVentes.length === 0) return;
        const headers = ['Date/Heure', 'Bar', 'Montant', 'Pintes', 'Pichets', 'Gobelets', 'Jour', '√âquip. d√©faillant', 'N¬∞ √©quipement', 'Donn√©es partielles', 'Commentaire', 'Annul√©', 'Annul√© par', 'Date annulation'];
        const rows = historiqueVentes.map(v => [
          `"${formatDate(v.timestamp)}"`,
          `"${v.barNom}"`,
          (v.montant || 0).toFixed(2).replace('.', ','),
          v.nbPintes || 0,
          v.nbPichets || 0,
          v.nbGobelets || 0,
          v.jour,
          v.equipementDefaillant ? 'Oui' : 'Non',
          `"${v.numEquipement || ''}"`,
          v.donneesPartielles ? 'Oui' : 'Non',
          `"${v.commentaire || ''}"`,
          v.annule ? 'Oui' : 'Non',
          `"${v.annulePar || ''}"`,
          v.annuleLe ? `"${formatDate(v.annuleLe)}"` : '""'
        ].join(';'));
        const total = historiqueVentes.filter(v => !v.annule).reduce((a, v) => a + (v.montant || 0), 0);
        exportCSV(`Historique_Ventes_${formatDateFilename()}.csv`, 
          headers.join(';') + '\n' + rows.join('\n') + '\n\nTOTAL;' + total.toFixed(2).replace('.', ',') + ' ‚Ç¨');
      };

      const exporterBenevoles = () => {
        if (nbAffectations === 0) return;
        const headers = ['Jour', 'Bar Nomade', 'Cr√©neau', 'Vendeur', 'Serveur', 'Runner'];
        const rows = [];
        
        barsNomades.forEach(bar => {
          creneaux.forEach(creneau => {
            const aff = getAffectation(bar.id, creneau.id);
            rows.push([
              `J${jourActuel}`,
              `"${bar.nom}"`,
              `"${creneau.label}"`,
              `"${aff ? getNomComplet(aff.vendeur) : '-'}"`,
              `"${aff ? getNomComplet(aff.serveur) : '-'}"`,
              `"${aff ? getNomComplet(aff.runner) : '-'}"`
            ].join(';'));
          });
        });

        exportCSV(`Planning_Benevoles_J${jourActuel}_${formatDateFilename()}.csv`, 
          headers.join(';') + '\n' + rows.join('\n') + '\n\nJour;J' + jourActuel + '\nTotal affectations;' + nbAffectations);
      };

      // ==================== COPIER AFFECTATIONS DU JOUR PR√âC√âDENT ====================
      const copierAffectationsJourPrecedent = async () => {
        if (jourActuel <= 1) return;
        
        const jourSource = jourActuel - 1;
        const snapshot = await database.ref(`sessions/${session}/affectations/jour${jourSource}`).once('value');
        const affectationsSource = snapshot.val();
        
        if (!affectationsSource) {
          showToast(`‚ùå Aucune affectation trouv√©e pour J${jourSource}`, 'error');
          return;
        }

        if (!confirm(`Copier les affectations de J${jourSource} vers J${jourActuel} ?\n\nLes affectations existantes seront √©cras√©es.`)) return;

        setIsLoading(true);
        try {
          await database.ref(`sessions/${session}/affectations/jour${jourActuel}`).set(affectationsSource);
          await addAuditLog('COPIE_AFFECTATIONS', `Copie de J${jourSource} vers J${jourActuel}`);
          showToast(`‚úÖ Affectations copi√©es depuis J${jourSource}`);
        } catch (error) {
          showToast('‚ùå Erreur lors de la copie', 'error');
        } finally {
          setTimeout(() => setIsLoading(false), 1000);
        }
      };

      // ==================== FILTRES HISTORIQUE ====================
      const historiqueFiltre = historique.filter(h => {
        // Filtre par jour
        if (filtreJourHistorique !== 'tous' && h.jour !== parseInt(filtreJourHistorique)) {
          return false;
        }
        // Filtre par recherche
        if (rechercheHistorique.trim()) {
          const search = rechercheHistorique.toLowerCase();
          return (
            h.barNom?.toLowerCase().includes(search) ||
            h.user?.toLowerCase().includes(search) ||
            h.type?.toLowerCase().includes(search) ||
            h.commentaire?.toLowerCase().includes(search)
          );
        }
        return true;
      });

      const ventesFiltre = historiqueVentes.filter(v => {
        // Filtre par jour
        if (filtreJourVentes !== 'tous' && v.jour !== parseInt(filtreJourVentes)) {
          return false;
        }
        // Filtre par recherche
        if (rechercheVentes.trim()) {
          const search = rechercheVentes.toLowerCase();
          return (
            v.barNom?.toLowerCase().includes(search) ||
            v.user?.toLowerCase().includes(search) ||
            v.commentaire?.toLowerCase().includes(search)
          );
        }
        return true;
      });

      // ==================== STATISTIQUES DASHBOARD ====================
      const getStatistiques = () => {
        const aujourdHui = historique.filter(h => !h.annule && h.jour === jourActuel);
        const futsEnCirculation = aujourdHui.filter(h => h.type === 'SORTIE').length - 
          aujourdHui.filter(h => h.type.startsWith('RETOUR_')).length;
        
        const ventesParJour = {};
        for (let j = 1; j <= config.nombreJours; j++) {
          ventesParJour[j] = historiqueVentes
            .filter(v => !v.annule && v.jour === j)
            .reduce((acc, v) => acc + (v.montant || 0), 0);
        }

        const barsSansFut = barsNomades.filter(b => !b.futs || b.futs.length === 0);
        const equipementsDefaillants = historiqueVentes
          .filter(v => !v.annule && v.equipementDefaillant && v.jour === jourActuel);

        return {
          futsEnCirculation,
          ventesParJour,
          barsSansFut,
          equipementsDefaillants,
          totalVentesJour: ventesParJour[jourActuel] || 0
        };
      };

      // ==================== COMPARAISON J vs J-1 ====================
      const getComparaisonJour = () => {
        if (jourActuel <= 1) return null;
        
        const heureActuelle = new Date().getHours();
        const minuteActuelle = new Date().getMinutes();
        
        // Ventes du jour actuel jusqu'√† maintenant
        const ventesJour = historiqueVentes.filter(v => !v.annule && v.jour === jourActuel);
        const totalJour = ventesJour.reduce((acc, v) => acc + (v.montant || 0), 0);
        const nbTransactionsJour = ventesJour.length;
        
        // Ventes de J-1 √† la m√™me heure (approximation bas√©e sur le timestamp)
        const ventesJMoins1 = historiqueVentes.filter(v => {
          if (v.annule || v.jour !== jourActuel - 1) return false;
          const heureVente = new Date(v.timestamp).getHours();
          const minuteVente = new Date(v.timestamp).getMinutes();
          // Comparer si la vente √©tait avant l'heure actuelle
          return heureVente < heureActuelle || (heureVente === heureActuelle && minuteVente <= minuteActuelle);
        });
        const totalJMoins1 = ventesJMoins1.reduce((acc, v) => acc + (v.montant || 0), 0);
        const nbTransactionsJMoins1 = ventesJMoins1.length;
        
        // Total final de J-1 (pour r√©f√©rence)
        const totalFinalJMoins1 = historiqueVentes
          .filter(v => !v.annule && v.jour === jourActuel - 1)
          .reduce((acc, v) => acc + (v.montant || 0), 0);
        
        // F√ªts sortis
        const futsJour = historique.filter(h => !h.annule && h.jour === jourActuel && h.type === 'SORTIE').length;
        const futsJMoins1 = historique.filter(h => {
          if (h.annule || h.jour !== jourActuel - 1 || h.type !== 'SORTIE') return false;
          const heureH = new Date(h.timestamp).getHours();
          return heureH < heureActuelle || (heureH === heureActuelle);
        }).length;
        
        // Calcul des √©carts
        const ecartVentes = totalJour - totalJMoins1;
        const ecartPourcent = totalJMoins1 > 0 ? ((ecartVentes / totalJMoins1) * 100).toFixed(1) : 0;
        const ecartFuts = futsJour - futsJMoins1;
        
        return {
          jour: jourActuel,
          jourMoins1: jourActuel - 1,
          heureComparaison: `${heureActuelle}h${minuteActuelle.toString().padStart(2, '0')}`,
          ventesJour: totalJour,
          ventesJMoins1: totalJMoins1,
          totalFinalJMoins1,
          ecartVentes,
          ecartPourcent: parseFloat(ecartPourcent),
          tendance: ecartVentes >= 0 ? 'hausse' : 'baisse',
          nbTransactionsJour,
          nbTransactionsJMoins1,
          futsJour,
          futsJMoins1,
          ecartFuts
        };
      };

      // ==================== ANALYSE DES √âCARTS (PERTES) ====================
      const getAnalyseEcarts = (jour = jourActuel) => {
        // F√ªts vides retourn√©s pour ce jour
        const retoursBiere = historique.filter(h => 
          !h.annule && h.jour === jour && h.type === 'RETOUR_VIDE' && h.typeFut === 'biere'
        ).length;
        const retoursCidre = historique.filter(h => 
          !h.annule && h.jour === jour && h.type === 'RETOUR_VIDE' && h.typeFut === 'cidre'
        ).length;
        
        // Volumes sortis (bas√© sur f√ªts vides uniquement)
        const volumeSortiBiere = retoursBiere * config.volumeFutBiere;
        const volumeSortiCidre = retoursCidre * config.volumeFutCidre;
        
        // Ventes du jour
        const ventesJour = historiqueVentes.filter(v => !v.annule && v.jour === jour);
        
        // S√©parer ventes bi√®re et cidre
        const ventesBiere = ventesJour.filter(v => {
          const bar = barsNomades.find(b => b.id === v.barId);
          return bar?.type === 'biere';
        });
        const ventesCidre = ventesJour.filter(v => {
          const bar = barsNomades.find(b => b.id === v.barId);
          return bar?.type === 'cidre';
        });
        
        // Quantit√©s vendues
        const pintesBiere = ventesBiere.reduce((acc, v) => acc + (v.nbPintes || 0), 0);
        const pichetsBiere = ventesBiere.reduce((acc, v) => acc + (v.nbPichets || 0), 0);
        const gobeletsBiere = ventesBiere.reduce((acc, v) => acc + (v.nbGobelets || 0), 0);
        
        const pintesCidre = ventesCidre.reduce((acc, v) => acc + (v.nbPintes || 0), 0);
        const pichetsCidre = ventesCidre.reduce((acc, v) => acc + (v.nbPichets || 0), 0);
        const gobeletsCidre = ventesCidre.reduce((acc, v) => acc + (v.nbGobelets || 0), 0);
        
        // Volume vendu (SANS gobelets)
        const volumeVenduBiere = (pintesBiere * config.volumePinte) + (pichetsBiere * config.volumePichet);
        const volumeVenduCidre = (pintesCidre * config.volumePinte) + (pichetsCidre * config.volumePichet);
        
        // CA d√©clar√©
        const caDeclareBiere = ventesBiere.reduce((acc, v) => acc + (v.montant || 0), 0);
        const caDeclareCidre = ventesCidre.reduce((acc, v) => acc + (v.montant || 0), 0);
        
        // CA th√©orique (avec gobelets)
        const caTheoriqueBiere = (pintesBiere * config.prixPinte) + (pichetsBiere * config.prixPichet) + (gobeletsBiere * config.prixGobelet);
        const caTheoriqueCidre = (pintesCidre * config.prixPinte) + (pichetsCidre * config.prixPichet) + (gobeletsCidre * config.prixGobelet);
        
        // √âcarts volume
        const ecartVolumeBiere = volumeSortiBiere - volumeVenduBiere;
        const ecartVolumeCidre = volumeSortiCidre - volumeVenduCidre;
        
        // Taux de perte
        const tauxPerteBiere = volumeSortiBiere > 0 ? (ecartVolumeBiere / volumeSortiBiere) * 100 : 0;
        const tauxPerteCidre = volumeSortiCidre > 0 ? (ecartVolumeCidre / volumeSortiCidre) * 100 : 0;
        const tauxPerteGlobal = (volumeSortiBiere + volumeSortiCidre) > 0 
          ? ((ecartVolumeBiere + ecartVolumeCidre) / (volumeSortiBiere + volumeSortiCidre)) * 100 
          : 0;
        
        // √âcarts CA
        const ecartCaBiere = caDeclareBiere - caTheoriqueBiere;
        const ecartCaCidre = caDeclareCidre - caTheoriqueCidre;
        
        // Coh√©rence CA
        const coherenceCaBiere = caTheoriqueBiere > 0 ? (caDeclareBiere / caTheoriqueBiere) * 100 : 100;
        const coherenceCaCidre = caTheoriqueCidre > 0 ? (caDeclareCidre / caTheoriqueCidre) * 100 : 100;
        
        // Manque √† gagner (bas√© sur le prix de la pinte)
        const manqueAGagnerBiere = ecartVolumeBiere > 0 ? (ecartVolumeBiere / config.volumePinte) * config.prixPinte : 0;
        const manqueAGagnerCidre = ecartVolumeCidre > 0 ? (ecartVolumeCidre / config.volumePinte) * config.prixPinte : 0;
        
        // Statut selon seuil
        const getStatut = (taux) => {
          if (taux <= config.seuilPerte) return 'ok';
          if (taux <= config.seuilPerte * 1.5) return 'attention';
          return 'alerte';
        };
        
        return {
          biere: {
            futsVides: retoursBiere,
            volumeSorti: volumeSortiBiere,
            pintes: pintesBiere,
            pichets: pichetsBiere,
            gobelets: gobeletsBiere,
            volumeVendu: volumeVenduBiere,
            ecartVolume: ecartVolumeBiere,
            tauxPerte: tauxPerteBiere,
            statutPerte: getStatut(tauxPerteBiere),
            caDeclare: caDeclareBiere,
            caTheorique: caTheoriqueBiere,
            ecartCa: ecartCaBiere,
            coherenceCa: coherenceCaBiere,
            manqueAGagner: manqueAGagnerBiere
          },
          cidre: {
            futsVides: retoursCidre,
            volumeSorti: volumeSortiCidre,
            pintes: pintesCidre,
            pichets: pichetsCidre,
            gobelets: gobeletsCidre,
            volumeVendu: volumeVenduCidre,
            ecartVolume: ecartVolumeCidre,
            tauxPerte: tauxPerteCidre,
            statutPerte: getStatut(tauxPerteCidre),
            caDeclare: caDeclareCidre,
            caTheorique: caTheoriqueCidre,
            ecartCa: ecartCaCidre,
            coherenceCa: coherenceCaCidre,
            manqueAGagner: manqueAGagnerCidre
          },
          total: {
            futsVides: retoursBiere + retoursCidre,
            volumeSorti: volumeSortiBiere + volumeSortiCidre,
            volumeVendu: volumeVenduBiere + volumeVenduCidre,
            ecartVolume: ecartVolumeBiere + ecartVolumeCidre,
            tauxPerte: tauxPerteGlobal,
            statutPerte: getStatut(tauxPerteGlobal),
            caDeclare: caDeclareBiere + caDeclareCidre,
            caTheorique: caTheoriqueBiere + caTheoriqueCidre,
            ecartCa: ecartCaBiere + ecartCaCidre,
            manqueAGagner: manqueAGagnerBiere + manqueAGagnerCidre
          }
        };
      };

      // ==================== ANALYSE √âCARTS PAR BAR ====================
      const getAnalyseEcartsParBar = (jour = jourActuel) => {
        return barsNomades.map(bar => {
          const isBiere = bar.type === 'biere';
          const volumeFut = isBiere ? config.volumeFutBiere : config.volumeFutCidre;
          
          // F√ªts vides retourn√©s pour ce bar
          const futsVides = historique.filter(h => 
            !h.annule && h.jour === jour && h.type === 'RETOUR_VIDE' && h.barId === bar.id
          ).length;
          
          const volumeSorti = futsVides * volumeFut;
          
          // Ventes de ce bar
          const ventesBar = historiqueVentes.filter(v => !v.annule && v.jour === jour && v.barId === bar.id);
          const pintes = ventesBar.reduce((acc, v) => acc + (v.nbPintes || 0), 0);
          const pichets = ventesBar.reduce((acc, v) => acc + (v.nbPichets || 0), 0);
          const gobelets = ventesBar.reduce((acc, v) => acc + (v.nbGobelets || 0), 0);
          
          const volumeVendu = (pintes * config.volumePinte) + (pichets * config.volumePichet);
          const ecartVolume = volumeSorti - volumeVendu;
          const tauxPerte = volumeSorti > 0 ? (ecartVolume / volumeSorti) * 100 : 0;
          
          const caDeclare = ventesBar.reduce((acc, v) => acc + (v.montant || 0), 0);
          const caTheorique = (pintes * config.prixPinte) + (pichets * config.prixPichet) + (gobelets * config.prixGobelet);
          
          const getStatut = (taux) => {
            if (taux <= config.seuilPerte) return 'ok';
            if (taux <= config.seuilPerte * 1.5) return 'attention';
            return 'alerte';
          };
          
          return {
            barId: bar.id,
            barNom: bar.nom,
            type: bar.type,
            futsVides,
            volumeSorti,
            pintes,
            pichets,
            gobelets,
            volumeVendu,
            ecartVolume,
            tauxPerte,
            statutPerte: getStatut(tauxPerte),
            caDeclare,
            caTheorique,
            ecartCa: caDeclare - caTheorique,
            ratioParFut: futsVides > 0 ? caDeclare / futsVides : 0
          };
        });
      };

      // ==================== ANALYSE √âCARTS PAR CR√âNEAU ====================
      const getAnalyseEcartsParCreneau = (jour = jourActuel) => {
        return creneaux.map(creneau => {
          // Ventes de ce cr√©neau
          const ventesCreneau = historiqueVentes.filter(v => 
            !v.annule && v.jour === jour && v.creneau === creneau.id
          );
          
          // F√ªts retourn√©s pendant ce cr√©neau (approximation bas√©e sur le timestamp)
          // On ne peut pas lier directement, donc on compte globalement
          const pintes = ventesCreneau.reduce((acc, v) => acc + (v.nbPintes || 0), 0);
          const pichets = ventesCreneau.reduce((acc, v) => acc + (v.nbPichets || 0), 0);
          const gobelets = ventesCreneau.reduce((acc, v) => acc + (v.nbGobelets || 0), 0);
          
          const volumeVendu = (pintes * config.volumePinte) + (pichets * config.volumePichet);
          const caDeclare = ventesCreneau.reduce((acc, v) => acc + (v.montant || 0), 0);
          const caTheorique = (pintes * config.prixPinte) + (pichets * config.prixPichet) + (gobelets * config.prixGobelet);
          
          return {
            creneauId: creneau.id,
            creneauLabel: creneau.label,
            nbTransactions: ventesCreneau.length,
            pintes,
            pichets,
            gobelets,
            volumeVendu,
            caDeclare,
            caTheorique,
            ecartCa: caDeclare - caTheorique,
            coherenceCa: caTheorique > 0 ? (caDeclare / caTheorique) * 100 : 100
          };
        });
      };

      // ==================== SYNTH√àSE TOP 10 ====================
      const getSyntheseTop10 = () => {
        const stats = getStatistiques();
        const comparaison = getComparaisonJour();
        const ecarts = getAnalyseEcarts();
        const ecartsParBar = getAnalyseEcartsParBar();
        const ecartsParCreneau = getAnalyseEcartsParCreneau();
        
        // 1. CA total du jour
        const caTotal = stats.totalVentesJour;
        
        // 2. Comparaison J vs J-1 (d√©j√† dans comparaison)
        
        // 3. Classement bars par CA
        const classementBars = [...ecartsParBar].sort((a, b) => b.caDeclare - a.caDeclare);
        
        // 4. F√ªts consomm√©s
        const futsConsommes = ecarts.total.futsVides;
        const futsBiere = ecarts.biere.futsVides;
        const futsCidre = ecarts.cidre.futsVides;
        
        // 5. Dur√©e moyenne f√ªt
        const retours = historique.filter(h => !h.annule && h.jour === jourActuel && h.type === 'RETOUR_VIDE');
        let dureeTotale = 0;
        let nbDurees = 0;
        retours.forEach(retour => {
          // Chercher la sortie correspondante
          const sortie = historique.find(h => 
            !h.annule && h.jour === jourActuel && h.type === 'SORTIE' && 
            h.barId === retour.barId && h.timestamp < retour.timestamp
          );
          if (sortie) {
            dureeTotale += retour.timestamp - sortie.timestamp;
            nbDurees++;
          }
        });
        const dureeMoyenneMs = nbDurees > 0 ? dureeTotale / nbDurees : 0;
        const dureeMoyenneH = Math.floor(dureeMoyenneMs / (1000 * 60 * 60));
        const dureeMoyenneM = Math.floor((dureeMoyenneMs % (1000 * 60 * 60)) / (1000 * 60));
        const dureeMoyenneStr = dureeMoyenneMs > 0 ? `${dureeMoyenneH}h${dureeMoyenneM.toString().padStart(2, '0')}` : '-';
        
        // 6. Taux de perte global
        const tauxPerteGlobal = ecarts.total.tauxPerte;
        
        // 7. Bar le plus rentable (CA/f√ªt)
        const barsAvecFuts = ecartsParBar.filter(b => b.futsVides > 0);
        const barPlusRentable = barsAvecFuts.length > 0 
          ? barsAvecFuts.reduce((best, b) => b.ratioParFut > best.ratioParFut ? b : best, barsAvecFuts[0])
          : null;
        
        // 8. Pic d'activit√© (cr√©neau avec le plus de CA)
        const picActivite = ecartsParCreneau.reduce((best, c) => c.caDeclare > best.caDeclare ? c : best, ecartsParCreneau[0]);
        
        // 9. Stock restant (d√©j√† dans stockBiere/stockCidre)
        
        // 10. Progression festival
        const progressionFestival = [];
        for (let j = 1; j <= jourActuel; j++) {
          const ventesJ = historiqueVentes.filter(v => !v.annule && v.jour === j);
          const caJ = ventesJ.reduce((acc, v) => acc + (v.montant || 0), 0);
          progressionFestival.push({ jour: j, ca: caJ });
        }
        
        return {
          caTotal,
          comparaison,
          classementBars,
          futsConsommes,
          futsBiere,
          futsCidre,
          dureeMoyenne: dureeMoyenneStr,
          tauxPerteGlobal,
          statutPerte: ecarts.total.statutPerte,
          manqueAGagner: ecarts.total.manqueAGagner,
          barPlusRentable,
          picActivite,
          progressionFestival
        };
      };

      // ==================== COMPARATIF MULTI-JOURS ====================
      const getComparatifFestival = () => {
        const jours = [];
        
        for (let j = 1; j <= config.nombreJours; j++) {
          const ventesJ = historiqueVentes.filter(v => !v.annule && v.jour === j);
          const caJ = ventesJ.reduce((acc, v) => acc + (v.montant || 0), 0);
          
          const ecartsJ = getAnalyseEcarts(j);
          const ecartsParBarJ = getAnalyseEcartsParBar(j);
          
          const topBar = ecartsParBarJ.length > 0 
            ? ecartsParBarJ.reduce((best, b) => b.caDeclare > best.caDeclare ? b : best, ecartsParBarJ[0])
            : null;
          
          // Pic activit√©
          const ventesParCreneau = creneaux.map(c => {
            const v = ventesJ.filter(vente => vente.creneau === c.id);
            return {
              creneau: c.label,
              ca: v.reduce((acc, vente) => acc + (vente.montant || 0), 0)
            };
          });
          const picJ = ventesParCreneau.reduce((best, c) => c.ca > best.ca ? c : best, ventesParCreneau[0]);
          
          jours.push({
            jour: j,
            ca: caJ,
            futsBiere: ecartsJ.biere.futsVides,
            futsCidre: ecartsJ.cidre.futsVides,
            tauxPerte: ecartsJ.total.tauxPerte,
            topBar: topBar?.barNom || '-',
            topBarCa: topBar?.caDeclare || 0,
            picCreneau: picJ.creneau,
            hasDonnees: caJ > 0 || ecartsJ.total.futsVides > 0
          });
        }
        
        // Totaux
        const caTotal = jours.reduce((acc, j) => acc + j.ca, 0);
        const futsTotal = jours.reduce((acc, j) => acc + j.futsBiere + j.futsCidre, 0);
        
        return { jours, caTotal, futsTotal };
      };

      // ==================== PR√âVISION RUPTURE DE STOCK ====================
      const getPrevisionRupture = () => {
        const historiqueJour = historique.filter(h => !h.annule && h.jour === jourActuel);
        const sorties = historiqueJour.filter(h => h.type === 'SORTIE');
        
        // Fonction pour formater les heures en texte lisible
        const formatHeures = (heures) => {
          if (!isFinite(heures) || heures > 100) return null;
          const h = Math.floor(heures);
          const m = Math.round((heures - h) * 60);
          if (h > 0 && m > 0) return `${h}h${m.toString().padStart(2, '0')}`;
          if (h > 0) return `${h}h`;
          return `${m}min`;
        };
        
        // Valeurs par d√©faut si pas assez de donn√©es
        const defaultResult = {
          biere: { rythme: '0.0', tempsRestant: null, alerte: false },
          cidre: { rythme: '0.0', tempsRestant: null, alerte: false }
        };
        
        if (sorties.length < 2) return defaultResult;
        
        // Calculer le temps √©coul√© depuis la premi√®re sortie
        const premiereSortie = Math.min(...sorties.map(s => s.timestamp));
        const heuresEcoulees = (Date.now() - premiereSortie) / (1000 * 60 * 60);
        
        if (heuresEcoulees < 0.5) return defaultResult;
        
        // Rythme par type de f√ªt
        const sortiesBiere = sorties.filter(s => s.typeFut === 'biere').length;
        const sortiesCidre = sorties.filter(s => s.typeFut === 'cidre').length;
        
        const rythmeBiere = sortiesBiere / heuresEcoulees;
        const rythmeCidre = sortiesCidre / heuresEcoulees;
        
        const heuresRestantesBiere = rythmeBiere > 0 ? stockBiere / rythmeBiere : Infinity;
        const heuresRestantesCidre = rythmeCidre > 0 ? stockCidre / rythmeCidre : Infinity;
        
        return {
          biere: {
            rythme: rythmeBiere.toFixed(1),
            tempsRestant: formatHeures(heuresRestantesBiere),
            alerte: heuresRestantesBiere < 4
          },
          cidre: {
            rythme: rythmeCidre.toFixed(1),
            tempsRestant: formatHeures(heuresRestantesCidre),
            alerte: heuresRestantesCidre < 4
          }
        };
      };

      // ==================== STATISTIQUES PAR HEURE ====================
      const getStatsParHeure = () => {
        const statsParHeure = {};
        const statsParBarEtHeure = {};
        
        // Initialiser les heures de 10h √† 2h du matin
        for (let h = 10; h <= 26; h++) {
          const heure = h > 24 ? h - 24 : h;
          statsParHeure[heure] = { sorties: 0, retours: 0 };
        }
        
        historique.filter(h => !h.annule && h.jour === jourActuel).forEach(h => {
          const heure = new Date(h.timestamp).getHours();
          if (!statsParHeure[heure]) statsParHeure[heure] = { sorties: 0, retours: 0 };
          
          if (h.type === 'SORTIE') {
            statsParHeure[heure].sorties++;
          } else if (h.type.startsWith('RETOUR_')) {
            statsParHeure[heure].retours++;
          }
          
          // Stats par bar et heure
          if (!statsParBarEtHeure[h.barId]) statsParBarEtHeure[h.barId] = {};
          if (!statsParBarEtHeure[h.barId][heure]) statsParBarEtHeure[h.barId][heure] = { sorties: 0, retours: 0 };
          if (h.type === 'SORTIE') {
            statsParBarEtHeure[h.barId][heure].sorties++;
          } else if (h.type.startsWith('RETOUR_')) {
            statsParBarEtHeure[h.barId][heure].retours++;
          }
        });
        
        return { statsParHeure, statsParBarEtHeure };
      };

      // ==================== CLASSEMENT DES BARS ====================
      const getClassementBars = () => {
        return barsNomades.map(bar => {
          const ventesBar = historiqueVentes
            .filter(v => !v.annule && v.barId === bar.id)
            .reduce((acc, v) => acc + (v.montant || 0), 0);
          
          const futsConsommes = historique
            .filter(h => !h.annule && h.barId === bar.id && h.type.startsWith('RETOUR_'))
            .length;
          
          const sorties = historique
            .filter(h => !h.annule && h.barId === bar.id && h.type === 'SORTIE');
          
          const retours = historique
            .filter(h => !h.annule && h.barId === bar.id && h.type.startsWith('RETOUR_'));
          
          // Temps moyen de rotation (entre sortie et retour)
          let rotationMoyenne = 0;
          if (retours.length > 0) {
            // Simplification : prendre le temps moyen bas√© sur les f√ªts retourn√©s
            const tempsTotal = retours.reduce((acc, r) => {
              const sortieCorrespondante = sorties.find(s => s.timestamp < r.timestamp);
              if (sortieCorrespondante) {
                return acc + (r.timestamp - sortieCorrespondante.timestamp);
              }
              return acc;
            }, 0);
            rotationMoyenne = tempsTotal / retours.length / (1000 * 60 * 60); // en heures
          }
          
          return {
            ...bar,
            chiffreAffaires: ventesBar,
            futsConsommes,
            rotationMoyenne
          };
        }).sort((a, b) => b.chiffreAffaires - a.chiffreAffaires);
      };

      // ==================== ACTIVIT√â PAR HEURE ====================
      const getActiviteParHeure = () => {
        const heures = [];
        // De 10h √† 23h, puis minuit (0h)
        const heuresJournee = [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0];
        
        for (const h of heuresJournee) {
          const mouvementsHeure = historique.filter(m => {
            if (m.annule || m.jour !== jourActuel) return false;
            const heureMouvement = new Date(m.timestamp).getHours();
            return heureMouvement === h;
          });
          
          heures.push({
            heure: h,
            heureAffichage: h === 0 ? '00' : h.toString(),
            sorties: mouvementsHeure.filter(m => m.type === 'SORTIE').length,
            retours: mouvementsHeure.filter(m => m.type.startsWith('RETOUR_')).length
          });
        }
        return heures;
      };

      // ==================== ENVOI D'ANNONCE ====================
      const envoyerAnnonce = async () => {
        if (!nouvelleAnnonce.trim() || !isCreator) return;
        
        await database.ref(`sessions/${session}/annonces`).push({
          message: nouvelleAnnonce.trim(),
          auteur: userName,
          timestamp: Date.now(),
          jour: jourActuel
        });
        
        setNouvelleAnnonce('');
        setShowAnnonceInput(false);
        showToast('üì¢ Annonce envoy√©e');
      };

      // Supprimer une annonce
      const supprimerAnnonce = async (annonceId) => {
        if (!isCreator) return;
        await database.ref(`sessions/${session}/annonces/${annonceId}`).remove();
      };

      // ==================== EXPORT PDF BILAN JOURNALIER ====================
      const exporterBilanPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const ventesJour = historiqueVentes.filter(v => !v.annule && v.jour === jourActuel);
        const mouvementsJour = historique.filter(h => !h.annule && h.jour === jourActuel);
        const incidents = historiqueVentes.filter(v => !v.annule && v.equipementDefaillant && v.jour === jourActuel);
        const totalVentes = ventesJour.reduce((acc, v) => acc + (v.montant || 0), 0);
        const comparaison = getComparaisonJour();
        const ecarts = getAnalyseEcarts();
        const ecartsParBar = getAnalyseEcartsParBar();
        
        let y = 20;
        
        // Titre
        doc.setFontSize(20);
        doc.setTextColor(220, 38, 38);
        doc.text('HELLFEST 2026 - BILAN JOURNALIER', 105, y, { align: 'center' });
        y += 10;
        
        doc.setFontSize(14);
        doc.setTextColor(0);
        doc.text(`Jour ${jourActuel} - ${new Date().toLocaleDateString('fr-FR')}`, 105, y, { align: 'center' });
        y += 15;
        
        // R√©sum√© des ventes
        doc.setFontSize(16);
        doc.setTextColor(16, 185, 129);
        doc.text('RESUME DES VENTES', 20, y);
        y += 10;
        
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text(`Total du jour: ${totalVentes.toFixed(2)} EUR`, 25, y);
        y += 7;
        doc.text(`Nombre de transactions: ${ventesJour.length}`, 25, y);
        y += 7;
        doc.text(`Ticket moyen: ${ventesJour.length > 0 ? (totalVentes / ventesJour.length).toFixed(2) : 0} EUR`, 25, y);
        y += 12;
        
        // Comparaison J vs J-1
        if (comparaison) {
          doc.setFontSize(14);
          doc.setTextColor(comparaison.tendance === 'hausse' ? 34 : 220, comparaison.tendance === 'hausse' ? 197 : 38, comparaison.tendance === 'hausse' ? 94 : 38);
          doc.text(`COMPARAISON J${comparaison.jour} vs J${comparaison.jourMoins1}`, 20, y);
          y += 8;
          
          doc.setFontSize(11);
          doc.setTextColor(0);
          doc.text(`A ${comparaison.heureComparaison}, comparaison avec hier a la meme heure :`, 25, y);
          y += 6;
          doc.text(`Ventes J${comparaison.jour}: ${comparaison.ventesJour.toFixed(2)} EUR vs J${comparaison.jourMoins1}: ${comparaison.ventesJMoins1.toFixed(2)} EUR`, 25, y);
          y += 6;
          doc.text(`Ecart: ${comparaison.ecartVentes >= 0 ? '+' : ''}${comparaison.ecartVentes.toFixed(2)} EUR (${comparaison.ecartVentes >= 0 ? '+' : ''}${comparaison.ecartPourcent}%)`, 25, y);
          y += 6;
          doc.text(`Futs sortis: ${comparaison.futsJour} vs ${comparaison.futsJMoins1} hier (${comparaison.ecartFuts >= 0 ? '+' : ''}${comparaison.ecartFuts})`, 25, y);
          y += 6;
          if (comparaison.totalFinalJMoins1 > 0) {
            doc.text(`Total final J${comparaison.jourMoins1}: ${comparaison.totalFinalJMoins1.toFixed(2)} EUR`, 25, y);
            y += 6;
          }
          y += 6;
        }
        
        // Ventes par bar
        doc.setFontSize(14);
        doc.setTextColor(0);
        doc.text('Ventes par bar:', 25, y);
        y += 7;
        
        const classement = getClassementBars();
        classement.forEach((bar, idx) => {
          const ventesBarJour = historiqueVentes
            .filter(v => !v.annule && v.barId === bar.id && v.jour === jourActuel)
            .reduce((acc, v) => acc + (v.montant || 0), 0);
          doc.setFontSize(11);
          doc.text(`${idx + 1}. ${bar.nom} (${bar.type}): ${ventesBarJour.toFixed(2)} EUR`, 30, y);
          y += 6;
        });
        y += 10;
        
        // Mouvements de f√ªts
        doc.setFontSize(16);
        doc.setTextColor(147, 51, 234);
        doc.text('MOUVEMENTS DE FUTS', 20, y);
        y += 10;
        
        doc.setFontSize(12);
        doc.setTextColor(0);
        const sorties = mouvementsJour.filter(m => m.type === 'SORTIE').length;
        const retoursVides = mouvementsJour.filter(m => m.type === 'RETOUR_VIDE').length;
        const retoursCasses = mouvementsJour.filter(m => m.type === 'RETOUR_CASSE').length;
        const retoursNonTermines = mouvementsJour.filter(m => m.type === 'RETOUR_REUTILISABLE').length;
        
        doc.text(`Sorties: ${sorties}`, 25, y);
        y += 7;
        doc.text(`Retours vides: ${retoursVides}`, 25, y);
        y += 7;
        doc.text(`Retours casses: ${retoursCasses}`, 25, y);
        y += 7;
        doc.text(`Futs non termines: ${retoursNonTermines}`, 25, y);
        y += 7;
        doc.text(`Stock restant - Biere: ${stockBiere} | Cidre: ${stockCidre}`, 25, y);
        y += 15;
        
        // NOUVELLE SECTION: Analyse des √©carts
        if (ecarts.total.futsVides > 0) {
          // Nouvelle page si n√©cessaire
          if (y > 200) {
            doc.addPage();
            y = 20;
          }
          
          doc.setFontSize(16);
          doc.setTextColor(234, 88, 12);
          doc.text('ANALYSE DES ECARTS (PERTES)', 20, y);
          y += 10;
          
          doc.setFontSize(11);
          doc.setTextColor(0);
          
          // Tableau √©carts volume
          doc.text('Controle Volume:', 25, y);
          y += 7;
          doc.text(`                    Biere       Cidre       Total`, 25, y);
          y += 6;
          doc.text(`Volume sorti:       ${ecarts.biere.volumeSorti.toFixed(0)}L        ${ecarts.cidre.volumeSorti.toFixed(0)}L        ${ecarts.total.volumeSorti.toFixed(0)}L`, 25, y);
          y += 6;
          doc.text(`Volume vendu:       ${ecarts.biere.volumeVendu.toFixed(1)}L      ${ecarts.cidre.volumeVendu.toFixed(1)}L      ${ecarts.total.volumeVendu.toFixed(1)}L`, 25, y);
          y += 6;
          doc.text(`Ecart:              ${ecarts.biere.ecartVolume.toFixed(1)}L       ${ecarts.cidre.ecartVolume.toFixed(1)}L       ${ecarts.total.ecartVolume.toFixed(1)}L`, 25, y);
          y += 6;
          
          const getStatutText = (statut) => statut === 'ok' ? 'OK' : statut === 'attention' ? 'ATTENTION' : 'ALERTE';
          doc.text(`Taux perte:         ${ecarts.biere.tauxPerte.toFixed(1)}% ${getStatutText(ecarts.biere.statutPerte)}    ${ecarts.cidre.tauxPerte.toFixed(1)}% ${getStatutText(ecarts.cidre.statutPerte)}    ${ecarts.total.tauxPerte.toFixed(1)}%`, 25, y);
          y += 10;
          
          // Contr√¥le CA
          doc.text('Controle CA:', 25, y);
          y += 7;
          doc.text(`CA declare:         ${ecarts.biere.caDeclare.toFixed(0)}EUR      ${ecarts.cidre.caDeclare.toFixed(0)}EUR      ${ecarts.total.caDeclare.toFixed(0)}EUR`, 25, y);
          y += 6;
          doc.text(`CA theorique:       ${ecarts.biere.caTheorique.toFixed(0)}EUR      ${ecarts.cidre.caTheorique.toFixed(0)}EUR      ${ecarts.total.caTheorique.toFixed(0)}EUR`, 25, y);
          y += 6;
          doc.text(`Ecart CA:           ${ecarts.biere.ecartCa >= 0 ? '+' : ''}${ecarts.biere.ecartCa.toFixed(0)}EUR      ${ecarts.cidre.ecartCa >= 0 ? '+' : ''}${ecarts.cidre.ecartCa.toFixed(0)}EUR      ${ecarts.total.ecartCa >= 0 ? '+' : ''}${ecarts.total.ecartCa.toFixed(0)}EUR`, 25, y);
          y += 10;
          
          if (ecarts.total.manqueAGagner > 0) {
            doc.setTextColor(220, 38, 38);
            doc.text(`Manque a gagner estime: ~${ecarts.total.manqueAGagner.toFixed(0)} EUR`, 25, y);
            y += 10;
          }
          
          // √âcarts par bar
          doc.setTextColor(0);
          doc.text('Ecarts par bar:', 25, y);
          y += 7;
          
          ecartsParBar.forEach(bar => {
            const statutSymbol = bar.statutPerte === 'ok' ? '(OK)' : bar.statutPerte === 'attention' ? '(!)' : '(ALERTE)';
            doc.text(`  ${bar.barNom}: ${bar.tauxPerte.toFixed(1)}% ${statutSymbol} - ${bar.caDeclare.toFixed(0)}EUR`, 25, y);
            y += 6;
          });
          y += 5;
        }
        
        // Incidents
        if (incidents.length > 0) {
          if (y > 240) {
            doc.addPage();
            y = 20;
          }
          
          doc.setFontSize(16);
          doc.setTextColor(234, 88, 12);
          doc.text('INCIDENTS SIGNALES', 20, y);
          y += 10;
          
          doc.setFontSize(11);
          doc.setTextColor(0);
          incidents.forEach(inc => {
            doc.text(`- ${inc.barNom} - Equip. ${inc.numEquipement || 'N/A'}: ${inc.commentaire || 'Pas de detail'}`, 25, y);
            y += 6;
          });
        }
        
        // Footer
        doc.setFontSize(9);
        doc.setTextColor(128);
        doc.text(`Genere le ${new Date().toLocaleString('fr-FR')} - Session ${session}`, 105, 285, { align: 'center' });
        
        return doc;
      };
      
      // Fonction pour t√©l√©charger le PDF
      const telechargerBilanPDF = () => {
        const doc = exporterBilanPDF();
        doc.save(`Bilan_J${jourActuel}_${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('üìÑ PDF export√©');
      };

      // ==================== EXPORT EXCEL ====================
      const exporterBilanExcel = () => {
        const ecarts = getAnalyseEcarts();
        const ecartsParBar = getAnalyseEcartsParBar();
        const ecartsParCreneau = getAnalyseEcartsParCreneau();
        const comparatif = getComparatifFestival();
        
        // Feuille 1 : R√©sum√© du jour
        const resumeData = [
          ['HELLFEST 2026 - BILAN JOURNALIER'],
          [`Jour ${jourActuel} - ${new Date().toLocaleDateString('fr-FR')}`],
          [],
          ['R√âSUM√â DES VENTES'],
          ['Total du jour', ecarts.total.caDeclare.toFixed(2) + ' ‚Ç¨'],
          ['Nombre de transactions', historiqueVentes.filter(v => !v.annule && v.jour === jourActuel).length],
          [],
          ['F√õTS CONSOMM√âS'],
          ['Bi√®re', ecarts.biere.futsVides],
          ['Cidre', ecarts.cidre.futsVides],
          ['Total', ecarts.total.futsVides],
          [],
          ['STOCK RESTANT'],
          ['Bi√®re', stockBiere],
          ['Cidre', stockCidre],
        ];
        
        // Feuille 2 : Analyse des √©carts
        const ecartsData = [
          ['ANALYSE DES √âCARTS - VOLUMES'],
          [],
          ['', 'Bi√®re', 'Cidre', 'Total'],
          ['F√ªts vides', ecarts.biere.futsVides, ecarts.cidre.futsVides, ecarts.total.futsVides],
          ['Volume sorti (L)', ecarts.biere.volumeSorti, ecarts.cidre.volumeSorti, ecarts.total.volumeSorti],
          ['Pintes vendues', ecarts.biere.pintes, ecarts.cidre.pintes, ecarts.biere.pintes + ecarts.cidre.pintes],
          ['Pichets vendus', ecarts.biere.pichets, ecarts.cidre.pichets, ecarts.biere.pichets + ecarts.cidre.pichets],
          ['Volume vendu (L)', ecarts.biere.volumeVendu.toFixed(1), ecarts.cidre.volumeVendu.toFixed(1), ecarts.total.volumeVendu.toFixed(1)],
          ['√âcart volume (L)', ecarts.biere.ecartVolume.toFixed(1), ecarts.cidre.ecartVolume.toFixed(1), ecarts.total.ecartVolume.toFixed(1)],
          ['Taux de perte (%)', ecarts.biere.tauxPerte.toFixed(1), ecarts.cidre.tauxPerte.toFixed(1), ecarts.total.tauxPerte.toFixed(1)],
          [],
          ['CONTR√îLE CA'],
          ['CA d√©clar√© (‚Ç¨)', ecarts.biere.caDeclare.toFixed(2), ecarts.cidre.caDeclare.toFixed(2), ecarts.total.caDeclare.toFixed(2)],
          ['CA th√©orique (‚Ç¨)', ecarts.biere.caTheorique.toFixed(2), ecarts.cidre.caTheorique.toFixed(2), ecarts.total.caTheorique.toFixed(2)],
          ['√âcart CA (‚Ç¨)', ecarts.biere.ecartCa.toFixed(2), ecarts.cidre.ecartCa.toFixed(2), ecarts.total.ecartCa.toFixed(2)],
          ['Manque √† gagner (‚Ç¨)', ecarts.biere.manqueAGagner.toFixed(2), ecarts.cidre.manqueAGagner.toFixed(2), ecarts.total.manqueAGagner.toFixed(2)],
        ];
        
        // Feuille 3 : √âcarts par bar
        const barHeader = ['Bar', 'Type', 'F√ªts', 'Vol. sorti (L)', 'Vol. vendu (L)', '√âcart (L)', 'Taux perte (%)', 'CA (‚Ç¨)', 'CA/f√ªt (‚Ç¨)'];
        const barsData = [
          ['√âCARTS PAR BAR'],
          [],
          barHeader,
          ...ecartsParBar.map(bar => [
            bar.barNom,
            bar.type,
            bar.futsVides,
            bar.volumeSorti,
            bar.volumeVendu.toFixed(1),
            bar.ecartVolume.toFixed(1),
            bar.tauxPerte.toFixed(1),
            bar.caDeclare.toFixed(2),
            bar.ratioParFut.toFixed(2)
          ])
        ];
        
        // Feuille 4 : Ventes par cr√©neau
        const creneauHeader = ['Cr√©neau', 'Pintes', 'Pichets', 'Gobelets', 'CA d√©clar√© (‚Ç¨)', 'CA th√©orique (‚Ç¨)', '√âcart (‚Ç¨)'];
        const creneauxData = [
          ['VENTES PAR CR√âNEAU'],
          [],
          creneauHeader,
          ...ecartsParCreneau.map(c => [
            c.creneauLabel,
            c.pintes,
            c.pichets,
            c.gobelets,
            c.caDeclare.toFixed(2),
            c.caTheorique.toFixed(2),
            c.ecartCa.toFixed(2)
          ])
        ];
        
        // Feuille 5 : Comparatif festival
        const comparatifHeader = ['', ...comparatif.jours.map(j => `J${j.jour}`)];
        const comparatifData = [
          ['COMPARATIF FESTIVAL'],
          [],
          comparatifHeader,
          ['CA (‚Ç¨)', ...comparatif.jours.map(j => j.hasDonnees ? j.ca.toFixed(2) : '-')],
          ['F√ªts bi√®re', ...comparatif.jours.map(j => j.hasDonnees ? j.futsBiere : '-')],
          ['F√ªts cidre', ...comparatif.jours.map(j => j.hasDonnees ? j.futsCidre : '-')],
          ['Taux perte (%)', ...comparatif.jours.map(j => j.hasDonnees ? j.tauxPerte.toFixed(1) : '-')],
          ['Top bar', ...comparatif.jours.map(j => j.hasDonnees ? j.topBar : '-')],
          [],
          ['TOTAUX'],
          ['CA Total', comparatif.caTotal.toFixed(2) + ' ‚Ç¨'],
          ['F√ªts Total', comparatif.futsTotal],
        ];
        
        // Feuille 6 : Historique des ventes
        const ventesHeader = ['Date/Heure', 'Bar', 'Cr√©neau', 'Pintes', 'Pichets', 'Gobelets', 'Montant (‚Ç¨)', '√âquip. d√©faillant', 'Commentaire'];
        const ventesJour = historiqueVentes.filter(v => !v.annule && v.jour === jourActuel);
        const ventesData = [
          ['HISTORIQUE DES VENTES - JOUR ' + jourActuel],
          [],
          ventesHeader,
          ...ventesJour.map(v => [
            new Date(v.timestamp).toLocaleString('fr-FR'),
            v.barNom || '-',
            creneaux.find(c => c.id === v.creneau)?.label || '-',
            v.nbPintes || 0,
            v.nbPichets || 0,
            v.nbGobelets || 0,
            (v.montant || 0).toFixed(2),
            v.equipementDefaillant ? 'Oui' : 'Non',
            v.commentaire || ''
          ])
        ];
        
        // Cr√©er le workbook
        const wb = XLSX.utils.book_new();
        
        const ws1 = XLSX.utils.aoa_to_sheet(resumeData);
        const ws2 = XLSX.utils.aoa_to_sheet(ecartsData);
        const ws3 = XLSX.utils.aoa_to_sheet(barsData);
        const ws4 = XLSX.utils.aoa_to_sheet(creneauxData);
        const ws5 = XLSX.utils.aoa_to_sheet(comparatifData);
        const ws6 = XLSX.utils.aoa_to_sheet(ventesData);
        
        XLSX.utils.book_append_sheet(wb, ws1, 'R√©sum√©');
        XLSX.utils.book_append_sheet(wb, ws2, 'Analyse √âcarts');
        XLSX.utils.book_append_sheet(wb, ws3, '√âcarts par Bar');
        XLSX.utils.book_append_sheet(wb, ws4, 'Ventes par Cr√©neau');
        XLSX.utils.book_append_sheet(wb, ws5, 'Comparatif Festival');
        XLSX.utils.book_append_sheet(wb, ws6, 'Historique Ventes');
        
        // T√©l√©charger
        XLSX.writeFile(wb, `Hellfest_J${jourActuel}_${new Date().toISOString().split('T')[0]}.xlsx`);
        showToast('üìä Excel export√©');
      };

      // ==================== RENDER ====================
      if (!session) {
        return <SessionScreen onJoinSession={handleJoinSession} />;
      }

      return (
        <div className="min-h-screen bg-black text-white">
          {/* Toast Notification */}
          {toast && (
            <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-3 rounded-xl shadow-lg animate-pulse ${
              toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'
            }`}>
              <p className="font-medium text-white">{toast.message}</p>
            </div>
          )}

          {/* Banni√®re Annonces */}
          {annonces.length > 0 && (
            <div className="bg-blue-900 border-b border-blue-700">
              {annonces.slice(0, 1).map(annonce => (
                <div key={annonce.id} className="px-4 py-2 flex items-center justify-between">
                  <div className="flex items-center gap-2 flex-1">
                    <span className="text-xl">üì¢</span>
                    <div className="flex-1">
                      <p className="text-sm font-medium">{annonce.message}</p>
                      <p className="text-xs text-blue-300">{annonce.user} ‚Ä¢ {new Date(annonce.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</p>
                    </div>
                  </div>
                  {isCreator && (
                    <button onClick={() => supprimerAnnonce(annonce.id)} className="text-blue-300 hover:text-white px-2">‚úï</button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Indicateur Mode Hors-ligne */}
          {(!isOnline || offlineQueue.length > 0) && (
            <div className={`px-4 py-2 text-center text-sm ${!isOnline ? 'bg-red-900' : 'bg-amber-900'}`}>
              {!isOnline ? (
                <span>‚ö†Ô∏è Mode hors-ligne - Les actions seront synchronis√©es au retour du r√©seau</span>
              ) : (
                <span>‚è≥ Synchronisation de {offlineQueue.length} action(s) en attente...</span>
              )}
            </div>
          )}

          {/* Header */}
          <div className="bg-neutral-900 border-b border-red-900 p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <img src="logo-hellfest.png" alt="Hellfest" className="w-10 h-10" />
                <div>
                  <h1 className="font-bold text-green-400">HELLFEST 2026</h1>
                  <p className="text-xs text-neutral-400">Gestion des F√ªts</p>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`} />
                <button onClick={() => setShowSessionInfo(true)} className="text-xs bg-neutral-800 px-2 py-1 rounded">
                  {session}
                </button>
              </div>
            </div>

            {/* Jour selector + Admin */}
            <div className="flex items-center justify-between gap-2 mb-3">
              <div className={`flex items-center gap-2 px-3 py-2 rounded-lg ${isAdmin ? 'bg-red-900' : 'bg-neutral-800'}`}>
                <span className="text-sm">Jour</span>
                <button 
                  onClick={() => demanderAccesAdmin('jour_prev')}
                  disabled={isAdmin && jourActuel <= 1}
                  className="w-8 h-8 bg-neutral-700 rounded disabled:opacity-50"
                >‚óÄ</button>
                <span className="text-xl font-bold w-8 text-center">{jourActuel}</span>
                <button 
                  onClick={() => demanderAccesAdmin('jour_next')}
                  disabled={isAdmin && jourActuel >= config.nombreJours}
                  className="w-8 h-8 bg-neutral-700 rounded disabled:opacity-50"
                >‚ñ∂</button>
                <span className="text-xs text-neutral-400">/{config.nombreJours}</span>
              </div>
              
              <button 
                onClick={() => isAdmin ? setIsAdmin(false) : demanderAccesAdmin('parametres')}
                className={`px-3 py-2 rounded-lg text-sm font-medium ${isAdmin ? 'bg-green-600' : 'bg-neutral-800'}`}
              >
                {isAdmin ? 'üîì Admin' : 'üîí Admin'}
              </button>
            </div>

            {/* Action buttons */}
            <div className="flex flex-wrap gap-2">
              <button onClick={ouvrirModalBenevoles} className="flex-1 py-2 bg-indigo-600 rounded-lg text-sm font-medium flex items-center justify-center gap-1">
                üë• B√©n√©voles {nbAffectations > 0 && <span className="bg-white/20 px-1.5 rounded">{nbAffectations}</span>}
              </button>
              <button onClick={() => setShowModalVentes(true)} className="flex-1 py-2 bg-emerald-600 rounded-lg text-sm font-medium">
                üí∞ Ventes
              </button>
              {isAdmin && (
                <>
                  <button onClick={() => setShowDashboard(true)} className="py-2 px-3 bg-amber-600 rounded-lg text-sm font-medium">
                    üìà Stats
                  </button>
                  <button onClick={() => setShowHistoriqueVentes(!showHistoriqueVentes)} className={`py-2 px-3 rounded-lg text-sm ${showHistoriqueVentes ? 'bg-teal-500' : 'bg-teal-700'}`}>
                    üìä {historiqueVentes.length}
                  </button>
                  <button onClick={() => setShowHistorique(!showHistorique)} className={`py-2 px-3 rounded-lg text-sm ${showHistorique ? 'bg-purple-500' : 'bg-purple-700'}`}>
                    üìã {historique.length}
                  </button>
                </>
              )}
              {isCreator && (
                <button onClick={() => setShowAnnonceInput(!showAnnonceInput)} className={`py-2 px-3 rounded-lg text-sm ${showAnnonceInput ? 'bg-blue-500' : 'bg-blue-700'}`}>
                  üì¢
                </button>
              )}
              <button onClick={() => demanderAccesAdmin('export')} className="py-2 px-3 bg-green-700 rounded-lg text-sm">
                üì•
              </button>
              <button onClick={() => demanderAccesAdmin('parametres')} className="py-2 px-3 bg-neutral-700 rounded-lg text-sm">
                ‚öôÔ∏è
              </button>
            </div>

            {/* Champ saisie annonce */}
            {showAnnonceInput && isCreator && (
              <div className="mt-2 flex gap-2">
                <input
                  type="text"
                  value={nouvelleAnnonce}
                  onChange={(e) => setNouvelleAnnonce(e.target.value)}
                  placeholder="Votre message √† tous..."
                  className="flex-1 px-3 py-2 bg-neutral-800 rounded-lg text-sm"
                  onKeyDown={(e) => e.key === 'Enter' && envoyerAnnonce()}
                />
                <button 
                  onClick={envoyerAnnonce} 
                  disabled={!nouvelleAnnonce.trim()}
                  className="px-4 py-2 bg-blue-600 rounded-lg text-sm disabled:opacity-50"
                >
                  üì¢ Envoyer
                </button>
              </div>
            )}
          </div>

          {/* Stocks */}
          <div className={`grid ${isAdmin ? 'grid-cols-5' : 'grid-cols-3'} gap-1 p-2 bg-neutral-900`}>
            {isAdmin && (
              <div className="bg-amber-900/50 p-2 rounded text-center">
                <div className="text-lg font-bold text-amber-400">{stockBiere}</div>
                <div className="text-xs text-amber-200">üç∫ Bi√®re</div>
              </div>
            )}
            {isAdmin && (
              <div className="bg-orange-900/50 p-2 rounded text-center">
                <div className="text-lg font-bold text-orange-400">{stockCidre}</div>
                <div className="text-xs text-orange-200">üçé Cidre</div>
              </div>
            )}
            <div className="bg-blue-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-blue-400">{stockVides}</div>
              <div className="text-xs text-blue-200">Vides</div>
            </div>
            <div className="bg-red-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-red-400">{stockCasse}</div>
              <div className="text-xs text-red-200">Cass√©</div>
            </div>
            <div className="bg-purple-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-purple-400">{stockReutilisables}</div>
              <div className="text-xs text-purple-200">R√©util.</div>
            </div>
          </div>

          {/* F√ªts en attente du jour (info seulement - pas de reprise possible) */}
          {futsEnAttente.filter(f => f.jourOrigine === jourActuel).length > 0 && (
            <div className="mx-2 mt-2 p-3 bg-purple-900/30 rounded-lg border border-purple-700 flex items-center justify-between">
              <span className="text-purple-300">‚ôªÔ∏è F√ªts non termin√©s aujourd'hui</span>
              <span className="text-lg font-bold text-purple-400">{futsEnAttente.filter(f => f.jourOrigine === jourActuel).length}</span>
            </div>
          )}

          {/* F√ªts en attente des jours pr√©c√©dents (√† reprendre en PRIORIT√â) */}
          {futsEnAttente.filter(f => f.jourOrigine < jourActuel).length > 0 && (
            <div className="mx-2 mt-2 bg-purple-900/50 rounded-xl border-2 border-purple-500 overflow-hidden">
              <div className="bg-purple-800 px-3 py-2">
                <span className="font-bold text-purple-100">‚ö†Ô∏è F√ªts √† reprendre en PRIORIT√â ({futsEnAttente.filter(f => f.jourOrigine < jourActuel).length})</span>
              </div>
              <div className="p-2 space-y-2">
                {futsEnAttente.filter(f => f.jourOrigine < jourActuel).map(fut => (
                  <div key={fut.id} className="bg-purple-900/30 rounded-lg p-3 flex items-center justify-between">
                    <div>
                      <span className="font-medium">{fut.typeFut === 'biere' ? 'üç∫' : 'üçé'} Non termin√© du J{fut.jourOrigine}</span>
                      <p className="text-xs text-purple-300">Venant de : {fut.barNom}</p>
                    </div>
                    <select 
                      onChange={(e) => {
                        if (e.target.value) {
                          reprendreFutEnAttente(fut.id, e.target.value);
                          e.target.value = '';
                        }
                      }}
                      className="px-3 py-2 bg-purple-700 rounded-lg text-sm"
                    >
                      <option value="">Attribuer √†...</option>
                      {barsNomades.filter(b => b.type === fut.typeFut && (b.futs?.length || 0) < config.maxFutsParBar).map(bar => (
                        <option key={bar.id} value={bar.id}>{bar.nom}</option>
                      ))}
                    </select>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Total ventes */}
          {totalVentes > 0 && (
            <div className="mx-2 mt-2 p-3 bg-emerald-900/50 rounded-lg flex items-center justify-between">
              <span className="text-emerald-300">üí∞ Total Ventes</span>
              <span className="text-xl font-bold text-emerald-400">{totalVentes.toFixed(2)} ‚Ç¨</span>
            </div>
          )}

          {/* Historique Ventes (Admin) */}
          {isAdmin && showHistoriqueVentes && (
            <div className="mx-2 mt-2 bg-teal-900/30 rounded-xl border border-teal-700 overflow-hidden">
              <div className="bg-teal-900/50 px-3 py-2 flex items-center justify-between">
                <span className="font-bold text-teal-300">üìä Historique Ventes ({ventesFiltre.length}/{historiqueVentes.length})</span>
                <button onClick={() => setShowHistoriqueVentes(false)} className="text-teal-400">‚úï</button>
              </div>
              {/* Filtres */}
              <div className="px-3 py-2 bg-teal-900/30 border-b border-teal-800 flex flex-wrap gap-2">
                <select 
                  value={filtreJourVentes} 
                  onChange={(e) => setFiltreJourVentes(e.target.value)}
                  className="px-2 py-1 bg-teal-800 rounded text-sm"
                >
                  <option value="tous">Tous les jours</option>
                  {Array.from({ length: config.nombreJours }, (_, i) => (
                    <option key={i + 1} value={i + 1}>J{i + 1} ({historiqueVentes.filter(v => v.jour === i + 1).length})</option>
                  ))}
                </select>
                <input 
                  type="text"
                  value={rechercheVentes}
                  onChange={(e) => setRechercheVentes(e.target.value)}
                  placeholder="üîç Rechercher..."
                  className="flex-1 px-2 py-1 bg-teal-800 rounded text-sm min-w-[120px]"
                />
              </div>
              <div className="max-h-64 overflow-y-auto">
                {ventesFiltre.length === 0 ? (
                  <p className="text-neutral-500 text-sm text-center py-4">Aucune vente</p>
                ) : (
                  ventesFiltre.map(v => (
                    <div key={v.id} className={`px-3 py-2 border-b border-teal-800 last:border-0 ${v.annule ? 'opacity-50 bg-red-900/20' : ''}`}>
                      <div className="flex items-center justify-between">
                        <span className={`font-medium ${v.annule ? 'line-through text-red-400' : 'text-teal-300'}`}>
                          {(v.montant || 0).toFixed(2)} ‚Ç¨
                        </span>
                        <div className="flex items-center gap-2">
                          <span className={`text-xs px-1.5 py-0.5 rounded ${getBarColor(v.barId)}`}>{v.barNom}</span>
                          {!v.annule && (
                            <button 
                              onClick={() => annulerVente(v.id)}
                              className="text-xs text-red-400 hover:text-red-300 px-1"
                              title="Annuler cette vente"
                            >
                              ‚úï
                            </button>
                          )}
                        </div>
                      </div>
                      <div className="flex items-center justify-between text-xs text-neutral-500">
                        <span className={v.annule ? 'line-through' : ''}>üç∫{v.nbPintes || 0} üç∂{v.nbPichets || 0} ü•§{v.nbGobelets || 0}</span>
                        <span>J{v.jour} ‚Ä¢ {new Date(v.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} ‚Ä¢ {v.user}</span>
                      </div>
                      {v.annule && (
                        <div className="mt-1 text-xs text-red-400">
                          ‚ùå Annul√© par {v.annulePar} le {new Date(v.annuleLe).toLocaleString('fr-FR')}
                        </div>
                      )}
                      {!v.annule && v.equipementDefaillant && (
                        <div className="mt-1 text-xs text-orange-400 bg-orange-900/30 px-2 py-1 rounded">
                          ‚ö†Ô∏è √âquip. d√©faillant{v.numEquipement ? ` - N¬∞${v.numEquipement}` : ''}{v.donneesPartielles ? ' (donn√©es partielles)' : ''}
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* Historique F√ªts (Admin) */}
          {isAdmin && showHistorique && (
            <div className="mx-2 mt-2 bg-purple-900/30 rounded-xl border border-purple-700 overflow-hidden">
              <div className="bg-purple-900/50 px-3 py-2 flex items-center justify-between">
                <span className="font-bold text-purple-300">üìã Historique F√ªts ({historiqueFiltre.length}/{historique.length})</span>
                <button onClick={() => setShowHistorique(false)} className="text-purple-400">‚úï</button>
              </div>
              {/* Filtres */}
              <div className="px-3 py-2 bg-purple-900/30 border-b border-purple-800 flex flex-wrap gap-2">
                <select 
                  value={filtreJourHistorique} 
                  onChange={(e) => setFiltreJourHistorique(e.target.value)}
                  className="px-2 py-1 bg-purple-800 rounded text-sm"
                >
                  <option value="tous">Tous les jours</option>
                  {Array.from({ length: config.nombreJours }, (_, i) => (
                    <option key={i + 1} value={i + 1}>J{i + 1} ({historique.filter(h => h.jour === i + 1).length})</option>
                  ))}
                </select>
                <input 
                  type="text"
                  value={rechercheHistorique}
                  onChange={(e) => setRechercheHistorique(e.target.value)}
                  placeholder="üîç Rechercher..."
                  className="flex-1 px-2 py-1 bg-purple-800 rounded text-sm min-w-[120px]"
                />
              </div>
              <div className="max-h-64 overflow-y-auto">
                {historiqueFiltre.length === 0 ? (
                  <p className="text-neutral-500 text-sm text-center py-4">Aucun mouvement</p>
                ) : (
                  historiqueFiltre.map(h => {
                    const typeLabels = {
                      'SORTIE': { icon: 'üì§', label: 'Sortie', color: 'text-green-400' },
                      'RETOUR_VIDE': { icon: 'üì¶', label: 'Vide', color: 'text-blue-400' },
                      'RETOUR_CASSE': { icon: 'üí•', label: 'Cass√©', color: 'text-red-400' },
                      'RETOUR_REUTILISABLE': { icon: '‚ôªÔ∏è', label: 'Non termin√©', color: 'text-purple-400' },
                      'RETOUR_PLEIN': { icon: 'üîÑ', label: 'Plein (r√©int√©gr√©)', color: 'text-green-400' },
                      'REPRISE': { icon: 'üîÑ', label: 'Reprise', color: 'text-cyan-400' }
                    };
                    const t = typeLabels[h.type] || { icon: '‚Ä¢', label: h.type, color: 'text-neutral-400' };
                    return (
                      <div key={h.id} className={`px-3 py-2 border-b border-purple-800 last:border-0 ${h.annule ? 'opacity-50 bg-red-900/20' : ''}`}>
                        <div className="flex items-center justify-between">
                          <span className={`font-medium ${h.annule ? 'line-through text-red-400' : t.color}`}>{t.icon} {t.label}</span>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs px-1.5 py-0.5 rounded ${getBarColor(h.barId)}`}>{h.barNom}</span>
                            {!h.annule && (
                              <button 
                                onClick={() => annulerMouvementFut(h.id)}
                                className="text-xs text-red-400 hover:text-red-300 px-1"
                                title="Annuler ce mouvement"
                              >
                                ‚úï
                              </button>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center justify-between text-xs text-neutral-500">
                          <span className={h.annule ? 'line-through' : ''}>{h.typeFut === 'biere' ? 'üç∫' : 'üçé'} {h.user}</span>
                          <span>J{h.jour} ‚Ä¢ {new Date(h.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        {h.commentaire && !h.annule && (
                          <div className="mt-1 text-xs text-yellow-400 bg-yellow-900/30 px-2 py-1 rounded">
                            üí¨ {h.commentaire}
                          </div>
                        )}
                        {h.annule && (
                          <div className="mt-1 text-xs text-red-400">
                            ‚ùå Annul√© par {h.annulePar} le {new Date(h.annuleLe).toLocaleString('fr-FR')}
                          </div>
                        )}
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          )}

          {/* Bars */}
          <div className="p-2 space-y-2 pb-24">
            {barsNomades.length === 0 ? (
              <div className="text-center py-8 text-neutral-500">
                <p>Aucun bar nomade configur√©</p>
                <p className="text-sm">Allez dans ‚öôÔ∏è Param√®tres pour en ajouter</p>
              </div>
            ) : (
              barsNomades.map(bar => {
                const isBiere = bar.type === 'biere';
                const barFuts = bar.futs || [];
                const canAdd = barFuts.length < config.maxFutsParBar && (isBiere ? stockBiere > 0 : stockCidre > 0);
                const isFull = barFuts.length >= config.maxFutsParBar;
                const fillPercent = (barFuts.length / config.maxFutsParBar) * 100;
                
                // Couleur de la jauge selon remplissage
                const gaugeColor = isFull ? 'bg-red-500' : barFuts.length >= config.maxFutsParBar - 1 ? 'bg-yellow-500' : 'bg-green-500';

                return (
                  <div key={bar.id} className={`rounded-xl border-2 overflow-hidden ${isFull ? 'border-red-600 bg-red-950/20' : isBiere ? 'border-emerald-600 bg-emerald-950/30' : 'border-teal-600 bg-teal-950/30'}`}>
                    {/* Header avec nom */}
                    <div className={`px-3 py-2 flex items-center justify-between ${isFull ? 'bg-red-900/50' : isBiere ? 'bg-emerald-900/50' : 'bg-teal-900/50'}`}>
                      <div className="flex items-center gap-2">
                        <span className="text-xl">{isBiere ? 'üç∫' : 'üçé'}</span>
                        <span className="font-bold text-lg">{bar.nom}</span>
                      </div>
                      {isFull && (
                        <span className="px-3 py-1 bg-red-600 rounded-full text-xs font-bold">
                          COMPLET
                        </span>
                      )}
                    </div>

                    {/* Section compteur visuel */}
                    <div className="px-3 py-3 border-b border-white/10">
                      {/* Ic√¥nes de f√ªts */}
                      <div className="flex items-center justify-center gap-1 mb-2">
                        {Array.from({ length: config.maxFutsParBar }).map((_, idx) => (
                          <span key={idx} className={`text-2xl ${idx < barFuts.length ? '' : 'opacity-30 grayscale'}`}>
                            üõ¢Ô∏è
                          </span>
                        ))}
                      </div>
                      
                      {/* Compteur en gros */}
                      <div className="text-center">
                        <span className={`text-4xl font-black ${isFull ? 'text-red-400' : barFuts.length > 0 ? 'text-yellow-400' : 'text-green-400'}`}>
                          {barFuts.length}
                        </span>
                        <span className="text-2xl text-neutral-400">/{config.maxFutsParBar}</span>
                        <p className="text-xs text-neutral-500 mt-1">
                          {isFull ? '‚õî Maximum atteint' : barFuts.length === 0 ? '‚úÖ Disponible' : `‚ö†Ô∏è ${config.maxFutsParBar - barFuts.length} place(s) restante(s)`}
                        </p>
                      </div>
                      
                      {/* Jauge de progression */}
                      <div className="mt-2 h-3 bg-neutral-700 rounded-full overflow-hidden">
                        <div 
                          className={`h-full ${gaugeColor} transition-all duration-300`}
                          style={{ width: `${fillPercent}%` }}
                        />
                      </div>
                    </div>

                    {/* Liste des f√ªts */}
                    <div className="p-3 space-y-2">
                      {barFuts.length === 0 ? (
                        <p className="text-neutral-500 text-sm text-center py-2">Aucun f√ªt attribu√©</p>
                      ) : (
                        barFuts.map((fut, idx) => {
                          const durationColor = fut.dateAttribution ? getFutDurationColor(fut.dateAttribution) : 'bg-neutral-700';
                          const dateAttrib = fut.dateAttribution ? new Date(fut.dateAttribution) : null;
                          const dateStr = dateAttrib ? `${dateAttrib.getDate().toString().padStart(2, '0')}/${(dateAttrib.getMonth() + 1).toString().padStart(2, '0')}` : '';
                          const heureStr = dateAttrib ? `${dateAttrib.getHours().toString().padStart(2, '0')}:${dateAttrib.getMinutes().toString().padStart(2, '0')}` : '';
                          return (
                            <div key={fut.id || idx} className={`flex items-center justify-between p-2 rounded-lg ${durationColor}`}>
                              <div className="flex items-center gap-2">
                                <span className="text-sm">{isBiere ? 'üç∫' : 'üçé'} F√ªt {idx + 1}</span>
                                {dateAttrib && (
                                  <span className="text-xs opacity-75">‚Ä¢ {dateStr} {heureStr}</span>
                                )}
                              </div>
                              <button 
                                onClick={() => setShowModalRetour({ barId: bar.id, futIndex: idx, barNom: bar.nom })}
                                className="px-3 py-1 bg-black/30 hover:bg-black/50 rounded text-sm"
                              >
                                ‚Ü©Ô∏è Retour
                              </button>
                            </div>
                          );
                        })
                      )}
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* ==================== MODALS ==================== */}

          {/* Modal Admin */}
          {showModalAdmin && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üîê Acc√®s Admin</h3>
                <input
                  type="password"
                  autoFocus
                  value={adminPassword}
                  onChange={(e) => setAdminPassword(e.target.value)}
                  placeholder="Mot de passe"
                  className="w-full px-4 py-3 bg-neutral-800 rounded-lg mb-4"
                  onKeyDown={(e) => { if (e.key === 'Enter') validerAdmin(); }}
                />
                <div className="flex gap-2">
                  <button 
                    type="button"
                    onClick={() => setShowModalAdmin(false)} 
                    className="flex-1 py-3 bg-neutral-700 rounded-lg"
                  >
                    Annuler
                  </button>
                  <button 
                    type="button"
                    onClick={() => validerAdmin()} 
                    className="flex-1 py-3 bg-red-600 rounded-lg font-medium"
                  >
                    Valider
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Retour F√ªt */}
          {showModalRetour && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">‚Ü©Ô∏è Retour de F√ªt</h3>
                <p className="text-neutral-400 mb-4">{showModalRetour.barNom}</p>
                
                {retourEtape === 'choix' && (
                  <div className="space-y-2">
                    <button 
                      onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_VIDE')} 
                      className="w-full py-3 bg-blue-600 rounded-lg"
                    >
                      üì¶ F√ªt Vide
                    </button>
                    <button 
                      onClick={() => { setRetourType('RETOUR_CASSE'); setRetourEtape('commentaire'); }} 
                      className="w-full py-3 bg-red-600 rounded-lg"
                    >
                      üí• F√ªt Cass√© / Endommag√©
                    </button>
                    <button 
                      onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_REUTILISABLE')} 
                      className="w-full py-3 bg-purple-600 rounded-lg"
                    >
                      ‚ôªÔ∏è Non Termin√© (reprendre demain)
                    </button>
                    <button 
                      onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_PLEIN')} 
                      className="w-full py-3 bg-green-600 rounded-lg"
                    >
                      üîÑ F√ªt Plein (non utilis√©)
                    </button>
                    <button 
                      onClick={() => { setShowModalRetour(null); setRetourEtape('choix'); setRetourType(''); setRetourCommentaire(''); }} 
                      className="w-full py-3 bg-neutral-700 rounded-lg mt-4"
                    >
                      Annuler
                    </button>
                  </div>
                )}

                {retourEtape === 'commentaire' && (
                  <div className="space-y-4">
                    <div className="bg-red-900/30 border border-red-700 rounded-lg p-3">
                      <p className="text-red-400 text-sm">‚ö†Ô∏è Commentaire obligatoire pour un f√ªt cass√©/endommag√©</p>
                    </div>
                    <div>
                      <label className="block text-sm text-neutral-400 mb-1">D√©crivez le probl√®me *</label>
                      <textarea 
                        value={retourCommentaire}
                        onChange={(e) => setRetourCommentaire(e.target.value)}
                        className="w-full px-4 py-2 bg-neutral-800 rounded-lg"
                        rows="3"
                        placeholder="Ex: F√ªt perc√©, valve cass√©e, chute..."
                        autoFocus
                      />
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => { setRetourEtape('choix'); setRetourCommentaire(''); }}
                        className="flex-1 py-3 bg-neutral-700 rounded-lg"
                      >
                        Retour
                      </button>
                      <button 
                        onClick={() => {
                          if (!retourCommentaire.trim()) {
                            alert('Le commentaire est obligatoire pour un f√ªt cass√©');
                            return;
                          }
                          retournerFut(showModalRetour.barId, showModalRetour.futIndex, retourType, retourCommentaire);
                        }}
                        className="flex-1 py-3 bg-red-600 rounded-lg font-medium"
                      >
                        Confirmer
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Modal Ventes */}
          {showModalVentes && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-4">üí∞ Saisie Vente</h3>
                
                {(() => {
                  // Fonction : v√©rifier si un bar a "trait√©" un cr√©neau (au moins une vente enregistr√©e OU verrouill√©)
                  const barATraiteCreneau = (barId, creneauId) => {
                    const key = `J${jourActuel}_${barId}_${creneauId}`;
                    // Verrouill√© = trait√©
                    if (creneauxUtilises[key]) return true;
                    // Ou au moins une vente enregistr√©e pour ce bar/cr√©neau
                    return historiqueVentes.some(v => 
                      !v.annule && v.jour === jourActuel && v.barId === barId && v.creneau === creneauId
                    );
                  };

                  // Fonction : v√©rifier si un bar est verrouill√© (ne peut plus saisir)
                  const barEstVerrouille = (barId, creneauId) => {
                    const key = `J${jourActuel}_${barId}_${creneauId}`;
                    return !!creneauxUtilises[key];
                  };

                  // Fonction : v√©rifier si un bar a des saisies non verrouill√©es (√©quip. d√©faillant)
                  const barPeutResaisir = (barId, creneauId) => {
                    if (barEstVerrouille(barId, creneauId)) return false;
                    // A d√©j√† des ventes mais pas verrouill√© = peut ajouter
                    return historiqueVentes.some(v => 
                      !v.annule && v.jour === jourActuel && v.barId === barId && v.creneau === creneauId
                    );
                  };

                  // Ventes existantes pour un bar/cr√©neau (pour affichage)
                  const getVentesBarCreneau = (barId, creneauId) => {
                    return historiqueVentes.filter(v => 
                      !v.annule && v.jour === jourActuel && v.barId === barId && v.creneau === creneauId
                    );
                  };

                  // D√©terminer le cr√©neau en cours (premier cr√©neau non trait√© par tous)
                  const getCreneauEnCours = () => {
                    for (const creneau of creneaux) {
                      const tousTraites = barsNomades.every(bar => barATraiteCreneau(bar.id, creneau.id));
                      if (!tousTraites) {
                        return creneau;
                      }
                    }
                    return null;
                  };
                  
                  const creneauEnCours = getCreneauEnCours();

                  // Cr√©neaux avec saisies non verrouill√©es (peuvent re-saisir)
                  const creneauxOuverts = [];
                  creneaux.forEach(creneau => {
                    barsNomades.forEach(bar => {
                      if (barPeutResaisir(bar.id, creneau.id)) {
                        const ventes = getVentesBarCreneau(bar.id, creneau.id);
                        creneauxOuverts.push({
                          barId: bar.id,
                          barNom: bar.nom,
                          barType: bar.type,
                          creneauId: creneau.id,
                          creneauLabel: creneau.label,
                          nbVentes: ventes.length,
                          totalMontant: ventes.reduce((sum, v) => sum + (v.montant || 0), 0)
                        });
                      }
                    });
                  });
                  
                  // Bars qui n'ont pas encore trait√© le cr√©neau en cours (peuvent saisir)
                  const barsASaisir = creneauEnCours ? barsNomades.filter(bar => 
                    !barATraiteCreneau(bar.id, creneauEnCours.id)
                  ) : [];
                  
                  // Bars verrouill√©s sur le cr√©neau en cours
                  const barsVerrouilles = creneauEnCours ? barsNomades.filter(bar => 
                    barEstVerrouille(bar.id, creneauEnCours.id)
                  ) : [];

                  // Bars qui peuvent re-saisir sur le cr√©neau en cours
                  const barsResaisie = creneauEnCours ? barsNomades.filter(bar => 
                    barPeutResaisir(bar.id, creneauEnCours.id)
                  ) : [];
                  
                  return (
                    <div className="space-y-4">
                      {/* Alerte : cr√©neaux ouverts (peuvent re-saisir ou cl√¥turer) */}
                      {creneauxOuverts.length > 0 && (
                        <div className="bg-orange-900/30 border border-orange-600 rounded-xl p-3">
                          <p className="text-xs text-orange-400 font-bold mb-2">
                            ‚ö†Ô∏è {creneauxOuverts.length} bar/cr√©neau(x) avec saisie(s) partielle(s) :
                          </p>
                          <div className="space-y-2 max-h-32 overflow-y-auto">
                            {creneauxOuverts.map((c, idx) => (
                              <div key={idx} className="flex items-center justify-between text-xs bg-neutral-800 rounded p-2">
                                <div>
                                  <span className="text-orange-300">{c.barType === 'biere' ? 'üç∫' : 'üçé'} {c.barNom}</span>
                                  <span className="text-neutral-400"> - {c.creneauLabel}</span>
                                  <span className="text-neutral-500 ml-2">({c.nbVentes} saisie(s), {c.totalMontant.toFixed(2)}‚Ç¨)</span>
                                </div>
                                <button 
                                  onClick={async () => {
                                    const key = `J${jourActuel}_${c.barId}_${c.creneauId}`;
                                    await database.ref(`sessions/${session}/creneauxUtilises/${key}`).set({
                                      barId: c.barId,
                                      creneau: c.creneauId,
                                      jour: jourActuel,
                                      timestamp: Date.now(),
                                      user: userName
                                    });
                                    showToast(`‚úÖ Cr√©neau ${c.creneauLabel} cl√¥tur√© pour ${c.barNom}`);
                                  }}
                                  className="px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-xs"
                                  title="Cl√¥turer ce cr√©neau"
                                >
                                  üîí Cl√¥turer
                                </button>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Affichage du cr√©neau en cours */}
                      {creneauEnCours ? (
                        <div className="bg-blue-900/30 border border-blue-600 rounded-xl p-3 text-center">
                          <p className="text-xs text-neutral-400">Cr√©neau en cours :</p>
                          <p className="text-2xl font-bold text-blue-400">{creneauEnCours.label}</p>
                          <p className="text-xs text-neutral-500 mt-1">
                            {barsASaisir.length} bar(s) √† saisir
                            {barsResaisie.length > 0 && ` ‚Ä¢ ${barsResaisie.length} en saisie partielle`}
                          </p>
                        </div>
                      ) : (
                        <div className="bg-green-900/30 border border-green-600 rounded-xl p-4 text-center">
                          <p className="text-3xl mb-2">üéâ</p>
                          <p className="text-green-400 font-bold">Tous les cr√©neaux sont trait√©s !</p>
                          {creneauxOuverts.length > 0 && (
                            <p className="text-xs text-orange-400 mt-1">
                              ‚ö†Ô∏è {creneauxOuverts.length} cr√©neau(x) avec saisies partielles √† cl√¥turer
                            </p>
                          )}
                        </div>
                      )}
                      
                      {creneauEnCours && (
                        <>
                          <div>
                            <label className="block text-sm text-neutral-400 mb-1">Bar <span className="text-red-400">*</span></label>
                            <select 
                              value={venteBarId} 
                              onChange={(e) => { 
                                const barId = e.target.value;
                                setVenteBarId(barId);
                                setVenteCreneau(barId ? creneauEnCours.id : '');
                              }}
                              className="w-full px-4 py-3 bg-neutral-800 rounded-lg"
                            >
                              <option value="">S√©lectionner...</option>
                              {barsNomades.map(bar => {
                                const verrouille = barEstVerrouille(bar.id, creneauEnCours.id);
                                const peutResaisir = barPeutResaisir(bar.id, creneauEnCours.id);
                                const ventesExistantes = getVentesBarCreneau(bar.id, creneauEnCours.id);
                                
                                let statut = '';
                                let disabled = false;
                                
                                if (verrouille) {
                                  statut = '‚úÖ Cl√¥tur√©';
                                  disabled = true;
                                } else if (peutResaisir) {
                                  statut = `‚ö†Ô∏è ${ventesExistantes.length} saisie(s) - Peut ajouter`;
                                }
                                
                                return (
                                  <option 
                                    key={bar.id} 
                                    value={bar.id}
                                    disabled={disabled}
                                  >
                                    {bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.nom} {statut}
                                  </option>
                                );
                              })}
                            </select>
                          </div>
                          
                          {/* Statut des bars */}
                          <div className="bg-neutral-800 rounded-lg p-3 space-y-2">
                            {barsVerrouilles.length > 0 && (
                              <div>
                                <p className="text-xs text-neutral-400 mb-1">‚úÖ Cl√¥tur√©s :</p>
                                <div className="flex flex-wrap gap-1">
                                  {barsVerrouilles.map(bar => (
                                    <span key={bar.id} className="px-2 py-0.5 bg-green-900/50 text-green-400 rounded text-xs">
                                      {bar.nom}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                            {barsResaisie.length > 0 && (
                              <div>
                                <p className="text-xs text-neutral-400 mb-1">‚ö†Ô∏è Saisie partielle (peuvent ajouter) :</p>
                                <div className="flex flex-wrap gap-1">
                                  {barsResaisie.map(bar => (
                                    <span key={bar.id} className="px-2 py-0.5 bg-orange-900/50 text-orange-400 rounded text-xs">
                                      {bar.nom}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                            {barsASaisir.length > 0 && (
                              <div>
                                <p className="text-xs text-neutral-400 mb-1">‚è≥ √Ä saisir :</p>
                                <div className="flex flex-wrap gap-1">
                                  {barsASaisir.map(bar => (
                                    <span key={bar.id} className="px-2 py-0.5 bg-neutral-700 text-neutral-300 rounded text-xs">
                                      {bar.nom}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        </>
                      )}

                      {venteBarId && venteCreneau && (
                        <>
                          <div>
                            <label className="block text-sm text-neutral-400 mb-1">Montant (‚Ç¨) <span className="text-red-400">*</span></label>
                            <input type="number" step="0.01" value={venteMontant} onChange={(e) => setVenteMontant(e.target.value)} className="w-full px-4 py-3 bg-neutral-800 rounded-lg text-xl" placeholder="0.00" />
                          </div>

                          <div className="grid grid-cols-3 gap-2">
                            <div>
                              <label className="block text-sm text-neutral-400 mb-1">Pintes <span className="text-red-400">*</span></label>
                              <input type="number" min="0" value={venteNbPintes} onChange={(e) => setVenteNbPintes(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" placeholder="0" />
                            </div>
                            <div>
                              <label className="block text-sm text-neutral-400 mb-1">Pichets <span className="text-red-400">*</span></label>
                              <input type="number" min="0" value={venteNbPichets} onChange={(e) => setVenteNbPichets(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" placeholder="0" />
                            </div>
                            <div>
                              <label className="block text-sm text-neutral-400 mb-1">Gobelets <span className="text-red-400">*</span></label>
                              <input type="number" min="0" value={venteNbGobelets} onChange={(e) => setVenteNbGobelets(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" placeholder="0" />
                            </div>
                          </div>
                          <p className="text-xs text-neutral-500">Mettez 0 si aucune vente pour ce type</p>

                          {/* √âquipement d√©faillant */}
                          <div className="flex items-center gap-3 mt-2">
                            <input 
                              type="checkbox" 
                              checked={venteEquipDefaillant} 
                              onChange={(e) => setVenteEquipDefaillant(e.target.checked)}
                              className="w-5 h-5 rounded accent-orange-500"
                            />
                            <span className="text-orange-400 font-medium">‚ö†Ô∏è √âquipement d√©faillant</span>
                          </div>

                          {venteEquipDefaillant && (
                            <div className="bg-neutral-800 rounded-lg p-4 space-y-3 border border-orange-500/30">
                              <p className="text-xs text-orange-300">‚ö†Ô∏è Ce cr√©neau restera disponible pour une nouvelle saisie</p>
                              <input 
                                type="text" 
                                value={venteNumEquipement} 
                                onChange={(e) => setVenteNumEquipement(e.target.value)}
                                placeholder="N¬∞ √©quipement"
                                className="w-full px-4 py-2 bg-neutral-700 rounded-lg"
                              />
                              <div className="flex items-center gap-3">
                                <input 
                                  type="checkbox" 
                                  checked={venteDonneesPartielles} 
                                  onChange={(e) => setVenteDonneesPartielles(e.target.checked)}
                                  className="w-4 h-4 rounded"
                                />
                                <span className="text-orange-400 text-sm">Donn√©es partielles</span>
                              </div>
                              <textarea 
                                value={venteCommentaire} 
                                onChange={(e) => setVenteCommentaire(e.target.value)} 
                                placeholder="Commentaire..."
                                className="w-full px-4 py-2 bg-neutral-700 rounded-lg" 
                                rows="2" 
                              />
                            </div>
                          )}

                          {!venteEquipDefaillant && (
                            <div>
                              <label className="block text-sm text-neutral-400 mb-1">Commentaire</label>
                              <textarea value={venteCommentaire} onChange={(e) => setVenteCommentaire(e.target.value)} className="w-full px-4 py-2 bg-neutral-800 rounded-lg" rows="2" />
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  );
                })()}

                <div className="flex gap-2 mt-6">
                  <button onClick={() => { setShowModalVentes(false); setVenteBarId(''); setVenteCreneau(''); }} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button 
                    onClick={enregistrerVente} 
                    disabled={isLoading || !venteBarId || !venteCreneau}
                    className="flex-1 py-3 bg-emerald-600 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isLoading ? '‚è≥ En cours...' : '‚úì Enregistrer'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Param√®tres */}
          {showParametres && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-4">‚öôÔ∏è Param√®tres</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Stock initial Bi√®re</label>
                    <input type="number" defaultValue={config.stockInitialBiere} id="stockBiere" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Stock initial Cidre</label>
                    <input type="number" defaultValue={config.stockInitialCidre} id="stockCidre" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Max f√ªts par bar</label>
                    <input type="number" defaultValue={config.maxFutsParBar} id="maxFuts" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Nombre de jours</label>
                    <input type="number" defaultValue={config.nombreJours} id="nbJours" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>

                  <hr className="border-neutral-700" />

                  <div>
                    <h4 className="font-bold mb-2">Bars Nomades</h4>
                    <div className="space-y-2 mb-4">
                      {barsNomades.map(bar => (
                        <div key={bar.id} className="flex items-center justify-between bg-neutral-800 p-2 rounded">
                          {editingBarId === bar.id ? (
                            <div className="flex items-center gap-2 flex-1">
                              <span>{bar.type === 'biere' ? 'üç∫' : 'üçé'}</span>
                              <input 
                                type="text"
                                value={editingBarNom}
                                onChange={(e) => setEditingBarNom(e.target.value)}
                                className="flex-1 px-2 py-1 bg-neutral-700 rounded text-sm"
                                autoFocus
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    renommerBar(bar.id, editingBarNom);
                                    setEditingBarId(null);
                                  } else if (e.key === 'Escape') {
                                    setEditingBarId(null);
                                  }
                                }}
                              />
                              <button 
                                onClick={() => { renommerBar(bar.id, editingBarNom); setEditingBarId(null); }}
                                className="text-green-400 text-sm px-2"
                              >‚úì</button>
                              <button 
                                onClick={() => setEditingBarId(null)}
                                className="text-neutral-400 text-sm px-2"
                              >‚úï</button>
                            </div>
                          ) : (
                            <>
                              <span>{bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.nom}</span>
                              <div className="flex items-center gap-2">
                                {isCreator && (
                                  <button 
                                    onClick={() => { setEditingBarId(bar.id); setEditingBarNom(bar.nom); }}
                                    className="text-blue-400 text-sm"
                                    title="Renommer"
                                  >‚úèÔ∏è</button>
                                )}
                                <button onClick={() => supprimerBar(bar.id)} className="text-red-400 text-sm">‚úï</button>
                              </div>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2">
                      <input type="text" id="newBarNom" placeholder="Nom du bar" className="flex-1 px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                      <select id="newBarType" className="px-3 py-2 bg-neutral-800 rounded-lg text-sm">
                        <option value="biere">üç∫ Bi√®re</option>
                        <option value="cidre">üçé Cidre</option>
                      </select>
                      <button onClick={() => {
                        const nom = document.getElementById('newBarNom').value;
                        const type = document.getElementById('newBarType').value;
                        if (nom) {
                          ajouterBar(nom, type);
                          document.getElementById('newBarNom').value = '';
                        }
                      }} className="px-4 py-2 bg-red-600 rounded-lg text-sm">+</button>
                    </div>
                  </div>

                  {isCreator && (
                    <>
                      <hr className="border-neutral-700" />
                      <div>
                        <h4 className="font-bold mb-2">üìß Email bilan automatique</h4>
                        <p className="text-xs text-neutral-400 mb-2">Recevez le bilan PDF √† 00h30 chaque jour</p>
                        <input 
                          type="email" 
                          id="adminEmailInput"
                          defaultValue={adminEmail} 
                          placeholder="email@exemple.com" 
                          className="w-full px-4 py-2 bg-neutral-800 rounded-lg text-sm" 
                        />
                        <p className="text-xs text-neutral-500 mt-2">
                          üí° √Ä 00h30, le PDF sera g√©n√©r√© et votre client mail s'ouvrira avec le bilan en lien.
                        </p>
                      </div>
                      
                      <hr className="border-neutral-700" />
                      <div>
                        <h4 className="font-bold mb-3">üí∞ Tarifs</h4>
                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Prix pinte (‚Ç¨)</label>
                            <input type="number" step="0.5" id="prixPinte" defaultValue={config.prixPinte} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Prix pichet (‚Ç¨)</label>
                            <input type="number" step="0.5" id="prixPichet" defaultValue={config.prixPichet} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Prix gobelet (‚Ç¨)</label>
                            <input type="number" step="0.5" id="prixGobelet" defaultValue={config.prixGobelet} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                        </div>
                      </div>
                      
                      <hr className="border-neutral-700" />
                      <div>
                        <h4 className="font-bold mb-3">üõ¢Ô∏è Volumes</h4>
                        <div className="grid grid-cols-2 gap-2 mb-3">
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Vol. pinte (L)</label>
                            <input type="number" step="0.1" id="volumePinte" defaultValue={config.volumePinte} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Vol. pichet (L)</label>
                            <input type="number" step="0.1" id="volumePichet" defaultValue={config.volumePichet} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Vol. f√ªt bi√®re (L)</label>
                            <input type="number" step="1" id="volumeFutBiere" defaultValue={config.volumeFutBiere} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                          <div>
                            <label className="block text-xs text-neutral-400 mb-1">Vol. f√ªt cidre (L)</label>
                            <input type="number" step="1" id="volumeFutCidre" defaultValue={config.volumeFutCidre} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          </div>
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">‚ÑπÔ∏è Gobelets = consommable, non comptabilis√© dans les volumes</p>
                      </div>
                      
                      <hr className="border-neutral-700" />
                      <div>
                        <h4 className="font-bold mb-2">üìâ Seuil alerte perte</h4>
                        <div className="flex items-center gap-2">
                          <input type="number" step="1" id="seuilPerte" defaultValue={config.seuilPerte} className="w-20 px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                          <span className="text-neutral-400">%</span>
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">Taux de perte acceptable (mousse, rin√ßage...)</p>
                      </div>
                    </>
                  )}
                </div>

                <div className="flex gap-2 mt-6">
                  <button onClick={() => setShowParametres(false)} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={() => {
                    const newEmail = document.getElementById('adminEmailInput')?.value || '';
                    if (newEmail !== adminEmail) {
                      setAdminEmail(newEmail);
                      database.ref(`sessions/${session}/config/adminEmail`).set(newEmail);
                    }
                    sauvegarderConfig({
                      stockInitialBiere: parseInt(document.getElementById('stockBiere').value) || 50,
                      stockInitialCidre: parseInt(document.getElementById('stockCidre').value) || 20,
                      maxFutsParBar: parseInt(document.getElementById('maxFuts').value) || 3,
                      nombreJours: parseInt(document.getElementById('nbJours').value) || 4,
                      // Tarifs
                      prixPinte: parseFloat(document.getElementById('prixPinte')?.value) || 6,
                      prixPichet: parseFloat(document.getElementById('prixPichet')?.value) || 15,
                      prixGobelet: parseFloat(document.getElementById('prixGobelet')?.value) || 2,
                      // Volumes
                      volumePinte: parseFloat(document.getElementById('volumePinte')?.value) || 0.5,
                      volumePichet: parseFloat(document.getElementById('volumePichet')?.value) || 1.5,
                      volumeFutBiere: parseFloat(document.getElementById('volumeFutBiere')?.value) || 30,
                      volumeFutCidre: parseFloat(document.getElementById('volumeFutCidre')?.value) || 20,
                      // Seuil
                      seuilPerte: parseFloat(document.getElementById('seuilPerte')?.value) || 10
                    });
                  }} className="flex-1 py-3 bg-red-600 rounded-lg font-medium">üíæ Sauvegarder</button>
                </div>

                {isAdmin && (
                  <button 
                    onClick={() => setShowModalReinit(true)} 
                    className="w-full mt-4 py-3 bg-red-900 hover:bg-red-800 rounded-lg font-medium border border-red-600"
                  >
                    üîí R√©initialiser (Admin)
                  </button>
                )}
              </div>
            </div>
          )}

          {/* Modal R√©initialisation */}
          {showModalReinit && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-red-950 rounded-2xl w-full max-w-md p-6 border border-red-700">
                <h3 className="text-xl font-bold mb-4 text-red-400">‚ö†Ô∏è R√©initialisation Admin</h3>
                
                <div className="bg-red-900/50 rounded-lg p-4 mb-4">
                  <p className="font-bold text-yellow-400 mb-2">‚ö†Ô∏è Suppression :</p>
                  <ul className="text-red-300 text-sm space-y-1 ml-4">
                    <li>‚Ä¢ F√ªts attribu√©s</li>
                    <li>‚Ä¢ Historiques f√ªts/ventes</li>
                    <li>‚Ä¢ Affectations b√©n√©voles</li>
                  </ul>
                  <p className="text-green-400 text-sm mt-3">La configuration des bars sera conserv√©e.</p>
                </div>

                <div className="mb-4">
                  <label className="block text-sm text-neutral-400 mb-1">Mot de passe admin</label>
                  <div className="relative">
                    <input 
                      type="password" 
                      value={reinitPassword}
                      onChange={(e) => setReinitPassword(e.target.value)}
                      placeholder="Mot de passe..."
                      className="w-full px-4 py-2 bg-neutral-800 rounded-lg"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <button 
                    onClick={() => reinitialiserDonnees(true)}
                    className="w-full py-3 bg-neutral-700 hover:bg-neutral-600 rounded-lg flex items-center justify-center gap-2"
                  >
                    üì• Exporter puis r√©initialiser
                  </button>
                  <button 
                    onClick={() => reinitialiserDonnees(false)}
                    className="w-full py-3 bg-neutral-700 hover:bg-neutral-600 rounded-lg flex items-center justify-center gap-2"
                  >
                    üóëÔ∏è R√©initialiser sans exporter
                  </button>
                </div>

                <button 
                  onClick={() => { setShowModalReinit(false); setReinitPassword(''); }}
                  className="w-full mt-4 py-3 bg-neutral-800 rounded-lg"
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {/* Modal Export */}
          {showModalExport && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üì• Exporter</h3>
                <div className="space-y-2">
                  <button onClick={() => { exporterHistoriqueFuts(); setShowModalExport(false); }} disabled={historique.length === 0} className="w-full py-3 bg-purple-600 rounded-lg disabled:opacity-50">üìã Historique F√ªts ({historique.length})</button>
                  <button onClick={() => { exporterHistoriqueVentes(); setShowModalExport(false); }} disabled={historiqueVentes.length === 0} className="w-full py-3 bg-emerald-600 rounded-lg disabled:opacity-50">üí∞ Historique Ventes ({historiqueVentes.length})</button>
                  <button onClick={() => { exporterBenevoles(); setShowModalExport(false); }} disabled={nbAffectations === 0} className="w-full py-3 bg-indigo-600 rounded-lg disabled:opacity-50">üë• Planning B√©n√©voles ({nbAffectations})</button>
                  <button onClick={() => setShowModalExport(false)} className="w-full py-3 bg-neutral-700 rounded-lg mt-4">Fermer</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Dashboard Statistiques */}
          {showDashboard && (
            <div className="fixed inset-0 bg-black/90 flex flex-col z-50">
              {/* Header Dashboard */}
              <div className="bg-amber-900 px-4 py-3 flex items-center justify-between">
                <h3 className="text-xl font-bold">üìà Dashboard J{jourActuel}</h3>
                <div className="flex items-center gap-2">
                  {isCreator && (
                    <>
                      <button onClick={exporterBilanExcel} className="px-3 py-1 bg-green-600 rounded-lg text-sm">
                        üìä Excel
                      </button>
                      <button onClick={telechargerBilanPDF} className="px-3 py-1 bg-red-600 rounded-lg text-sm">
                        üìÑ PDF
                      </button>
                    </>
                  )}
                  <button onClick={() => setShowDashboard(false)} className="text-2xl">‚úï</button>
                </div>
              </div>
              
              {/* Onglets */}
              <div className="bg-neutral-800 px-2 py-2 flex gap-1">
                <button 
                  onClick={() => setDashboardOnglet('synthese')}
                  className={`flex-1 py-2 rounded-lg text-xs font-medium ${dashboardOnglet === 'synthese' ? 'bg-amber-600' : 'bg-neutral-700'}`}
                >
                  üìä Synth√®se
                </button>
                <button 
                  onClick={() => setDashboardOnglet('ecarts')}
                  className={`flex-1 py-2 rounded-lg text-xs font-medium ${dashboardOnglet === 'ecarts' ? 'bg-amber-600' : 'bg-neutral-700'}`}
                >
                  üìâ √âcarts
                </button>
                <button 
                  onClick={() => setDashboardOnglet('graphiques')}
                  className={`flex-1 py-2 rounded-lg text-xs font-medium ${dashboardOnglet === 'graphiques' ? 'bg-amber-600' : 'bg-neutral-700'}`}
                >
                  üìà Graphes
                </button>
                <button 
                  onClick={() => setDashboardOnglet('comparatif')}
                  className={`flex-1 py-2 rounded-lg text-xs font-medium ${dashboardOnglet === 'comparatif' ? 'bg-amber-600' : 'bg-neutral-700'}`}
                >
                  üìÖ Jours
                </button>
              </div>
              
              <div className="flex-1 overflow-y-auto p-4">
                {/* ==================== ONGLET SYNTH√àSE ==================== */}
                {dashboardOnglet === 'synthese' && (() => {
                  const stats = getStatistiques();
                  const classement = getClassementBars();
                  const previsions = getPrevisionRupture();
                  const activiteParHeure = getActiviteParHeure();
                  const comparaison = getComparaisonJour();
                  const synthese = getSyntheseTop10();
                  
                  return (
                    <div className="space-y-4 max-w-2xl mx-auto">
                      {/* Top 10 Indicateurs */}
                      <div className="grid grid-cols-2 gap-3">
                        {/* 1. CA total */}
                        <div className="bg-emerald-900/30 p-4 rounded-xl border border-emerald-700">
                          <p className="text-xs text-emerald-300">üí∞ CA Jour</p>
                          <p className="text-3xl font-black text-emerald-400">{synthese.caTotal.toFixed(0)} ‚Ç¨</p>
                        </div>
                        
                        {/* 2. Comparaison J vs J-1 */}
                        {synthese.comparaison ? (
                          <div className={`p-4 rounded-xl border ${synthese.comparaison.tendance === 'hausse' ? 'bg-green-900/30 border-green-700' : 'bg-red-900/30 border-red-700'}`}>
                            <p className="text-xs text-neutral-300">üìà vs J-1</p>
                            <p className={`text-2xl font-black ${synthese.comparaison.tendance === 'hausse' ? 'text-green-400' : 'text-red-400'}`}>
                              {synthese.comparaison.tendance === 'hausse' ? '+' : ''}{synthese.comparaison.ecartVentes.toFixed(0)}‚Ç¨
                            </p>
                            <p className={`text-sm ${synthese.comparaison.tendance === 'hausse' ? 'text-green-400' : 'text-red-400'}`}>
                              {synthese.comparaison.tendance === 'hausse' ? '‚ñ≤' : '‚ñº'} {Math.abs(synthese.comparaison.ecartPourcent)}%
                            </p>
                          </div>
                        ) : (
                          <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700">
                            <p className="text-xs text-neutral-400">üìà vs J-1</p>
                            <p className="text-lg text-neutral-500">J1 - Pas de comparaison</p>
                          </div>
                        )}
                        
                        {/* 3. F√ªts consomm√©s */}
                        <div className="bg-blue-900/30 p-4 rounded-xl border border-blue-700">
                          <p className="text-xs text-blue-300">üõ¢Ô∏è F√ªts consomm√©s</p>
                          <p className="text-3xl font-black text-blue-400">{synthese.futsConsommes}</p>
                          <p className="text-xs text-neutral-400">{synthese.futsBiere}üç∫ + {synthese.futsCidre}üçé</p>
                        </div>
                        
                        {/* 4. Dur√©e moyenne f√ªt */}
                        <div className="bg-purple-900/30 p-4 rounded-xl border border-purple-700">
                          <p className="text-xs text-purple-300">‚è±Ô∏è Dur√©e moy. f√ªt</p>
                          <p className="text-3xl font-black text-purple-400">{synthese.dureeMoyenne}</p>
                        </div>
                        
                        {/* 5. Taux de perte */}
                        <div className={`p-4 rounded-xl border ${
                          synthese.statutPerte === 'ok' ? 'bg-green-900/30 border-green-700' :
                          synthese.statutPerte === 'attention' ? 'bg-yellow-900/30 border-yellow-700' :
                          'bg-red-900/30 border-red-700'
                        }`}>
                          <p className="text-xs text-neutral-300">üìâ Taux perte</p>
                          <p className={`text-3xl font-black ${
                            synthese.statutPerte === 'ok' ? 'text-green-400' :
                            synthese.statutPerte === 'attention' ? 'text-yellow-400' :
                            'text-red-400'
                          }`}>
                            {synthese.tauxPerteGlobal.toFixed(1)}%
                            {synthese.statutPerte === 'ok' ? ' ‚úì' : synthese.statutPerte === 'attention' ? ' ‚ö†Ô∏è' : ' üî¥'}
                          </p>
                          {synthese.manqueAGagner > 0 && (
                            <p className="text-xs text-neutral-400">~{synthese.manqueAGagner.toFixed(0)}‚Ç¨ manque</p>
                          )}
                        </div>
                        
                        {/* 6. Bar le plus rentable */}
                        <div className="bg-amber-900/30 p-4 rounded-xl border border-amber-700">
                          <p className="text-xs text-amber-300">üéØ Meilleur ratio</p>
                          {synthese.barPlusRentable ? (
                            <>
                              <p className="text-lg font-bold text-amber-400">{synthese.barPlusRentable.barNom}</p>
                              <p className="text-xs text-neutral-400">{synthese.barPlusRentable.ratioParFut.toFixed(0)}‚Ç¨/f√ªt</p>
                            </>
                          ) : (
                            <p className="text-neutral-500">-</p>
                          )}
                        </div>
                        
                        {/* 7. Pic d'activit√© */}
                        <div className="bg-orange-900/30 p-4 rounded-xl border border-orange-700">
                          <p className="text-xs text-orange-300">‚ö° Pic activit√©</p>
                          <p className="text-lg font-bold text-orange-400">{synthese.picActivite?.creneauLabel || '-'}</p>
                          <p className="text-xs text-neutral-400">{synthese.picActivite?.caDeclare?.toFixed(0) || 0}‚Ç¨</p>
                        </div>
                        
                        {/* 8. Stock restant */}
                        <div className="bg-teal-900/30 p-4 rounded-xl border border-teal-700">
                          <p className="text-xs text-teal-300">üì¶ Stock restant</p>
                          <p className="text-2xl font-black text-teal-400">{stockBiere}üç∫ {stockCidre}üçé</p>
                        </div>
                      </div>
                      
                      {/* 9. Classement bars */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üèÜ Classement bars par CA</h4>
                        <div className="space-y-2">
                          {synthese.classementBars.slice(0, 5).map((bar, idx) => (
                            <div key={bar.barId} className="flex items-center gap-3 bg-neutral-700/50 p-2 rounded-lg">
                              <span className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${
                                idx === 0 ? 'bg-amber-500 text-black' : idx === 1 ? 'bg-neutral-400 text-black' : idx === 2 ? 'bg-amber-700' : 'bg-neutral-600'
                              }`}>
                                {idx + 1}
                              </span>
                              <div className="flex-1">
                                <p className="font-medium">{bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.barNom}</p>
                                <p className="text-xs text-neutral-400">{bar.futsVides} f√ªts ‚Ä¢ {bar.ratioParFut.toFixed(0)}‚Ç¨/f√ªt</p>
                              </div>
                              <div className="text-right">
                                <p className="font-bold text-emerald-400">{bar.caDeclare.toFixed(0)} ‚Ç¨</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* 10. Progression festival */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üìà Progression festival</h4>
                        <div className="space-y-2">
                          {synthese.progressionFestival.map((j, idx) => {
                            const maxCa = Math.max(...synthese.progressionFestival.map(x => x.ca), 1);
                            const pct = (j.ca / maxCa) * 100;
                            const progression = idx > 0 && synthese.progressionFestival[idx-1].ca > 0 
                              ? ((j.ca - synthese.progressionFestival[idx-1].ca) / synthese.progressionFestival[idx-1].ca * 100).toFixed(0)
                              : null;
                            return (
                              <div key={j.jour} className="flex items-center gap-3">
                                <span className={`w-8 font-bold ${j.jour === jourActuel ? 'text-amber-400' : 'text-neutral-400'}`}>J{j.jour}</span>
                                <div className="flex-1 bg-neutral-700 rounded-full h-6 overflow-hidden">
                                  <div 
                                    className={`h-full ${j.jour === jourActuel ? 'bg-amber-500' : 'bg-emerald-600'}`}
                                    style={{ width: `${pct}%` }}
                                  />
                                </div>
                                <div className="w-28 text-right text-sm">
                                  <span className="font-medium">{j.ca.toFixed(0)} ‚Ç¨</span>
                                  {progression && (
                                    <span className={`ml-1 text-xs ${parseInt(progression) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                      {parseInt(progression) >= 0 ? '+' : ''}{progression}%
                                    </span>
                                  )}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Graphique activit√© par heure */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üìä Activit√© par heure</h4>
                        <div className="space-y-1">
                          {activiteParHeure.map(h => {
                            const maxActivite = Math.max(...activiteParHeure.map(x => x.sorties + x.retours), 1);
                            return (
                              <div key={h.heure} className="flex items-center gap-2 text-xs">
                                <span className="w-12 text-neutral-400">{h.heureAffichage}h</span>
                                <div className="flex-1 flex h-4 bg-neutral-700 rounded overflow-hidden">
                                  <div className="bg-green-500" style={{ width: `${(h.sorties / maxActivite) * 100}%` }} />
                                  <div className="bg-blue-500" style={{ width: `${(h.retours / maxActivite) * 100}%` }} />
                                </div>
                                <span className="w-16 text-right">
                                  <span className="text-green-400">+{h.sorties}</span>
                                  <span className="text-blue-400 ml-1">-{h.retours}</span>
                                </span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Pr√©visions rupture */}
                      <div className="bg-gradient-to-r from-amber-900/30 to-orange-900/30 p-4 rounded-xl border border-amber-700">
                        <h4 className="font-bold mb-3">‚è±Ô∏è Pr√©vision rupture stock</h4>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <p className="text-sm text-amber-300">üç∫ Bi√®re ({stockBiere})</p>
                            <p className="text-xl font-bold text-amber-400">{previsions.biere.tempsRestant || '-'}</p>
                            <p className="text-xs text-neutral-500">{previsions.biere.rythme} f√ªts/h</p>
                          </div>
                          <div>
                            <p className="text-sm text-orange-300">üçé Cidre ({stockCidre})</p>
                            <p className="text-xl font-bold text-orange-400">{previsions.cidre.tempsRestant || '-'}</p>
                            <p className="text-xs text-neutral-500">{previsions.cidre.rythme} f√ªts/h</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })()}
                
                {/* ==================== ONGLET √âCARTS ==================== */}
                {dashboardOnglet === 'ecarts' && (() => {
                  const ecarts = getAnalyseEcarts();
                  const ecartsParBar = getAnalyseEcartsParBar();
                  const ecartsParCreneau = getAnalyseEcartsParCreneau();
                  
                  const getStatutIcon = (statut) => {
                    if (statut === 'ok') return '‚úÖ';
                    if (statut === 'attention') return '‚ö†Ô∏è';
                    return 'üî¥';
                  };
                  
                  const getStatutColor = (statut) => {
                    if (statut === 'ok') return 'text-green-400';
                    if (statut === 'attention') return 'text-yellow-400';
                    return 'text-red-400';
                  };
                  
                  return (
                    <div className="space-y-4 max-w-2xl mx-auto">
                      {/* R√©sum√© global */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">üìâ Analyse des √©carts - J{jourActuel}</h4>
                        
                        {/* Tableau principal */}
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-neutral-600">
                                <th className="text-left py-2"></th>
                                <th className="text-right py-2 px-2">üç∫ Bi√®re</th>
                                <th className="text-right py-2 px-2">üçé Cidre</th>
                                <th className="text-right py-2 px-2">Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">F√ªts vides</td>
                                <td className="text-right px-2">{ecarts.biere.futsVides}</td>
                                <td className="text-right px-2">{ecarts.cidre.futsVides}</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.futsVides}</td>
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">Volume sorti</td>
                                <td className="text-right px-2">{ecarts.biere.volumeSorti} L</td>
                                <td className="text-right px-2">{ecarts.cidre.volumeSorti} L</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.volumeSorti} L</td>
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">Pintes vendues</td>
                                <td className="text-right px-2">{ecarts.biere.pintes}</td>
                                <td className="text-right px-2">{ecarts.cidre.pintes}</td>
                                <td className="text-right px-2">{ecarts.biere.pintes + ecarts.cidre.pintes}</td>
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">Pichets vendus</td>
                                <td className="text-right px-2">{ecarts.biere.pichets}</td>
                                <td className="text-right px-2">{ecarts.cidre.pichets}</td>
                                <td className="text-right px-2">{ecarts.biere.pichets + ecarts.cidre.pichets}</td>
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">Volume vendu</td>
                                <td className="text-right px-2">{ecarts.biere.volumeVendu.toFixed(1)} L</td>
                                <td className="text-right px-2">{ecarts.cidre.volumeVendu.toFixed(1)} L</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.volumeVendu.toFixed(1)} L</td>
                              </tr>
                              <tr className="border-b border-neutral-700 bg-neutral-700/30">
                                <td className="py-2 font-bold">√âcart volume</td>
                                <td className="text-right px-2 font-bold">{ecarts.biere.ecartVolume.toFixed(1)} L</td>
                                <td className="text-right px-2 font-bold">{ecarts.cidre.ecartVolume.toFixed(1)} L</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.ecartVolume.toFixed(1)} L</td>
                              </tr>
                              <tr className="border-b border-neutral-700 bg-neutral-700/30">
                                <td className="py-2 font-bold">Taux perte</td>
                                <td className={`text-right px-2 font-bold ${getStatutColor(ecarts.biere.statutPerte)}`}>
                                  {ecarts.biere.tauxPerte.toFixed(1)}% {getStatutIcon(ecarts.biere.statutPerte)}
                                </td>
                                <td className={`text-right px-2 font-bold ${getStatutColor(ecarts.cidre.statutPerte)}`}>
                                  {ecarts.cidre.tauxPerte.toFixed(1)}% {getStatutIcon(ecarts.cidre.statutPerte)}
                                </td>
                                <td className={`text-right px-2 font-bold ${getStatutColor(ecarts.total.statutPerte)}`}>
                                  {ecarts.total.tauxPerte.toFixed(1)}% {getStatutIcon(ecarts.total.statutPerte)}
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        
                        {ecarts.total.manqueAGagner > 0 && (
                          <div className="mt-3 p-3 bg-red-900/30 rounded-lg border border-red-700">
                            <p className="text-sm text-red-300">
                              üí∏ Manque √† gagner estim√© : <span className="font-bold">~{ecarts.total.manqueAGagner.toFixed(0)} ‚Ç¨</span>
                            </p>
                          </div>
                        )}
                      </div>
                      
                      {/* Contr√¥le coh√©rence CA */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">üí∞ Contr√¥le coh√©rence CA</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-neutral-600">
                                <th className="text-left py-2"></th>
                                <th className="text-right py-2 px-2">üç∫ Bi√®re</th>
                                <th className="text-right py-2 px-2">üçé Cidre</th>
                                <th className="text-right py-2 px-2">Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">CA d√©clar√©</td>
                                <td className="text-right px-2">{ecarts.biere.caDeclare.toFixed(2)} ‚Ç¨</td>
                                <td className="text-right px-2">{ecarts.cidre.caDeclare.toFixed(2)} ‚Ç¨</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.caDeclare.toFixed(2)} ‚Ç¨</td>
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">CA th√©orique*</td>
                                <td className="text-right px-2">{ecarts.biere.caTheorique.toFixed(2)} ‚Ç¨</td>
                                <td className="text-right px-2">{ecarts.cidre.caTheorique.toFixed(2)} ‚Ç¨</td>
                                <td className="text-right px-2 font-bold">{ecarts.total.caTheorique.toFixed(2)} ‚Ç¨</td>
                              </tr>
                              <tr className="border-b border-neutral-700 bg-neutral-700/30">
                                <td className="py-2 font-bold">√âcart CA</td>
                                <td className={`text-right px-2 font-bold ${ecarts.biere.ecartCa >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {ecarts.biere.ecartCa >= 0 ? '+' : ''}{ecarts.biere.ecartCa.toFixed(2)} ‚Ç¨
                                </td>
                                <td className={`text-right px-2 font-bold ${ecarts.cidre.ecartCa >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {ecarts.cidre.ecartCa >= 0 ? '+' : ''}{ecarts.cidre.ecartCa.toFixed(2)} ‚Ç¨
                                </td>
                                <td className={`text-right px-2 font-bold ${ecarts.total.ecartCa >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {ecarts.total.ecartCa >= 0 ? '+' : ''}{ecarts.total.ecartCa.toFixed(2)} ‚Ç¨
                                </td>
                              </tr>
                              <tr>
                                <td className="py-2 font-bold">Coh√©rence</td>
                                <td className={`text-right px-2 font-bold ${ecarts.biere.coherenceCa >= 95 ? 'text-green-400' : ecarts.biere.coherenceCa >= 90 ? 'text-yellow-400' : 'text-red-400'}`}>
                                  {ecarts.biere.coherenceCa.toFixed(1)}%
                                </td>
                                <td className={`text-right px-2 font-bold ${ecarts.cidre.coherenceCa >= 95 ? 'text-green-400' : ecarts.cidre.coherenceCa >= 90 ? 'text-yellow-400' : 'text-red-400'}`}>
                                  {ecarts.cidre.coherenceCa.toFixed(1)}%
                                </td>
                                <td className="text-right px-2">-</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <p className="text-xs text-neutral-500 mt-2">* CA th√©orique = (Pintes √ó {config.prixPinte}‚Ç¨) + (Pichets √ó {config.prixPichet}‚Ç¨) + (Gobelets √ó {config.prixGobelet}‚Ç¨)</p>
                      </div>
                      
                      {/* √âcarts par bar */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">üç∫ √âcarts par bar</h4>
                        <div className="space-y-2">
                          {ecartsParBar.map(bar => (
                            <div key={bar.barId} className={`p-3 rounded-lg border ${
                              bar.statutPerte === 'ok' ? 'bg-green-900/20 border-green-700' :
                              bar.statutPerte === 'attention' ? 'bg-yellow-900/20 border-yellow-700' :
                              'bg-red-900/20 border-red-700'
                            }`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="font-bold">{bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.barNom}</p>
                                  <p className="text-xs text-neutral-400">
                                    {bar.futsVides} f√ªts ‚Ä¢ {bar.volumeSorti}L sorti ‚Ä¢ {bar.volumeVendu.toFixed(1)}L vendu
                                  </p>
                                </div>
                                <div className="text-right">
                                  <p className={`text-xl font-bold ${getStatutColor(bar.statutPerte)}`}>
                                    {bar.tauxPerte.toFixed(1)}% {getStatutIcon(bar.statutPerte)}
                                  </p>
                                  <p className="text-xs text-neutral-400">{bar.caDeclare.toFixed(0)}‚Ç¨ CA</p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* √âcarts par cr√©neau */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">‚è±Ô∏è CA par cr√©neau</h4>
                        <div className="space-y-2">
                          {ecartsParCreneau.map(c => (
                            <div key={c.creneauId} className="p-3 bg-neutral-700/50 rounded-lg">
                              <div className="flex items-center justify-between">
                                <div>
                                  <p className="font-bold">{c.creneauLabel}</p>
                                  <p className="text-xs text-neutral-400">
                                    {c.pintes} pintes ‚Ä¢ {c.pichets} pichets ‚Ä¢ {c.gobelets} gobelets
                                  </p>
                                </div>
                                <div className="text-right">
                                  <p className="text-lg font-bold text-emerald-400">{c.caDeclare.toFixed(0)} ‚Ç¨</p>
                                  <p className={`text-xs ${c.ecartCa >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    vs th√©o: {c.ecartCa >= 0 ? '+' : ''}{c.ecartCa.toFixed(0)}‚Ç¨
                                  </p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* L√©gende */}
                      <div className="bg-neutral-800 p-3 rounded-lg">
                        <p className="text-xs text-neutral-400">
                          <span className="text-green-400">‚úÖ OK</span> ‚â§ {config.seuilPerte}% ‚Ä¢ 
                          <span className="text-yellow-400 ml-2">‚ö†Ô∏è Attention</span> {config.seuilPerte}-{(config.seuilPerte * 1.5).toFixed(0)}% ‚Ä¢ 
                          <span className="text-red-400 ml-2">üî¥ Alerte</span> > {(config.seuilPerte * 1.5).toFixed(0)}%
                        </p>
                      </div>
                    </div>
                  );
                })()}
                
                {/* ==================== ONGLET GRAPHIQUES ==================== */}
                {dashboardOnglet === 'graphiques' && (() => {
                  const ecartsParBar = getAnalyseEcartsParBar();
                  const ecartsParCreneau = getAnalyseEcartsParCreneau();
                  const ecarts = getAnalyseEcarts();
                  const comparatif = getComparatifFestival();
                  
                  // Composant Graphique avec useEffect
                  const ChartComponent = ({ type, data, options, id }) => {
                    const canvasRef = useRef(null);
                    const chartRef = useRef(null);
                    
                    useEffect(() => {
                      if (!canvasRef.current) return;
                      
                      // D√©truire l'ancien graphique si existe
                      if (chartRef.current) {
                        chartRef.current.destroy();
                      }
                      
                      // Cr√©er le nouveau graphique
                      chartRef.current = new Chart(canvasRef.current, {
                        type,
                        data,
                        options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                            legend: {
                              labels: { color: '#fff' }
                            }
                          },
                          scales: type !== 'pie' && type !== 'doughnut' ? {
                            x: { ticks: { color: '#aaa' }, grid: { color: '#333' } },
                            y: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
                          } : undefined,
                          ...options
                        }
                      });
                      
                      return () => {
                        if (chartRef.current) {
                          chartRef.current.destroy();
                        }
                      };
                    }, [data]);
                    
                    return <canvas ref={canvasRef} id={id} />;
                  };
                  
                  return (
                    <div className="space-y-4 max-w-2xl mx-auto">
                      {/* Graphique 1: √âvolution CA par cr√©neau */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üìà √âvolution CA par cr√©neau (J{jourActuel})</h4>
                        <div className="h-64">
                          <ChartComponent
                            id="chartCaCreneaux"
                            type="line"
                            data={{
                              labels: ecartsParCreneau.map(c => c.creneauLabel),
                              datasets: [{
                                label: 'CA (‚Ç¨)',
                                data: ecartsParCreneau.map(c => c.caDeclare),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                fill: true,
                                tension: 0.3
                              }]
                            }}
                          />
                        </div>
                      </div>
                      
                      {/* Graphique 2: CA par bar (barres) */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üèÜ CA par bar (J{jourActuel})</h4>
                        <div className="h-64">
                          <ChartComponent
                            id="chartCaBars"
                            type="bar"
                            data={{
                              labels: ecartsParBar.map(b => b.barNom),
                              datasets: [{
                                label: 'CA (‚Ç¨)',
                                data: ecartsParBar.map(b => b.caDeclare),
                                backgroundColor: ecartsParBar.map(b => b.type === 'biere' ? '#f59e0b' : '#22c55e'),
                                borderRadius: 4
                              }]
                            }}
                          />
                        </div>
                        <div className="flex gap-4 mt-2 text-xs text-neutral-400 justify-center">
                          <span><span className="inline-block w-3 h-3 bg-amber-500 rounded mr-1"></span>Bi√®re</span>
                          <span><span className="inline-block w-3 h-3 bg-green-500 rounded mr-1"></span>Cidre</span>
                        </div>
                      </div>
                      
                      {/* Graphique 3: R√©partition Bi√®re/Cidre (camembert) */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">ü•ß R√©partition Bi√®re / Cidre (J{jourActuel})</h4>
                        <div className="h-64">
                          <ChartComponent
                            id="chartRepartition"
                            type="doughnut"
                            data={{
                              labels: ['Bi√®re', 'Cidre'],
                              datasets: [{
                                data: [ecarts.biere.caDeclare, ecarts.cidre.caDeclare],
                                backgroundColor: ['#f59e0b', '#22c55e'],
                                borderColor: ['#d97706', '#16a34a'],
                                borderWidth: 2
                              }]
                            }}
                            options={{
                              plugins: {
                                legend: {
                                  position: 'bottom',
                                  labels: { color: '#fff', padding: 20 }
                                }
                              }
                            }}
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-4 mt-4 text-center">
                          <div className="bg-amber-900/30 p-3 rounded-lg">
                            <p className="text-amber-400 font-bold text-xl">{ecarts.biere.caDeclare.toFixed(0)} ‚Ç¨</p>
                            <p className="text-xs text-neutral-400">Bi√®re ({ecarts.total.caDeclare > 0 ? ((ecarts.biere.caDeclare / ecarts.total.caDeclare) * 100).toFixed(0) : 0}%)</p>
                          </div>
                          <div className="bg-green-900/30 p-3 rounded-lg">
                            <p className="text-green-400 font-bold text-xl">{ecarts.cidre.caDeclare.toFixed(0)} ‚Ç¨</p>
                            <p className="text-xs text-neutral-400">Cidre ({ecarts.total.caDeclare > 0 ? ((ecarts.cidre.caDeclare / ecarts.total.caDeclare) * 100).toFixed(0) : 0}%)</p>
                          </div>
                        </div>
                      </div>
                      
                      {/* Graphique 4: √âvolution CA par jour */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üìÖ √âvolution CA sur le festival</h4>
                        <div className="h-64">
                          <ChartComponent
                            id="chartCaJours"
                            type="bar"
                            data={{
                              labels: comparatif.jours.map(j => `J${j.jour}`),
                              datasets: [{
                                label: 'CA (‚Ç¨)',
                                data: comparatif.jours.map(j => j.ca),
                                backgroundColor: comparatif.jours.map(j => j.jour === jourActuel ? '#f59e0b' : '#6b7280'),
                                borderRadius: 4
                              }]
                            }}
                          />
                        </div>
                      </div>
                      
                      {/* Graphique 5: Taux de perte par bar */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-3">üìâ Taux de perte par bar (J{jourActuel})</h4>
                        <div className="h-64">
                          <ChartComponent
                            id="chartPertesBars"
                            type="bar"
                            data={{
                              labels: ecartsParBar.map(b => b.barNom),
                              datasets: [{
                                label: 'Taux perte (%)',
                                data: ecartsParBar.map(b => b.tauxPerte),
                                backgroundColor: ecartsParBar.map(b => 
                                  b.tauxPerte <= config.seuilPerte ? '#22c55e' : 
                                  b.tauxPerte <= config.seuilPerte * 1.5 ? '#eab308' : '#ef4444'
                                ),
                                borderRadius: 4
                              }]
                            }}
                            options={{
                              plugins: {
                                annotation: {
                                  annotations: {
                                    line1: {
                                      type: 'line',
                                      yMin: config.seuilPerte,
                                      yMax: config.seuilPerte,
                                      borderColor: '#ef4444',
                                      borderWidth: 2,
                                      borderDash: [5, 5]
                                    }
                                  }
                                }
                              }
                            }}
                          />
                        </div>
                        <p className="text-xs text-neutral-500 mt-2 text-center">
                          Seuil acceptable : {config.seuilPerte}% (ligne rouge pointill√©e)
                        </p>
                      </div>
                    </div>
                  );
                })()}
                
                {/* ==================== ONGLET COMPARATIF ==================== */}
                {dashboardOnglet === 'comparatif' && (() => {
                  const comparatif = getComparatifFestival();
                  
                  return (
                    <div className="space-y-4 max-w-2xl mx-auto">
                      {/* Tableau comparatif */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">üìÖ Comparatif Festival</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b border-neutral-600">
                                <th className="text-left py-2"></th>
                                {comparatif.jours.map(j => (
                                  <th key={j.jour} className={`text-center py-2 px-2 ${j.jour === jourActuel ? 'text-amber-400' : ''}`}>
                                    J{j.jour}
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">üí∞ CA</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className={`text-center px-2 font-bold ${j.jour === jourActuel ? 'text-amber-400' : ''}`}>
                                    {j.hasDonnees ? `${j.ca.toFixed(0)}‚Ç¨` : '-'}
                                  </td>
                                ))}
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">üç∫ F√ªts bi√®re</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className="text-center px-2">
                                    {j.hasDonnees ? j.futsBiere : '-'}
                                  </td>
                                ))}
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">üçé F√ªts cidre</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className="text-center px-2">
                                    {j.hasDonnees ? j.futsCidre : '-'}
                                  </td>
                                ))}
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">üìâ Taux perte</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className={`text-center px-2 ${
                                    j.tauxPerte <= config.seuilPerte ? 'text-green-400' :
                                    j.tauxPerte <= config.seuilPerte * 1.5 ? 'text-yellow-400' : 'text-red-400'
                                  }`}>
                                    {j.hasDonnees ? `${j.tauxPerte.toFixed(1)}%` : '-'}
                                  </td>
                                ))}
                              </tr>
                              <tr className="border-b border-neutral-700">
                                <td className="py-2 text-neutral-400">üèÜ Top bar</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className="text-center px-2 text-xs">
                                    {j.hasDonnees ? j.topBar : '-'}
                                  </td>
                                ))}
                              </tr>
                              <tr>
                                <td className="py-2 text-neutral-400">‚ö° Pic</td>
                                {comparatif.jours.map(j => (
                                  <td key={j.jour} className="text-center px-2 text-xs">
                                    {j.hasDonnees ? j.picCreneau : '-'}
                                  </td>
                                ))}
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* Totaux festival */}
                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-emerald-900/30 p-4 rounded-xl border border-emerald-700">
                          <p className="text-sm text-emerald-300">üí∞ CA Total Festival</p>
                          <p className="text-3xl font-black text-emerald-400">{comparatif.caTotal.toFixed(0)} ‚Ç¨</p>
                        </div>
                        <div className="bg-blue-900/30 p-4 rounded-xl border border-blue-700">
                          <p className="text-sm text-blue-300">üõ¢Ô∏è F√ªts consomm√©s</p>
                          <p className="text-3xl font-black text-blue-400">{comparatif.futsTotal}</p>
                        </div>
                      </div>
                      
                      {/* Graphique √©volution */}
                      <div className="bg-neutral-800 p-4 rounded-xl">
                        <h4 className="font-bold mb-4">üìà √âvolution CA</h4>
                        <div className="space-y-3">
                          {comparatif.jours.map((j, idx) => {
                            const maxCa = Math.max(...comparatif.jours.map(x => x.ca), 1);
                            const pct = (j.ca / maxCa) * 100;
                            const progression = idx > 0 && comparatif.jours[idx-1].ca > 0 
                              ? ((j.ca - comparatif.jours[idx-1].ca) / comparatif.jours[idx-1].ca * 100).toFixed(0)
                              : null;
                            return (
                              <div key={j.jour}>
                                <div className="flex items-center justify-between mb-1">
                                  <span className={`font-bold ${j.jour === jourActuel ? 'text-amber-400' : 'text-neutral-300'}`}>
                                    Jour {j.jour}
                                  </span>
                                  <div>
                                    <span className="font-bold">{j.ca.toFixed(0)} ‚Ç¨</span>
                                    {progression && (
                                      <span className={`ml-2 text-sm ${parseInt(progression) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        ({parseInt(progression) >= 0 ? '+' : ''}{progression}%)
                                      </span>
                                    )}
                                  </div>
                                </div>
                                <div className="bg-neutral-700 rounded-full h-4 overflow-hidden">
                                  <div 
                                    className={`h-full ${j.jour === jourActuel ? 'bg-amber-500' : 'bg-emerald-600'} transition-all`}
                                    style={{ width: `${j.hasDonnees ? pct : 0}%` }}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                      
                      {/* Stats moyennes */}
                      {jourActuel > 1 && (
                        <div className="bg-neutral-800 p-4 rounded-xl">
                          <h4 className="font-bold mb-3">üìä Moyennes</h4>
                          <div className="grid grid-cols-2 gap-4 text-center">
                            <div>
                              <p className="text-neutral-400 text-sm">CA moyen/jour</p>
                              <p className="text-2xl font-bold text-emerald-400">
                                {(comparatif.caTotal / jourActuel).toFixed(0)} ‚Ç¨
                              </p>
                            </div>
                            <div>
                              <p className="text-neutral-400 text-sm">F√ªts moy./jour</p>
                              <p className="text-2xl font-bold text-blue-400">
                                {(comparatif.futsTotal / jourActuel).toFixed(1)}
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          )}

          {/* Modal QR Code */}
          {/* Modal QR Code */}
          {showQRCode && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6 text-center">
                <h3 className="text-xl font-bold mb-4">üì± QR Code de la session</h3>
                <p className="text-neutral-400 text-sm mb-4">Scannez ce code pour rejoindre</p>
                <div className="bg-white p-4 rounded-xl inline-block mb-4">
                  <img 
                    src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?session=' + session)}`}
                    alt="QR Code"
                    width="200"
                    height="200"
                  />
                </div>
                <p className="text-2xl font-mono font-bold text-red-400 mb-2">{session}</p>
                <p className="text-xs text-neutral-500 mb-4 break-all">{window.location.origin + window.location.pathname}?session={session}</p>
                <button onClick={() => setShowQRCode(false)} className="w-full py-3 bg-neutral-700 rounded-lg">Fermer</button>
              </div>
            </div>
          )}

          {/* Modal Session Info */}
          {showSessionInfo && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üì° Session</h3>
                <div className="bg-neutral-800 p-4 rounded-xl mb-4 text-center">
                  <p className="text-sm text-neutral-400">Code √† partager</p>
                  <p className="text-2xl font-mono font-bold text-red-400">{session}</p>
                  <button 
                    onClick={() => { setShowSessionInfo(false); setShowQRCode(true); }}
                    className="mt-2 px-4 py-2 bg-blue-600 rounded-lg text-sm"
                  >
                    üì± Afficher QR Code
                  </button>
                </div>
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-sm text-neutral-400">Utilisateurs connect√©s ({connectedUsers.length})</p>
                    {isAdmin && <span className="text-xs text-green-400 bg-green-900/50 px-2 py-0.5 rounded">üîì Admin</span>}
                  </div>
                  <div className="space-y-1">
                    {connectedUsers.map(user => (
                      <div key={user} className="flex items-center justify-between bg-neutral-800 px-3 py-2 rounded">
                        <div className="flex items-center gap-2">
                          <div className="w-2 h-2 bg-green-500 rounded-full" />
                          <span>{user} {user === userName && '(vous)'}</span>
                        </div>
                        {isAdmin && user !== userName && (
                          <button 
                            onClick={() => ejecterUtilisateur(user)}
                            className="px-2 py-1 bg-red-600/50 hover:bg-red-600 rounded text-xs font-medium transition-colors"
                          >
                            ‚ùå √âjecter
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
                <div className="flex gap-2 mt-4">
                  <button 
                    onClick={() => { setShowSessionInfo(false); setShowTutoriel(true); setTutorielStep(0); }} 
                    className="py-3 px-4 bg-blue-900 hover:bg-blue-800 rounded-lg text-sm"
                  >
                    üìñ Tutoriel
                  </button>
                  <button onClick={() => setShowSessionInfo(false)} className="flex-1 py-3 bg-neutral-700 rounded-lg">Fermer</button>
                  <button 
                    onClick={deconnexion} 
                    className="flex-1 py-3 bg-red-900 hover:bg-red-800 rounded-lg text-red-300 border border-red-700"
                  >
                    üö™ D√©connexion
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ==================== MODAL B√âN√âVOLES ==================== */}
          {showModalBenevoles && (
            <div className="fixed inset-0 bg-black/90 flex flex-col z-50">
              {/* Header */}
              <div className="bg-indigo-900 px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-xl">üë•</span>
                  <h3 className="font-bold">Gestion B√©n√©voles</h3>
                  <span className="ml-2 px-2 py-1 bg-indigo-700 rounded text-sm font-bold">J{jourActuel}</span>
                </div>
                <button onClick={() => setShowModalBenevoles(false)} className="text-2xl">‚úï</button>
              </div>

              {/* Onglets */}
              <div className="flex border-b border-neutral-700">
                <button 
                  onClick={() => setBenevoleOnglet('planning')}
                  className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'planning' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                >
                  üìÖ Planning
                </button>
                <button 
                  onClick={() => setBenevoleOnglet('synthese')}
                  className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'synthese' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                >
                  üìä Synth√®se
                </button>
                {isCreator ? (
                  <button 
                    onClick={ouvrirParametresCreneaux}
                    className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'parametres' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                  >
                    ‚è∞ Cr√©neaux
                  </button>
                ) : (
                  <button 
                    disabled
                    className="flex-1 py-3 text-sm font-medium bg-neutral-900 text-neutral-600 cursor-not-allowed"
                    title="R√©serv√© au cr√©ateur de la session"
                  >
                    üîí Cr√©neaux
                  </button>
                )}
              </div>

              {/* Contenu */}
              <div className="flex-1 overflow-y-auto p-4">
                
                {/* ONGLET PLANNING */}
                {benevoleOnglet === 'planning' && (
                  <div>
                    {barsNomades.length === 0 ? (
                      <div className="text-center py-8 text-neutral-500">
                        <p>Aucun bar configur√©</p>
                        <p className="text-sm">Ajoutez des bars dans les param√®tres</p>
                      </div>
                    ) : (
                      <>
                        {/* Bouton copier depuis jour pr√©c√©dent */}
                        {jourActuel > 1 && nbAffectations === 0 && (
                          <div className="mb-4 p-3 bg-amber-900/30 border border-amber-700 rounded-xl text-center">
                            <p className="text-sm text-amber-300 mb-2">Aucune affectation pour J{jourActuel}</p>
                            <button
                              onClick={copierAffectationsJourPrecedent}
                              disabled={isLoading}
                              className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium disabled:opacity-50"
                            >
                              üìã Copier depuis J{jourActuel - 1}
                            </button>
                          </div>
                        )}
                        
                        {/* S√©lecteur de bar */}
                        <div className="flex items-center justify-center gap-4 mb-6">
                          <button 
                            onClick={() => {
                              const idx = barsNomades.findIndex(b => b.id === selectedBarPlanning);
                              if (idx > 0) setSelectedBarPlanning(barsNomades[idx - 1].id);
                            }}
                            disabled={barsNomades.findIndex(b => b.id === selectedBarPlanning) === 0}
                            className="w-10 h-10 bg-neutral-700 rounded-full disabled:opacity-30"
                          >‚óÄ</button>
                          
                          <div className="text-center">
                            <h4 className="text-lg font-bold">{barsNomades.find(b => b.id === selectedBarPlanning)?.nom || 'Bar'}</h4>
                            <p className="text-sm text-neutral-400">
                              {barsNomades.find(b => b.id === selectedBarPlanning)?.type === 'biere' ? 'üç∫ Bi√®re' : 'üçé Cidre'}
                            </p>
                          </div>
                          
                          <button 
                            onClick={() => {
                              const idx = barsNomades.findIndex(b => b.id === selectedBarPlanning);
                              if (idx < barsNomades.length - 1) setSelectedBarPlanning(barsNomades[idx + 1].id);
                            }}
                            disabled={barsNomades.findIndex(b => b.id === selectedBarPlanning) === barsNomades.length - 1}
                            className="w-10 h-10 bg-neutral-700 rounded-full disabled:opacity-30"
                          >‚ñ∂</button>
                        </div>

                        {/* Indicateurs bars */}
                        <div className="flex justify-center gap-2 mb-6">
                          {barsNomades.map(bar => {
                            const hasAff = affectations[bar.id] && Object.keys(affectations[bar.id]).length > 0;
                            return (
                              <button
                                key={bar.id}
                                onClick={() => setSelectedBarPlanning(bar.id)}
                                className={`w-10 h-10 rounded-full font-bold text-sm ${
                                  selectedBarPlanning === bar.id
                                    ? 'bg-indigo-600 text-white scale-110'
                                    : hasAff
                                      ? 'bg-green-600 text-white'
                                      : 'bg-neutral-700 text-neutral-400'
                                }`}
                              >
                                {barsNomades.indexOf(bar) + 1}
                              </button>
                            );
                          })}
                        </div>

                        {/* Cr√©neaux */}
                        <div className="space-y-3">
                          {creneaux.map(creneau => {
                            const aff = selectedBarPlanning ? getAffectation(selectedBarPlanning, creneau.id) : null;
                            const hasAffectation = aff && (aff.vendeur?.nom || aff.serveur?.nom || aff.runner?.nom);

                            return (
                              <div key={creneau.id} className={`rounded-xl p-4 ${hasAffectation ? 'bg-green-900/30 border border-green-700' : 'bg-neutral-800'}`}>
                                <div className="flex items-center justify-between mb-3">
                                  <div className="flex items-center gap-2">
                                    <span className="text-lg">‚è∞</span>
                                    <span className="font-bold">{creneau.label}</span>
                                  </div>
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => ouvrirEditionAffectation(selectedBarPlanning, creneau.id)}
                                      className="px-3 py-1.5 bg-indigo-600 rounded-lg text-sm"
                                    >
                                      {hasAffectation ? '‚úèÔ∏è Modifier' : '‚ûï Affecter'}
                                    </button>
                                    {hasAffectation && (
                                      <button
                                        onClick={() => supprimerAffectation(selectedBarPlanning, creneau.id)}
                                        className="px-3 py-1.5 bg-red-600/50 rounded-lg text-sm"
                                      >üóëÔ∏è</button>
                                    )}
                                  </div>
                                </div>

                                {hasAffectation ? (
                                  <div className="grid grid-cols-3 gap-2">
                                    <div className="bg-amber-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-amber-400 mb-1">üõí Vendeur</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.vendeur)}</p>
                                    </div>
                                    <div className="bg-blue-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-blue-400 mb-1">üç∫ Serveur</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.serveur)}</p>
                                    </div>
                                    <div className="bg-purple-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-purple-400 mb-1">üèÉ Runner</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.runner)}</p>
                                    </div>
                                  </div>
                                ) : (
                                  <p className="text-neutral-500 text-sm text-center py-2">Aucun b√©n√©vole affect√©</p>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* ONGLET SYNTH√àSE */}
                {benevoleOnglet === 'synthese' && (
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h4 className="font-bold">Tableau de synth√®se</h4>
                      <button 
                        onClick={exporterBenevoles}
                        disabled={nbAffectations === 0}
                        className="px-4 py-2 bg-green-600 rounded-lg text-sm disabled:opacity-50"
                      >
                        üì• Exporter CSV
                      </button>
                    </div>

                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border-collapse">
                        <thead>
                          <tr className="bg-indigo-900">
                            <th className="border border-indigo-700 px-2 py-2 text-left">Bar</th>
                            <th className="border border-indigo-700 px-2 py-2 text-left">Cr√©neau</th>
                            <th className="border border-indigo-700 px-2 py-2 text-amber-400">üõí</th>
                            <th className="border border-indigo-700 px-2 py-2 text-blue-400">üç∫</th>
                            <th className="border border-indigo-700 px-2 py-2 text-purple-400">üèÉ</th>
                          </tr>
                        </thead>
                        <tbody>
                          {barsNomades.map((bar, barIdx) => (
                            creneaux.map((creneau, creneauIdx) => {
                              const aff = getAffectation(bar.id, creneau.id);
                              return (
                                <tr key={`${bar.id}-${creneau.id}`} className={creneauIdx % 2 === 0 ? 'bg-neutral-900' : 'bg-neutral-800'}>
                                  {creneauIdx === 0 && (
                                    <td 
                                      rowSpan={creneaux.length} 
                                      className={`border border-neutral-700 px-2 py-1 font-medium ${bar.type === 'biere' ? 'bg-emerald-900/30' : 'bg-teal-900/30'}`}
                                    >
                                      {bar.nom}
                                    </td>
                                  )}
                                  <td className="border border-neutral-700 px-2 py-1 text-neutral-400">{creneau.label}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.vendeur) : '-'}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.serveur) : '-'}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.runner) : '-'}</td>
                                </tr>
                              );
                            })
                          ))}
                        </tbody>
                      </table>
                    </div>

                    <div className="mt-4 p-3 bg-indigo-900/30 rounded-xl">
                      <p className="text-sm">
                        <strong>R√©sum√© :</strong> {nbAffectations} cr√©neau(x) avec affectation(s) sur {barsNomades.length * creneaux.length} possibles
                      </p>
                    </div>
                  </div>
                )}

                {/* ONGLET PARAM√àTRES CR√âNEAUX */}
                {benevoleOnglet === 'parametres' && (
                  <div>
                    <h4 className="font-bold mb-4">Configuration des cr√©neaux horaires</h4>
                    
                    <div className="space-y-2 mb-6">
                      {tempCreneaux.map((creneau, index) => (
                        <div key={creneau.id} className="flex items-center gap-2 bg-neutral-800 p-3 rounded-lg">
                          <span className="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">
                            {index + 1}
                          </span>
                          <input
                            type="text"
                            value={creneau.label}
                            onChange={(e) => {
                              const updated = [...tempCreneaux];
                              updated[index] = { ...creneau, label: e.target.value };
                              setTempCreneaux(updated);
                            }}
                            className="flex-1 px-3 py-2 bg-neutral-700 rounded-lg"
                          />
                          <button
                            onClick={() => supprimerCreneauTemp(creneau.id)}
                            disabled={tempCreneaux.length <= 1}
                            className="p-2 text-red-400 disabled:opacity-30"
                          >üóëÔ∏è</button>
                        </div>
                      ))}
                    </div>

                    {tempCreneaux.length < 10 && (
                      <div className="flex gap-2 mb-6">
                        <input
                          type="text"
                          value={nouveauCreneau}
                          onChange={(e) => setNouveauCreneau(e.target.value)}
                          placeholder="Nouveau cr√©neau (ex: 14h-16h)"
                          className="flex-1 px-4 py-2 bg-neutral-800 rounded-lg"
                          onKeyDown={(e) => e.key === 'Enter' && ajouterCreneau()}
                        />
                        <button
                          onClick={ajouterCreneau}
                          disabled={!nouveauCreneau.trim()}
                          className="px-4 py-2 bg-indigo-600 rounded-lg disabled:opacity-50"
                        >‚ûï</button>
                      </div>
                    )}

                    <div className="flex gap-2">
                      <button onClick={() => setBenevoleOnglet('planning')} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                      <button onClick={sauvegarderCreneaux} className="flex-1 py-3 bg-indigo-600 rounded-lg font-medium">üíæ Sauvegarder</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Modal √âdition Affectation */}
          {showModalAffectation && editAffectation && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[60]">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-2">üë• Affecter les b√©n√©voles</h3>
                <p className="text-neutral-400 text-sm mb-4">
                  {barsNomades.find(b => b.id === editAffectation.barId)?.nom} - {creneaux.find(c => c.id === editAffectation.creneauId)?.label}
                </p>

                <div className="space-y-4">
                  {/* Vendeur */}
                  <div className="bg-amber-900/20 p-4 rounded-xl border border-amber-700">
                    <label className="block text-sm font-bold text-amber-400 mb-2">üõí Vendeur</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.vendeur.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          vendeur: { ...prev.vendeur, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.vendeur.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          vendeur: { ...prev.vendeur, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>

                  {/* Serveur */}
                  <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-700">
                    <label className="block text-sm font-bold text-blue-400 mb-2">üç∫ Serveur</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.serveur.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          serveur: { ...prev.serveur, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.serveur.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          serveur: { ...prev.serveur, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>

                  {/* Runner */}
                  <div className="bg-purple-900/20 p-4 rounded-xl border border-purple-700">
                    <label className="block text-sm font-bold text-purple-400 mb-2">üèÉ Runner</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.runner.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          runner: { ...prev.runner, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.runner.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          runner: { ...prev.runner, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>
                </div>

                <div className="flex gap-2 mt-6">
                  <button onClick={() => { setShowModalAffectation(false); setEditAffectation(null); }} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={sauvegarderAffectation} className="flex-1 py-3 bg-indigo-600 rounded-lg font-medium">‚úì Enregistrer</button>
                </div>
              </div>
            </div>
          )}

          {/* ==================== TUTORIEL INT√âGR√â ==================== */}
          {showTutoriel && (
            <div className="fixed inset-0 bg-black/95 flex items-center justify-center p-4 z-[60]">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md overflow-hidden">
                {/* Contenu du tutoriel selon l'√©tape */}
                {tutorielStep === 0 && (
                  <div className="p-6 text-center">
                    <img src="logo-hellfest.png" alt="Hellfest" className="w-20 h-20 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-green-400 mb-2">Bienvenue !</h2>
                    <p className="text-neutral-300 mb-4">
                      Application de gestion des f√ªts pour les Bars Nomades du Hellfest 2026
                    </p>
                    <p className="text-sm text-neutral-400">
                      Suivez ce petit guide pour d√©couvrir les fonctionnalit√©s principales.
                    </p>
                  </div>
                )}
                
                {tutorielStep === 1 && (
                  <div className="p-6">
                    <div className="text-4xl mb-4 text-center">‚ûï</div>
                    <h3 className="text-xl font-bold mb-3 text-center">Attribuer un f√ªt</h3>
                    <div className="bg-amber-900/30 p-4 rounded-xl mb-4">
                      <p className="text-sm text-neutral-300 mb-2">
                        Utilisez le bouton <span className="bg-amber-600 px-2 py-1 rounded text-xs font-bold">‚ûï F√ªt</span> en bas de l'√©cran
                      </p>
                      <p className="text-xs text-neutral-400">
                        S√©lectionnez ensuite le bar qui re√ßoit le f√ªt.
                      </p>
                    </div>
                    <div className="bg-neutral-800 p-3 rounded-lg">
                      <p className="text-xs text-neutral-400">üí° Les couleurs indiquent la dur√©e :</p>
                      <div className="flex gap-2 mt-2 text-xs">
                        <span className="bg-neutral-700 px-2 py-1 rounded">&lt;1h30</span>
                        <span className="bg-yellow-500 text-black px-2 py-1 rounded">1h30-3h</span>
                        <span className="bg-orange-500 px-2 py-1 rounded">3h-4h</span>
                        <span className="bg-red-600 px-2 py-1 rounded">&gt;4h</span>
                      </div>
                    </div>
                  </div>
                )}
                
                {tutorielStep === 2 && (
                  <div className="p-6">
                    <div className="text-4xl mb-4 text-center">‚Ü©Ô∏è</div>
                    <h3 className="text-xl font-bold mb-3 text-center">Retourner un f√ªt</h3>
                    <div className="bg-blue-900/30 p-4 rounded-xl mb-4">
                      <p className="text-sm text-neutral-300 mb-2">
                        Cliquez sur <span className="bg-black/30 px-2 py-1 rounded text-xs">‚Ü©Ô∏è Retour</span> √† c√¥t√© du f√ªt
                      </p>
                    </div>
                    <div className="space-y-2 text-sm">
                      <div className="flex items-center gap-2 bg-neutral-800 p-2 rounded">
                        <span>üì¶</span>
                        <span className="text-neutral-300">F√ªt vide</span>
                        <span className="text-xs text-neutral-500 ml-auto">Le plus courant</span>
                      </div>
                      <div className="flex items-center gap-2 bg-neutral-800 p-2 rounded">
                        <span>üí•</span>
                        <span className="text-neutral-300">F√ªt cass√©</span>
                        <span className="text-xs text-neutral-500 ml-auto">Probl√®me technique</span>
                      </div>
                      <div className="flex items-center gap-2 bg-neutral-800 p-2 rounded">
                        <span>‚ôªÔ∏è</span>
                        <span className="text-neutral-300">Non termin√©</span>
                        <span className="text-xs text-neutral-500 ml-auto">Reste du contenu</span>
                      </div>
                    </div>
                  </div>
                )}
                
                {tutorielStep === 3 && (
                  <div className="p-6">
                    <div className="text-4xl mb-4 text-center">üí∞</div>
                    <h3 className="text-xl font-bold mb-3 text-center">Enregistrer une vente</h3>
                    <div className="bg-emerald-900/30 p-4 rounded-xl mb-4">
                      <p className="text-sm text-neutral-300 mb-2">
                        Utilisez le bouton <span className="bg-emerald-600 px-2 py-1 rounded text-xs font-bold">üí∞ Vente</span> en bas de l'√©cran
                      </p>
                    </div>
                    <div className="bg-neutral-800 p-3 rounded-lg text-sm">
                      <p className="text-neutral-300 mb-2">Renseignez :</p>
                      <ul className="text-neutral-400 text-xs space-y-1 ml-4">
                        <li>‚Ä¢ Le bar nomade</li>
                        <li>‚Ä¢ Le montant en ‚Ç¨</li>
                        <li>‚Ä¢ Optionnel : d√©tails (pintes, pichets...)</li>
                        <li>‚Ä¢ Si √©quipement d√©faillant : cochez la case</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {tutorielStep === 4 && (
                  <div className="p-6">
                    <div className="text-4xl mb-4 text-center">üë•</div>
                    <h3 className="text-xl font-bold mb-3 text-center">G√©rer les b√©n√©voles</h3>
                    <div className="bg-indigo-900/30 p-4 rounded-xl mb-4">
                      <p className="text-sm text-neutral-300 mb-2">
                        Cliquez sur <span className="bg-indigo-600 px-2 py-1 rounded text-xs font-bold">üë• B√©n√©voles</span>
                      </p>
                    </div>
                    <div className="bg-neutral-800 p-3 rounded-lg text-sm">
                      <p className="text-neutral-300 mb-2">Vous pouvez :</p>
                      <ul className="text-neutral-400 text-xs space-y-1 ml-4">
                        <li>‚Ä¢ Affecter vendeur, serveur, runner par cr√©neau</li>
                        <li>‚Ä¢ Voir la synth√®se de tous les bars</li>
                        <li>‚Ä¢ Copier le planning du jour pr√©c√©dent</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {tutorielStep === 5 && (
                  <div className="p-6 text-center">
                    <div className="text-6xl mb-4">üéâ</div>
                    <h3 className="text-xl font-bold mb-3">C'est parti !</h3>
                    <p className="text-neutral-300 mb-4">
                      Vous √™tes pr√™t √† utiliser l'application.
                    </p>
                    <div className="bg-neutral-800 p-3 rounded-lg text-sm text-left">
                      <p className="text-neutral-400 mb-2">üí° Astuces :</p>
                      <ul className="text-xs text-neutral-500 space-y-1">
                        <li>‚Ä¢ Cliquez sur le code session pour voir les infos</li>
                        <li>‚Ä¢ Les admins ont acc√®s aux statistiques (üìà)</li>
                        <li>‚Ä¢ Le tutoriel est accessible dans les infos session</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {/* Navigation */}
                <div className="bg-neutral-800 px-6 py-4 flex items-center justify-between">
                  <div className="flex gap-1">
                    {[0, 1, 2, 3, 4, 5].map(i => (
                      <div 
                        key={i} 
                        className={`w-2 h-2 rounded-full ${tutorielStep === i ? 'bg-red-500' : 'bg-neutral-600'}`}
                      />
                    ))}
                  </div>
                  
                  <div className="flex gap-2">
                    {tutorielStep > 0 && (
                      <button 
                        onClick={() => setTutorielStep(prev => prev - 1)}
                        className="px-4 py-2 bg-neutral-700 rounded-lg text-sm"
                      >
                        ‚Üê Pr√©c√©dent
                      </button>
                    )}
                    
                    {tutorielStep < 5 ? (
                      <button 
                        onClick={() => setTutorielStep(prev => prev + 1)}
                        className="px-4 py-2 bg-red-600 rounded-lg text-sm font-medium"
                      >
                        Suivant ‚Üí
                      </button>
                    ) : (
                      <button 
                        onClick={() => {
                          setShowTutoriel(false);
                          localStorage.setItem('gestionFuts_tutorielVu', 'true');
                        }}
                        className="px-4 py-2 bg-green-600 rounded-lg text-sm font-medium"
                      >
                        ‚úì Commencer
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Bouton passer */}
                <button 
                  onClick={() => {
                    setShowTutoriel(false);
                    localStorage.setItem('gestionFuts_tutorielVu', 'true');
                  }}
                  className="w-full py-2 text-neutral-500 text-sm hover:text-neutral-300"
                >
                  Passer le tutoriel
                </button>
              </div>
            </div>
          )}

          {/* ==================== BARRE FLOTTANTE RACCOURCIS ==================== */}
          <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-40">
            <div className="flex gap-2 bg-neutral-900/95 backdrop-blur px-4 py-3 rounded-2xl shadow-lg border border-neutral-700">
              <button
                onClick={() => setShowQuickFut(true)}
                disabled={isLoading}
                className="px-4 py-3 bg-amber-600 hover:bg-amber-500 rounded-xl font-medium text-sm flex items-center gap-2 disabled:opacity-50"
              >
                ‚ûï F√ªt
              </button>
              <button
                onClick={() => setShowModalVentes(true)}
                className="px-4 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-medium text-sm flex items-center gap-2"
              >
                üí∞ Vente
              </button>
              <button
                onClick={() => setShowPlanView(true)}
                className="px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-medium text-sm flex items-center gap-2"
              >
                üó∫Ô∏è Plan
              </button>
            </div>
          </div>

          {/* ==================== MODAL VUE PLAN DU FESTIVAL ==================== */}
          {showPlanView && (
            <div className="fixed inset-0 bg-black/95 flex flex-col z-50">
              {/* Header */}
              <div className="bg-blue-900 px-4 py-2 flex items-center justify-between shrink-0">
                <h3 className="text-lg font-bold">üó∫Ô∏è Plan du Festival</h3>
                <div className="flex items-center gap-2">
                  {isCreator && (
                    <button 
                      onClick={() => {
                        setPlanEditMode(!planEditMode);
                        setSelectedPlanPopup(null);
                        if (!planEditMode) {
                          const premierNonPlace = barsNomades.find(b => !barPositions[b.id]);
                          setSelectedBarForPlan(premierNonPlace ? premierNonPlace.id : null);
                        }
                      }}
                      className={`px-2 py-1 rounded-lg text-xs ${planEditMode ? 'bg-orange-600' : 'bg-neutral-700'}`}
                    >
                      {planEditMode ? '‚úèÔ∏è Placement ON' : '‚öôÔ∏è Config'}
                    </button>
                  )}
                  <button onClick={() => { setShowPlanView(false); setPlanEditMode(false); setSelectedPlanPopup(null); }} className="text-2xl">‚úï</button>
                </div>
              </div>

              {/* Instructions mode placement */}
              {planEditMode && (
                <div className="bg-orange-900/50 px-3 py-2 border-b border-orange-700 shrink-0">
                  <div className="flex items-center justify-between">
                    <div className="text-xs">
                      {selectedBarForPlan ? (
                        <p>üëÜ Cliquez pour placer : <span className="font-bold text-orange-300">
                          {barsNomades.find(b => b.id === selectedBarForPlan)?.nom}
                        </span></p>
                      ) : (
                        <p className="text-green-400">‚úÖ Tous positionn√©s !</p>
                      )}
                    </div>
                    <button onClick={resetAllPositions} className="text-xs px-2 py-1 bg-red-600/50 rounded">
                      üîÑ Reset
                    </button>
                  </div>
                  <div className="flex flex-wrap gap-1 mt-2">
                    {barsNomades.map(bar => {
                      const isPositioned = !!barPositions[bar.id];
                      const isSelected = selectedBarForPlan === bar.id;
                      return (
                        <button
                          key={bar.id}
                          onClick={() => setSelectedBarForPlan(bar.id)}
                          className={`px-2 py-0.5 rounded text-xs ${
                            isSelected ? 'bg-orange-500 ring-2 ring-white' : isPositioned ? 'bg-green-700' : 'bg-neutral-700'
                          }`}
                        >
                          {bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.nom} {isPositioned && '‚úì'}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Container du plan avec scroll */}
              <div className="flex-1 overflow-auto p-2">
                {/* Wrapper avec RATIO FIXE - C'est la cl√© ! */}
                <div 
                  className="relative mx-auto bg-neutral-800 rounded-lg overflow-hidden"
                  style={{ 
                    aspectRatio: '1387 / 667',
                    width: '100%',
                    maxWidth: '1387px',
                    minWidth: '600px'
                  }}
                  onClick={(e) => {
                    // Fermer popup si clic sur le fond
                    if (e.target === e.currentTarget || e.target.tagName === 'IMG') {
                      if (!planEditMode) {
                        setSelectedPlanPopup(null);
                      }
                    }
                    handlePlanClick(e);
                  }}
                >
                  {/* Image du plan - remplit le container */}
                  <img 
                    src="plan-hellfest.jpg" 
                    alt="Plan Hellfest" 
                    className={`absolute inset-0 w-full h-full object-cover ${planEditMode ? 'cursor-crosshair' : ''}`}
                    draggable={false}
                  />
                  
                  {/* Marqueurs des bars */}
                  {barsNomades.map(bar => {
                    const pos = barPositions[bar.id];
                    if (!pos) return null;
                    
                    const barFuts = bar.futs || [];
                    const isFull = barFuts.length >= config.maxFutsParBar;
                    const isEmpty = barFuts.length === 0;
                    const statusColor = isFull ? 'bg-red-500' : isEmpty ? 'bg-green-500' : 'bg-yellow-500';
                    const borderColor = isFull ? 'border-t-red-500' : isEmpty ? 'border-t-green-500' : 'border-t-yellow-500';
                    const isBiere = bar.type === 'biere';
                    const isPopupOpen = selectedPlanPopup === bar.id;
                    
                    return (
                      <div
                        key={bar.id}
                        className="absolute transform -translate-x-1/2 -translate-y-full"
                        style={{ 
                          left: `${pos.x}%`, 
                          top: `${pos.y}%`,
                          zIndex: isPopupOpen ? 50 : 10
                        }}
                      >
                        {/* Marqueur - taille responsive */}
                        <div 
                          className={`relative cursor-pointer transition-transform ${isPopupOpen ? 'scale-125' : 'hover:scale-110'} ${planEditMode ? 'animate-bounce' : ''}`}
                          onClick={(e) => {
                            e.stopPropagation();
                            if (!planEditMode) {
                              setSelectedPlanPopup(isPopupOpen ? null : bar.id);
                            }
                          }}
                        >
                          {/* Pin - plus petit sur mobile */}
                          <div className={`w-7 h-7 sm:w-9 sm:h-9 ${statusColor} rounded-full border-2 sm:border-3 border-white shadow-lg flex items-center justify-center text-sm sm:text-base`}>
                            {isBiere ? 'üç∫' : 'üçé'}
                          </div>
                          {/* Compteur */}
                          <div className="absolute -top-1 -right-1 w-4 h-4 sm:w-5 sm:h-5 bg-black border border-white sm:border-2 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-bold">
                            {barFuts.length}
                          </div>
                          {/* Pointe */}
                          <div className={`absolute left-1/2 -bottom-1.5 sm:-bottom-2 transform -translate-x-1/2 w-0 h-0 border-l-[5px] sm:border-l-[7px] border-r-[5px] sm:border-r-[7px] border-t-[8px] sm:border-t-[10px] border-l-transparent border-r-transparent ${borderColor}`} />
                        </div>
                        
                        {/* Popup au clic */}
                        {isPopupOpen && !planEditMode && (
                          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-20">
                            <div className="bg-neutral-900 rounded-lg p-3 min-w-[140px] shadow-xl border border-neutral-500">
                              <p className="font-bold text-sm mb-1">{isBiere ? 'üç∫' : 'üçé'} {bar.nom}</p>
                              <div className="flex items-center gap-1 mb-2">
                                {Array.from({ length: config.maxFutsParBar }).map((_, idx) => (
                                  <span key={idx} className={`text-xs ${idx < barFuts.length ? '' : 'opacity-30'}`}>üõ¢Ô∏è</span>
                                ))}
                                <span className={`text-xs font-bold ml-1 ${isFull ? 'text-red-400' : isEmpty ? 'text-green-400' : 'text-yellow-400'}`}>
                                  {barFuts.length}/{config.maxFutsParBar}
                                </span>
                              </div>
                              {barFuts.length > 0 && (
                                <div className="text-xs text-neutral-400 space-y-0.5">
                                  {barFuts.map((fut, idx) => {
                                    const durationColor = fut.dateAttribution ? getFutDurationColor(fut.dateAttribution) : '';
                                    const duration = fut.dateAttribution ? formatDuration(fut.dateAttribution) : '';
                                    return (
                                      <div key={idx} className={`px-1 rounded ${durationColor}`}>
                                        F√ªt {idx + 1} {duration && `‚Ä¢ ${duration}`}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                              <p className={`text-xs mt-2 font-medium ${isFull ? 'text-red-400' : isEmpty ? 'text-green-400' : 'text-yellow-400'}`}>
                                {isFull ? 'üî¥ COMPLET' : isEmpty ? 'üü¢ DISPO' : 'üü° EN SERVICE'}
                              </p>
                            </div>
                            {/* Fl√®che du popup */}
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[8px] border-r-[8px] border-t-[8px] border-l-transparent border-r-transparent border-t-neutral-900" />
                          </div>
                        )}
                        
                        {/* Bouton supprimer en mode edit */}
                        {planEditMode && (
                          <button 
                            onClick={(e) => { e.stopPropagation(); supprimerPositionBar(bar.id); }}
                            className="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs bg-red-600 hover:bg-red-500 rounded px-1"
                          >
                            ‚úï
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* L√©gende + Indication scroll */}
              <div className="bg-neutral-800 px-4 py-2 flex items-center justify-between text-xs shrink-0">
                <div className="flex items-center gap-4">
                  <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 bg-green-500 rounded-full"></span> Dispo</span>
                  <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 bg-yellow-500 rounded-full"></span> En service</span>
                  <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 bg-red-500 rounded-full"></span> Complet</span>
                </div>
                <span className="text-neutral-500">‚ÜîÔ∏è Scroll horizontal</span>
              </div>
            </div>
          )}

          {/* ==================== MODAL S√âLECTION RAPIDE F√õT ==================== */}
          {showQuickFut && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md p-6">
                
                {/* √âtape 1 : S√©lection du bar */}
                {!quickFutConfirm ? (
                  <>
                    <h3 className="text-xl font-bold mb-4">‚ûï Attribuer un f√ªt</h3>
                    <p className="text-neutral-400 text-sm mb-4">S√©lectionnez le bar :</p>
                    
                    <div className="space-y-2 max-h-[60vh] overflow-y-auto">
                      {barsNomades.map(bar => {
                        const isBiere = bar.type === 'biere';
                        const barFuts = bar.futs || [];
                        const canAdd = barFuts.length < config.maxFutsParBar && (isBiere ? stockBiere > 0 : stockCidre > 0);
                        const isFull = barFuts.length >= config.maxFutsParBar;
                        
                        return (
                          <button
                            key={bar.id}
                            onClick={() => setQuickFutConfirm({
                              barId: bar.id,
                              barNom: bar.nom,
                              barType: bar.type,
                              currentFuts: barFuts.length,
                              maxFuts: config.maxFutsParBar
                            })}
                            disabled={!canAdd || isLoading}
                            className={`w-full p-4 rounded-xl flex items-center justify-between transition-all ${
                              canAdd && !isLoading
                                ? (isBiere ? 'bg-emerald-900/50 hover:bg-emerald-900 hover:scale-[1.02]' : 'bg-teal-900/50 hover:bg-teal-900 hover:scale-[1.02]')
                                : 'bg-neutral-800 opacity-50 cursor-not-allowed'
                            }`}
                          >
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">{isBiere ? 'üç∫' : 'üçé'}</span>
                              <div className="text-left">
                                <p className="font-medium">{bar.nom}</p>
                                <div className="flex items-center gap-2">
                                  {/* Ic√¥nes mini */}
                                  <div className="flex gap-0.5">
                                    {Array.from({ length: config.maxFutsParBar }).map((_, idx) => (
                                      <span key={idx} className={`text-sm ${idx < barFuts.length ? '' : 'opacity-30'}`}>üõ¢Ô∏è</span>
                                    ))}
                                  </div>
                                  <span className={`text-sm font-bold ${isFull ? 'text-red-400' : barFuts.length > 0 ? 'text-yellow-400' : 'text-green-400'}`}>
                                    {barFuts.length}/{config.maxFutsParBar}
                                  </span>
                                </div>
                              </div>
                            </div>
                            {isFull ? (
                              <span className="text-red-400 text-xs font-bold">COMPLET</span>
                            ) : canAdd ? (
                              <span className="text-green-400 text-xl">‚Üí</span>
                            ) : (
                              <span className="text-red-400 text-xs">Stock vide</span>
                            )}
                          </button>
                        );
                      })}
                    </div>

                    <button 
                      onClick={() => { setShowQuickFut(false); setQuickFutConfirm(null); }} 
                      className="w-full py-3 bg-neutral-700 rounded-lg mt-4"
                    >
                      Fermer
                    </button>
                  </>
                ) : (
                  /* √âtape 2 : Confirmation */
                  <>
                    <div className="text-center">
                      <div className="text-5xl mb-4">
                        {quickFutConfirm.barType === 'biere' ? 'üç∫' : 'üçé'}
                      </div>
                      <h3 className="text-xl font-bold mb-2">Confirmer l'attribution</h3>
                      <p className="text-2xl font-black text-white mb-4">{quickFutConfirm.barNom}</p>
                    </div>
                    
                    {/* Visualisation avant/apr√®s */}
                    <div className="bg-neutral-800 rounded-xl p-4 mb-4">
                      <div className="flex items-center justify-between mb-3">
                        <span className="text-neutral-400">Actuellement :</span>
                        <div className="flex items-center gap-2">
                          <div className="flex gap-1">
                            {Array.from({ length: quickFutConfirm.maxFuts }).map((_, idx) => (
                              <span key={idx} className={`text-xl ${idx < quickFutConfirm.currentFuts ? '' : 'opacity-30'}`}>üõ¢Ô∏è</span>
                            ))}
                          </div>
                          <span className={`text-2xl font-black ${quickFutConfirm.currentFuts > 0 ? 'text-yellow-400' : 'text-green-400'}`}>
                            {quickFutConfirm.currentFuts}
                          </span>
                        </div>
                      </div>
                      
                      <div className="flex items-center justify-center text-3xl text-green-400 my-2">
                        ‚Üì +1
                      </div>
                      
                      <div className="flex items-center justify-between">
                        <span className="text-neutral-400">Apr√®s :</span>
                        <div className="flex items-center gap-2">
                          <div className="flex gap-1">
                            {Array.from({ length: quickFutConfirm.maxFuts }).map((_, idx) => (
                              <span key={idx} className={`text-xl ${idx < quickFutConfirm.currentFuts + 1 ? '' : 'opacity-30'}`}>üõ¢Ô∏è</span>
                            ))}
                          </div>
                          <span className={`text-2xl font-black ${quickFutConfirm.currentFuts + 1 >= quickFutConfirm.maxFuts ? 'text-red-400' : 'text-yellow-400'}`}>
                            {quickFutConfirm.currentFuts + 1}
                          </span>
                        </div>
                      </div>
                      
                      {quickFutConfirm.currentFuts + 1 >= quickFutConfirm.maxFuts && (
                        <div className="mt-3 text-center">
                          <span className="text-red-400 text-sm font-bold bg-red-900/50 px-3 py-1 rounded-full">
                            ‚ö†Ô∏è Ce bar sera COMPLET
                          </span>
                        </div>
                      )}
                    </div>

                    <div className="flex gap-3">
                      <button 
                        onClick={() => setQuickFutConfirm(null)} 
                        className="flex-1 py-4 bg-neutral-700 hover:bg-neutral-600 rounded-xl font-medium text-lg"
                      >
                        ‚Üê Retour
                      </button>
                      <button 
                        onClick={() => { 
                          attribuerFut(quickFutConfirm.barId); 
                          setQuickFutConfirm(null);
                          setShowQuickFut(false); 
                        }}
                        disabled={isLoading}
                        className="flex-1 py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-lg disabled:opacity-50"
                      >
                        {isLoading ? '‚è≥' : '‚úì CONFIRMER'}
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}

        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
