<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0D0D0D">
  <title>Gestion F√ªts - Hellfest 2026</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR2VzdGlvbiBGw7t0cyAtIEhlbGxmZXN0IDIwMjYiLCJzaG9ydF9uYW1lIjoiRsO7dHMgSEYiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBEMEQwRCIsInRoZW1lX2NvbG9yIjoiI0U2Mzk0NiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBeU5UWWdNalUySWo0OGNtVmpkQ0IzYVdSMGFEMGlNalUySWlCb1pXbG5hSFE5SWpJMU5pSWdabWxzYkQwaUl6QkVNRVF3UkNJdlBqeGphWEpqYkdVZ1kzZzlJakV5T0NJZ1kzazlJakV5T0NJZ2NqMGlPVEFpSUdacGJHdzlJaU5GTmpNNU5EWWlMejQ4ZEdWNGRDQjRQU0l4TWpnaUlIazlJakUwTUNJZ1ptOXVkQzF6YVhwbFBTSTBNQ0lnWm1sc2JEMGlkMmhwZEdVaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQdWU0cGVPQnJqd3ZkR1Y0ZEQ0OEwzTjJaejQ9Iiwic2l6ZXMiOiIyNTZ4MjU2IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNTYgMjU2Ij48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iIzBEMEQwRCIvPjxjaXJjbGUgY3g9IjEyOCIgY3k9IjEyOCIgcj0iOTAiIGZpbGw9IiNFNjM5NDYiLz48dGV4dCB4PSIxMjgiIHk9IjE0MCIgZm9udC1zaXplPSI0MCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfjro8L3RleHQ+PC9zdmc+">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    @media (display-mode: standalone) {
      body { padding-top: env(safe-area-inset-top); }
    }
  </style>
</head>
<body class="bg-black">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCgl30syyCEJif9q96E2jzv-aTXxXgvgv0",
      authDomain: "gestion-futs-hellfest.firebaseapp.com",
      databaseURL: "https://gestion-futs-hellfest-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gestion-futs-hellfest",
      storageBucket: "gestion-futs-hellfest.firebasestorage.app",
      messagingSenderId: "107509834680",
      appId: "1:107509834680:web:3a58295d3268b5d19f654d"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ==================== ICONS ====================
    const Icon = ({ name, className }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          ref.current.appendChild(icon);
        }
      }, [name]);
      return <span ref={ref} className={className} style={{ display: 'inline-flex', alignItems: 'center' }} />;
    };

    // ==================== SESSION SCREEN ====================
    const SessionScreen = ({ onJoinSession }) => {
      const [mode, setMode] = useState('choice');
      const [sessionCode, setSessionCode] = useState('');
      const [userName, setUserName] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const generateSessionCode = () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = 'HF26-';
        for (let i = 0; i < 4; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      };

      const createSession = async () => {
        if (!userName.trim()) {
          setError('Entre ton pr√©nom');
          return;
        }
        setLoading(true);
        setError('');
        
        const newCode = generateSessionCode();
        const sessionRef = database.ref(`sessions/${newCode}`);
        
        const initialData = {
          config: {
            stockInitialBiere: 50,
            stockInitialCidre: 20,
            maxFutsParBar: 3,
            nombreJours: 4,
            createdAt: Date.now()
          },
          creneaux: [
            { id: 'c1', label: '11h30-13h' },
            { id: 'c2', label: '13h-15h' },
            { id: 'c3', label: '15h-18h' },
            { id: 'c4', label: '18h-22h30' },
            { id: 'c5', label: '22h30-00h30' }
          ],
          jourActuel: 1,
          users: {
            [userName.trim()]: { joinedAt: Date.now(), lastActive: Date.now() }
          }
        };

        await sessionRef.set(initialData);
        onJoinSession(newCode, userName.trim());
      };

      const joinSession = async () => {
        if (!userName.trim()) {
          setError('Entre ton pr√©nom');
          return;
        }
        if (!sessionCode.trim()) {
          setError('Entre le code de session');
          return;
        }
        setLoading(true);
        setError('');

        const code = sessionCode.trim().toUpperCase();
        const sessionRef = database.ref(`sessions/${code}`);
        const snapshot = await sessionRef.once('value');
        
        if (!snapshot.exists()) {
          setError('Session introuvable');
          setLoading(false);
          return;
        }

        await sessionRef.child(`users/${userName.trim()}`).set({
          joinedAt: Date.now(),
          lastActive: Date.now()
        });

        onJoinSession(code, userName.trim());
      };

      if (mode === 'choice') {
        return (
          <div className="min-h-screen bg-black flex items-center justify-center p-4">
            <div className="w-full max-w-sm">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">üç∫</div>
                <h1 className="text-2xl font-bold text-white mb-2">Gestion F√ªts</h1>
                <p className="text-red-500 font-bold">HELLFEST 2026</p>
              </div>
              
              <div className="space-y-4">
                <button
                  onClick={() => setMode('create')}
                  className="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-lg hover:bg-red-700 transition-colors"
                >
                  üÜï Cr√©er une session
                </button>
                <button
                  onClick={() => setMode('join')}
                  className="w-full py-4 bg-neutral-800 text-white rounded-xl font-bold text-lg hover:bg-neutral-700 transition-colors border border-neutral-700"
                >
                  üîó Rejoindre une session
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-black flex items-center justify-center p-4">
          <div className="w-full max-w-sm">
            <button onClick={() => { setMode('choice'); setError(''); }} className="text-neutral-400 mb-6 flex items-center gap-2">
              <Icon name="ArrowLeft" className="w-4 h-4" /> Retour
            </button>
            
            <h2 className="text-xl font-bold text-white mb-6">
              {mode === 'create' ? 'üÜï Nouvelle session' : 'üîó Rejoindre'}
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-neutral-400 text-sm mb-2">Ton pr√©nom</label>
                <input
                  type="text"
                  value={userName}
                  onChange={(e) => setUserName(e.target.value)}
                  className="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-xl text-white text-lg"
                  placeholder="Ex: Kevin"
                />
              </div>

              {mode === 'join' && (
                <div>
                  <label className="block text-neutral-400 text-sm mb-2">Code de session</label>
                  <input
                    type="text"
                    value={sessionCode}
                    onChange={(e) => setSessionCode(e.target.value.toUpperCase())}
                    className="w-full px-4 py-3 bg-neutral-900 border border-neutral-700 rounded-xl text-white text-lg text-center tracking-widest"
                    placeholder="HF26-XXXX"
                    maxLength={9}
                  />
                </div>
              )}

              {error && (
                <div className="p-3 bg-red-900/50 border border-red-700 rounded-xl text-red-300 text-sm">
                  {error}
                </div>
              )}

              <button
                onClick={mode === 'create' ? createSession : joinSession}
                disabled={loading}
                className="w-full py-4 bg-red-600 text-white rounded-xl font-bold text-lg hover:bg-red-700 transition-colors disabled:opacity-50"
              >
                {loading ? '‚è≥ Connexion...' : (mode === 'create' ? '‚ú® Cr√©er' : 'üöÄ Rejoindre')}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MAIN APP ====================
    const App = () => {
      const [session, setSession] = useState(null);
      const [userName, setUserName] = useState('');
      const [isOnline, setIsOnline] = useState(true);
      const [connectedUsers, setConnectedUsers] = useState([]);

      // Config & Data
      const [config, setConfig] = useState({
        stockInitialBiere: 50,
        stockInitialCidre: 20,
        maxFutsParBar: 3,
        nombreJours: 4
      });
      const [barsNomades, setBarsNomades] = useState([]);
      const [historique, setHistorique] = useState([]);
      const [historiqueVentes, setHistoriqueVentes] = useState([]);
      const [benevoles, setBenevoles] = useState([]);
      const [jourActuel, setJourActuel] = useState(1);
      
      // Cr√©neaux et Affectations
      const [creneaux, setCreneaux] = useState([
        { id: 'c1', label: '11h30-13h' },
        { id: 'c2', label: '13h-15h' },
        { id: 'c3', label: '15h-18h' },
        { id: 'c4', label: '18h-22h30' },
        { id: 'c5', label: '22h30-00h30' }
      ]);
      const [affectations, setAffectations] = useState({});

      // UI States
      const [isAdmin, setIsAdmin] = useState(false);
      const [showModalAdmin, setShowModalAdmin] = useState(false);
      const [adminPassword, setAdminPassword] = useState('');
      const [pendingAdminAction, setPendingAdminAction] = useState(null);
      const [showParametres, setShowParametres] = useState(false);
      const [showHistorique, setShowHistorique] = useState(false);
      const [showHistoriqueVentes, setShowHistoriqueVentes] = useState(false);
      const [showModalExport, setShowModalExport] = useState(false);
      const [showModalRetour, setShowModalRetour] = useState(null);
      const [showModalVentes, setShowModalVentes] = useState(false);
      const [showModalBenevoles, setShowModalBenevoles] = useState(false);
      const [showModalAffectation, setShowModalAffectation] = useState(false);
      const [showSessionInfo, setShowSessionInfo] = useState(false);
      
      // B√©n√©voles UI
      const [benevoleOnglet, setBenevoleOnglet] = useState('planning');
      const [selectedBarPlanning, setSelectedBarPlanning] = useState(null);
      const [editAffectation, setEditAffectation] = useState(null);
      const [tempCreneaux, setTempCreneaux] = useState([]);
      const [nouveauCreneau, setNouveauCreneau] = useState('');

      // Ventes form
      const [venteBarId, setVenteBarId] = useState('');
      const [venteMontant, setVenteMontant] = useState('');
      const [venteNbPintes, setVenteNbPintes] = useState('');
      const [venteNbPichets, setVenteNbPichets] = useState('');
      const [venteNbGobelets, setVenteNbGobelets] = useState('');
      const [venteCommentaire, setVenteCommentaire] = useState('');

      const ADMIN_PASSWORD = "Hellfest26";

      // ==================== FIREBASE SYNC ====================
      useEffect(() => {
        if (!session) return;

        const sessionRef = database.ref(`sessions/${session}`);
        
        // Sync config
        sessionRef.child('config').on('value', (snap) => {
          if (snap.val()) setConfig(snap.val());
        });

        // Sync bars
        sessionRef.child('barsNomades').on('value', (snap) => {
          if (snap.val()) {
            const bars = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            setBarsNomades(bars);
            if (bars.length > 0 && !selectedBarPlanning) {
              setSelectedBarPlanning(bars[0].id);
            }
          } else {
            setBarsNomades([]);
          }
        });

        // Sync historique
        sessionRef.child('historique').on('value', (snap) => {
          if (snap.val()) {
            const hist = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            hist.sort((a, b) => b.timestamp - a.timestamp);
            setHistorique(hist);
          } else {
            setHistorique([]);
          }
        });

        // Sync ventes
        sessionRef.child('historiqueVentes').on('value', (snap) => {
          if (snap.val()) {
            const ventes = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            ventes.sort((a, b) => b.timestamp - a.timestamp);
            setHistoriqueVentes(ventes);
          } else {
            setHistoriqueVentes([]);
          }
        });

        // Sync benevoles
        sessionRef.child('benevoles').on('value', (snap) => {
          if (snap.val()) {
            const ben = Object.entries(snap.val()).map(([id, data]) => ({ id, ...data }));
            setBenevoles(ben);
          } else {
            setBenevoles([]);
          }
        });

        // Sync users
        sessionRef.child('users').on('value', (snap) => {
          if (snap.val()) {
            const users = Object.keys(snap.val());
            setConnectedUsers(users);
          }
        });

        // Sync jour
        sessionRef.child('jourActuel').on('value', (snap) => {
          if (snap.val()) setJourActuel(snap.val());
        });

        // Sync cr√©neaux
        sessionRef.child('creneaux').on('value', (snap) => {
          if (snap.val()) {
            const cren = Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val());
            setCreneaux(cren);
          }
        });

        // Sync affectations
        sessionRef.child('affectations').on('value', (snap) => {
          if (snap.val()) {
            setAffectations(snap.val());
          } else {
            setAffectations({});
          }
        });

        // Online status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          setIsOnline(snap.val() === true);
        });

        // Update lastActive
        const interval = setInterval(() => {
          sessionRef.child(`users/${userName}/lastActive`).set(Date.now());
        }, 30000);

        // D√©tecter si on a √©t√© √©ject√©
        sessionRef.child(`users/${userName}`).on('value', (snap) => {
          if (!snap.exists() && session) {
            // L'utilisateur a √©t√© supprim√© = √©ject√©
            alert('Vous avez √©t√© d√©connect√© par un administrateur.');
            setSession(null);
            setUserName('');
            setIsAdmin(false);
          }
        });

        return () => {
          sessionRef.off();
          connectedRef.off();
          clearInterval(interval);
        };
      }, [session, userName]);

      // Fonction pour √©jecter un utilisateur (admin only)
      const ejecterUtilisateur = async (user) => {
        if (!isAdmin || user === userName) return;
        if (confirm(`√ätes-vous s√ªr de vouloir √©jecter ${user} ?`)) {
          await database.ref(`sessions/${session}/users/${user}`).remove();
        }
      };

      // ==================== COMPUTED VALUES ====================
      const stockBiere = config.stockInitialBiere - historique.filter(h => h.type === 'SORTIE' && h.typeFut === 'biere').length;
      const stockCidre = config.stockInitialCidre - historique.filter(h => h.type === 'SORTIE' && h.typeFut === 'cidre').length;
      const stockVides = historique.filter(h => h.type === 'RETOUR_VIDE').length;
      const stockCasse = historique.filter(h => h.type === 'RETOUR_CASSE').length;
      const stockReutilisables = historique.filter(h => h.type === 'RETOUR_REUTILISABLE').length;

      const totalVentes = historiqueVentes
        .filter(v => !v.annule)
        .reduce((acc, v) => acc + (v.montant || 0), 0);

      const compterAffectations = () => {
        let total = 0;
        Object.values(affectations).forEach(bar => {
          Object.values(bar || {}).forEach(creneau => {
            if (creneau && (creneau.vendeur?.nom || creneau.serveur?.nom || creneau.runner?.nom)) {
              total++;
            }
          });
        });
        return total;
      };

      const nbAffectations = compterAffectations();

      // ==================== ACTIONS ====================
      const handleJoinSession = (code, name) => {
        setSession(code);
        setUserName(name);
      };

      const demanderAccesAdmin = (action) => {
        if (isAdmin) {
          executerActionAdmin(action);
        } else {
          setPendingAdminAction(action);
          setAdminPassword('');
          setShowModalAdmin(true);
        }
      };

      const validerAdmin = () => {
        if (adminPassword === ADMIN_PASSWORD) {
          setIsAdmin(true);
          setShowModalAdmin(false);
          if (pendingAdminAction) {
            executerActionAdmin(pendingAdminAction);
            setPendingAdminAction(null);
          }
        }
      };

      const executerActionAdmin = (action) => {
        switch (action) {
          case 'parametres': setShowParametres(true); break;
          case 'export': setShowModalExport(true); break;
          case 'historique': setShowHistorique(!showHistorique); break;
          case 'ventes': setShowHistoriqueVentes(!showHistoriqueVentes); break;
          case 'jour_prev': 
            if (jourActuel > 1) {
              database.ref(`sessions/${session}/jourActuel`).set(jourActuel - 1);
            }
            break;
          case 'jour_next':
            if (jourActuel < config.nombreJours) {
              database.ref(`sessions/${session}/jourActuel`).set(jourActuel + 1);
            }
            break;
        }
      };

      const ajouterBar = async (nom, type) => {
        const newRef = database.ref(`sessions/${session}/barsNomades`).push();
        await newRef.set({ nom, type, futs: [] });
      };

      const supprimerBar = async (barId) => {
        const bar = barsNomades.find(b => b.id === barId);
        if (bar?.futs?.length > 0) {
          alert('Impossible de supprimer un bar avec des f√ªts en cours');
          return;
        }
        await database.ref(`sessions/${session}/barsNomades/${barId}`).remove();
        // Supprimer aussi les affectations de ce bar
        await database.ref(`sessions/${session}/affectations/${barId}`).remove();
      };

      const attribuerFut = async (barId) => {
        const bar = barsNomades.find(b => b.id === barId);
        if (!bar) return;

        const currentFuts = bar.futs || [];
        if (currentFuts.length >= config.maxFutsParBar) return;

        const typeFut = bar.type;
        if (typeFut === 'biere' && stockBiere <= 0) return;
        if (typeFut === 'cidre' && stockCidre <= 0) return;

        const newFut = {
          id: Date.now().toString(),
          type: typeFut,
          dateAttribution: Date.now()
        };

        const updatedFuts = [...currentFuts, newFut];
        await database.ref(`sessions/${session}/barsNomades/${barId}/futs`).set(updatedFuts);

        await database.ref(`sessions/${session}/historique`).push({
          type: 'SORTIE',
          typeFut,
          barId,
          barNom: bar.nom,
          jour: jourActuel,
          timestamp: Date.now(),
          user: userName
        });
      };

      const retournerFut = async (barId, futIndex, typeRetour) => {
        const bar = barsNomades.find(b => b.id === barId);
        if (!bar) return;

        const currentFuts = bar.futs || [];
        const fut = currentFuts[futIndex];
        if (!fut) return;

        const updatedFuts = currentFuts.filter((_, i) => i !== futIndex);
        await database.ref(`sessions/${session}/barsNomades/${barId}/futs`).set(updatedFuts.length > 0 ? updatedFuts : null);

        await database.ref(`sessions/${session}/historique`).push({
          type: typeRetour,
          typeFut: fut.type,
          barId,
          barNom: bar.nom,
          jour: jourActuel,
          timestamp: Date.now(),
          user: userName
        });

        setShowModalRetour(null);
      };

      const enregistrerVente = async () => {
        if (!venteBarId) return;
        const bar = barsNomades.find(b => b.id === venteBarId);

        await database.ref(`sessions/${session}/historiqueVentes`).push({
          barId: venteBarId,
          barNom: bar?.nom || 'Bar inconnu',
          montant: parseFloat(venteMontant) || 0,
          nbPintes: parseInt(venteNbPintes) || 0,
          nbPichets: parseInt(venteNbPichets) || 0,
          nbGobelets: parseInt(venteNbGobelets) || 0,
          commentaire: venteCommentaire,
          jour: jourActuel,
          timestamp: Date.now(),
          user: userName
        });

        setShowModalVentes(false);
        setVenteMontant('');
        setVenteNbPintes('');
        setVenteNbPichets('');
        setVenteNbGobelets('');
        setVenteCommentaire('');
      };

      const sauvegarderConfig = async (newConfig) => {
        await database.ref(`sessions/${session}/config`).update(newConfig);
        setShowParametres(false);
      };

      // ==================== FONCTIONS B√âN√âVOLES ====================
      const ouvrirModalBenevoles = () => {
        setBenevoleOnglet('planning');
        if (barsNomades.length > 0 && !selectedBarPlanning) {
          setSelectedBarPlanning(barsNomades[0].id);
        }
        setShowModalBenevoles(true);
      };

      const getAffectation = (barId, creneauId) => {
        return affectations[barId]?.[creneauId] || null;
      };

      const ouvrirEditionAffectation = (barId, creneauId) => {
        const existante = getAffectation(barId, creneauId) || {
          vendeur: { nom: '', prenom: '' },
          serveur: { nom: '', prenom: '' },
          runner: { nom: '', prenom: '' }
        };
        setEditAffectation({
          barId,
          creneauId,
          vendeur: { ...existante.vendeur },
          serveur: { ...existante.serveur },
          runner: { ...existante.runner }
        });
        setShowModalAffectation(true);
      };

      const sauvegarderAffectation = async () => {
        if (!editAffectation) return;
        const { barId, creneauId, vendeur, serveur, runner } = editAffectation;
        
        await database.ref(`sessions/${session}/affectations/${barId}/${creneauId}`).set({
          vendeur, serveur, runner
        });
        
        setShowModalAffectation(false);
        setEditAffectation(null);
      };

      const supprimerAffectation = async (barId, creneauId) => {
        await database.ref(`sessions/${session}/affectations/${barId}/${creneauId}`).remove();
      };

      const ouvrirParametresCreneaux = () => {
        setTempCreneaux([...creneaux]);
        setNouveauCreneau('');
        setBenevoleOnglet('parametres');
      };

      const ajouterCreneau = () => {
        if (nouveauCreneau.trim() && tempCreneaux.length < 10) {
          const newId = 'c' + Date.now();
          setTempCreneaux([...tempCreneaux, { id: newId, label: nouveauCreneau.trim() }]);
          setNouveauCreneau('');
        }
      };

      const supprimerCreneauTemp = (id) => {
        setTempCreneaux(tempCreneaux.filter(c => c.id !== id));
      };

      const sauvegarderCreneaux = async () => {
        await database.ref(`sessions/${session}/creneaux`).set(tempCreneaux);
        setBenevoleOnglet('planning');
      };

      const getNomComplet = (personne) => {
        if (!personne || (!personne.nom && !personne.prenom)) return '-';
        return `${personne.prenom || ''} ${personne.nom || ''}`.trim();
      };

      // ==================== EXPORTS ====================
      const formatDate = (ts) => new Date(ts).toLocaleString('fr-FR');
      const formatDateFilename = () => {
        const now = new Date();
        return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
      };

      const exportCSV = (filename, content) => {
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const exporterHistoriqueFuts = () => {
        if (historique.length === 0) return;
        const headers = ['Date/Heure', 'Type', 'F√ªt', 'Bar', 'Jour', 'Utilisateur'];
        const rows = historique.map(h => [
          `"${formatDate(h.timestamp)}"`,
          `"${h.type}"`,
          `"${h.typeFut}"`,
          `"${h.barNom}"`,
          h.jour,
          `"${h.user}"`
        ].join(';'));
        exportCSV(`Historique_Futs_${formatDateFilename()}.csv`, headers.join(';') + '\n' + rows.join('\n'));
      };

      const exporterHistoriqueVentes = () => {
        if (historiqueVentes.length === 0) return;
        const headers = ['Date/Heure', 'Bar', 'Montant', 'Pintes', 'Pichets', 'Gobelets', 'Jour', 'Commentaire'];
        const rows = historiqueVentes.filter(v => !v.annule).map(v => [
          `"${formatDate(v.timestamp)}"`,
          `"${v.barNom}"`,
          (v.montant || 0).toFixed(2).replace('.', ','),
          v.nbPintes || 0,
          v.nbPichets || 0,
          v.nbGobelets || 0,
          v.jour,
          `"${v.commentaire || ''}"`
        ].join(';'));
        const total = historiqueVentes.filter(v => !v.annule).reduce((a, v) => a + (v.montant || 0), 0);
        exportCSV(`Historique_Ventes_${formatDateFilename()}.csv`, 
          headers.join(';') + '\n' + rows.join('\n') + '\n\nTOTAL;' + total.toFixed(2).replace('.', ',') + ' ‚Ç¨');
      };

      const exporterBenevoles = () => {
        if (nbAffectations === 0) return;
        const headers = ['Bar Nomade', 'Cr√©neau', 'Vendeur', 'Serveur', 'Runner'];
        const rows = [];
        
        barsNomades.forEach(bar => {
          creneaux.forEach(creneau => {
            const aff = getAffectation(bar.id, creneau.id);
            rows.push([
              `"${bar.nom}"`,
              `"${creneau.label}"`,
              `"${aff ? getNomComplet(aff.vendeur) : '-'}"`,
              `"${aff ? getNomComplet(aff.serveur) : '-'}"`,
              `"${aff ? getNomComplet(aff.runner) : '-'}"`
            ].join(';'));
          });
        });

        exportCSV(`Planning_Benevoles_${formatDateFilename()}.csv`, 
          headers.join(';') + '\n' + rows.join('\n') + '\n\nTotal affectations;' + nbAffectations);
      };

      // ==================== RENDER ====================
      if (!session) {
        return <SessionScreen onJoinSession={handleJoinSession} />;
      }

      return (
        <div className="min-h-screen bg-black text-white">
          {/* Header */}
          <div className="bg-neutral-900 border-b border-red-900 p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <span className="text-2xl">üç∫</span>
                <div>
                  <h1 className="font-bold text-red-500">HELLFEST 2026</h1>
                  <p className="text-xs text-neutral-400">Gestion des F√ªts</p>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`} />
                <button onClick={() => setShowSessionInfo(true)} className="text-xs bg-neutral-800 px-2 py-1 rounded">
                  {session}
                </button>
              </div>
            </div>

            {/* Jour selector + Admin */}
            <div className="flex items-center justify-between gap-2 mb-3">
              <div className={`flex items-center gap-2 px-3 py-2 rounded-lg ${isAdmin ? 'bg-red-900' : 'bg-neutral-800'}`}>
                <span className="text-sm">Jour</span>
                <button 
                  onClick={() => demanderAccesAdmin('jour_prev')}
                  disabled={isAdmin && jourActuel <= 1}
                  className="w-8 h-8 bg-neutral-700 rounded disabled:opacity-50"
                >‚óÄ</button>
                <span className="text-xl font-bold w-8 text-center">{jourActuel}</span>
                <button 
                  onClick={() => demanderAccesAdmin('jour_next')}
                  disabled={isAdmin && jourActuel >= config.nombreJours}
                  className="w-8 h-8 bg-neutral-700 rounded disabled:opacity-50"
                >‚ñ∂</button>
                <span className="text-xs text-neutral-400">/{config.nombreJours}</span>
              </div>
              
              <button 
                onClick={() => isAdmin ? setIsAdmin(false) : demanderAccesAdmin('parametres')}
                className={`px-3 py-2 rounded-lg text-sm font-medium ${isAdmin ? 'bg-green-600' : 'bg-neutral-800'}`}
              >
                {isAdmin ? 'üîì Admin' : 'üîí Admin'}
              </button>
            </div>

            {/* Action buttons */}
            <div className="flex flex-wrap gap-2">
              <button onClick={ouvrirModalBenevoles} className="flex-1 py-2 bg-indigo-600 rounded-lg text-sm font-medium flex items-center justify-center gap-1">
                üë• B√©n√©voles {nbAffectations > 0 && <span className="bg-white/20 px-1.5 rounded">{nbAffectations}</span>}
              </button>
              <button onClick={() => setShowModalVentes(true)} className="flex-1 py-2 bg-emerald-600 rounded-lg text-sm font-medium">
                üí∞ Ventes
              </button>
              {isAdmin && (
                <>
                  <button onClick={() => setShowHistoriqueVentes(!showHistoriqueVentes)} className={`py-2 px-3 rounded-lg text-sm ${showHistoriqueVentes ? 'bg-teal-500' : 'bg-teal-700'}`}>
                    üìä {historiqueVentes.length}
                  </button>
                  <button onClick={() => setShowHistorique(!showHistorique)} className={`py-2 px-3 rounded-lg text-sm ${showHistorique ? 'bg-purple-500' : 'bg-purple-700'}`}>
                    üìã {historique.length}
                  </button>
                </>
              )}
              <button onClick={() => demanderAccesAdmin('export')} className="py-2 px-3 bg-green-700 rounded-lg text-sm">
                üì•
              </button>
              <button onClick={() => demanderAccesAdmin('parametres')} className="py-2 px-3 bg-neutral-700 rounded-lg text-sm">
                ‚öôÔ∏è
              </button>
            </div>
          </div>

          {/* Stocks */}
          <div className="grid grid-cols-5 gap-1 p-2 bg-neutral-900">
            <div className="bg-amber-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-amber-400">{stockBiere}</div>
              <div className="text-xs text-amber-200">üç∫ Bi√®re</div>
            </div>
            <div className="bg-orange-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-orange-400">{stockCidre}</div>
              <div className="text-xs text-orange-200">üçé Cidre</div>
            </div>
            <div className="bg-blue-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-blue-400">{stockVides}</div>
              <div className="text-xs text-blue-200">Vides</div>
            </div>
            <div className="bg-red-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-red-400">{stockCasse}</div>
              <div className="text-xs text-red-200">Cass√©</div>
            </div>
            <div className="bg-purple-900/50 p-2 rounded text-center">
              <div className="text-lg font-bold text-purple-400">{stockReutilisables}</div>
              <div className="text-xs text-purple-200">R√©util.</div>
            </div>
          </div>

          {/* Total ventes */}
          {totalVentes > 0 && (
            <div className="mx-2 mt-2 p-3 bg-emerald-900/50 rounded-lg flex items-center justify-between">
              <span className="text-emerald-300">üí∞ Total Ventes</span>
              <span className="text-xl font-bold text-emerald-400">{totalVentes.toFixed(2)} ‚Ç¨</span>
            </div>
          )}

          {/* Historique Ventes (Admin) */}
          {isAdmin && showHistoriqueVentes && (
            <div className="mx-2 mt-2 bg-teal-900/30 rounded-xl border border-teal-700 overflow-hidden">
              <div className="bg-teal-900/50 px-3 py-2 flex items-center justify-between">
                <span className="font-bold text-teal-300">üìä Historique Ventes</span>
                <button onClick={() => setShowHistoriqueVentes(false)} className="text-teal-400">‚úï</button>
              </div>
              <div className="max-h-48 overflow-y-auto">
                {historiqueVentes.filter(v => !v.annule).length === 0 ? (
                  <p className="text-neutral-500 text-sm text-center py-4">Aucune vente</p>
                ) : (
                  historiqueVentes.filter(v => !v.annule).map(v => (
                    <div key={v.id} className="px-3 py-2 border-b border-teal-800 last:border-0">
                      <div className="flex items-center justify-between">
                        <span className="font-medium text-teal-300">{(v.montant || 0).toFixed(2)} ‚Ç¨</span>
                        <span className="text-xs text-neutral-400">{v.barNom}</span>
                      </div>
                      <div className="flex items-center justify-between text-xs text-neutral-500">
                        <span>üç∫{v.nbPintes || 0} üç∂{v.nbPichets || 0} ü•§{v.nbGobelets || 0}</span>
                        <span>J{v.jour} ‚Ä¢ {new Date(v.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* Historique F√ªts (Admin) */}
          {isAdmin && showHistorique && (
            <div className="mx-2 mt-2 bg-purple-900/30 rounded-xl border border-purple-700 overflow-hidden">
              <div className="bg-purple-900/50 px-3 py-2 flex items-center justify-between">
                <span className="font-bold text-purple-300">üìã Historique F√ªts</span>
                <button onClick={() => setShowHistorique(false)} className="text-purple-400">‚úï</button>
              </div>
              <div className="max-h-48 overflow-y-auto">
                {historique.length === 0 ? (
                  <p className="text-neutral-500 text-sm text-center py-4">Aucun mouvement</p>
                ) : (
                  historique.map(h => {
                    const typeLabels = {
                      'SORTIE': { icon: 'üì§', label: 'Sortie', color: 'text-green-400' },
                      'RETOUR_VIDE': { icon: 'üì¶', label: 'Vide', color: 'text-blue-400' },
                      'RETOUR_CASSE': { icon: 'üí•', label: 'Cass√©', color: 'text-red-400' },
                      'RETOUR_REUTILISABLE': { icon: '‚ôªÔ∏è', label: 'R√©util.', color: 'text-purple-400' }
                    };
                    const t = typeLabels[h.type] || { icon: '‚Ä¢', label: h.type, color: 'text-neutral-400' };
                    return (
                      <div key={h.id} className="px-3 py-2 border-b border-purple-800 last:border-0">
                        <div className="flex items-center justify-between">
                          <span className={`font-medium ${t.color}`}>{t.icon} {t.label}</span>
                          <span className="text-xs text-neutral-400">{h.barNom}</span>
                        </div>
                        <div className="flex items-center justify-between text-xs text-neutral-500">
                          <span>{h.typeFut === 'biere' ? 'üç∫' : 'üçé'} {h.user}</span>
                          <span>J{h.jour} ‚Ä¢ {new Date(h.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          )}

          {/* Bars */}
          <div className="p-2 space-y-2">
            {barsNomades.length === 0 ? (
              <div className="text-center py-8 text-neutral-500">
                <p>Aucun bar nomade configur√©</p>
                <p className="text-sm">Allez dans ‚öôÔ∏è Param√®tres pour en ajouter</p>
              </div>
            ) : (
              barsNomades.map(bar => {
                const isBiere = bar.type === 'biere';
                const barFuts = bar.futs || [];
                const canAdd = barFuts.length < config.maxFutsParBar && (isBiere ? stockBiere > 0 : stockCidre > 0);

                return (
                  <div key={bar.id} className={`rounded-xl border-2 overflow-hidden ${isBiere ? 'border-amber-600 bg-amber-950/30' : 'border-orange-600 bg-orange-950/30'}`}>
                    <div className={`px-3 py-2 flex items-center justify-between ${isBiere ? 'bg-amber-900/50' : 'bg-orange-900/50'}`}>
                      <div className="flex items-center gap-2">
                        <span>{isBiere ? 'üç∫' : 'üçé'}</span>
                        <span className="font-bold">{bar.nom}</span>
                      </div>
                      <span className={`text-sm px-2 py-0.5 rounded ${barFuts.length >= config.maxFutsParBar ? 'bg-red-600' : 'bg-white/20'}`}>
                        {barFuts.length}/{config.maxFutsParBar}
                      </span>
                    </div>

                    <div className="p-3 space-y-2">
                      {barFuts.length === 0 ? (
                        <p className="text-neutral-500 text-sm text-center py-2">Aucun f√ªt</p>
                      ) : (
                        barFuts.map((fut, idx) => (
                          <div key={fut.id} className="flex items-center justify-between bg-black/30 p-2 rounded-lg">
                            <span className="text-sm">{isBiere ? 'üç∫' : 'üçé'} F√ªt {idx + 1}</span>
                            <button 
                              onClick={() => setShowModalRetour({ barId: bar.id, futIndex: idx, barNom: bar.nom })}
                              className="px-3 py-1 bg-neutral-700 rounded text-sm hover:bg-neutral-600"
                            >
                              ‚Ü©Ô∏è Retour
                            </button>
                          </div>
                        ))
                      )}

                      <button
                        onClick={() => attribuerFut(bar.id)}
                        disabled={!canAdd}
                        className={`w-full py-3 rounded-lg font-medium transition-all ${
                          canAdd 
                            ? (isBiere ? 'bg-amber-600 hover:bg-amber-500' : 'bg-orange-600 hover:bg-orange-500')
                            : 'bg-neutral-800 text-neutral-500 cursor-not-allowed'
                        }`}
                      >
                        ‚ûï Attribuer un f√ªt
                      </button>
                    </div>
                  </div>
                );
              })
            )}
          </div>

          {/* ==================== MODALS ==================== */}

          {/* Modal Admin */}
          {showModalAdmin && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üîê Acc√®s Admin</h3>
                <input
                  type="password"
                  value={adminPassword}
                  onChange={(e) => setAdminPassword(e.target.value)}
                  placeholder="Mot de passe"
                  className="w-full px-4 py-3 bg-neutral-800 rounded-lg mb-4"
                  onKeyDown={(e) => e.key === 'Enter' && validerAdmin()}
                />
                <div className="flex gap-2">
                  <button onClick={() => setShowModalAdmin(false)} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={validerAdmin} className="flex-1 py-3 bg-red-600 rounded-lg font-medium">Valider</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Retour F√ªt */}
          {showModalRetour && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">‚Ü©Ô∏è Retour de F√ªt</h3>
                <p className="text-neutral-400 mb-4">{showModalRetour.barNom}</p>
                <div className="space-y-2">
                  <button onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_VIDE')} className="w-full py-3 bg-blue-600 rounded-lg">üì¶ F√ªt Vide</button>
                  <button onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_CASSE')} className="w-full py-3 bg-red-600 rounded-lg">üí• F√ªt Cass√©</button>
                  <button onClick={() => retournerFut(showModalRetour.barId, showModalRetour.futIndex, 'RETOUR_REUTILISABLE')} className="w-full py-3 bg-purple-600 rounded-lg">‚ôªÔ∏è Non Termin√©</button>
                  <button onClick={() => setShowModalRetour(null)} className="w-full py-3 bg-neutral-700 rounded-lg mt-4">Annuler</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Ventes */}
          {showModalVentes && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-4">üí∞ Saisie Vente</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Bar</label>
                    <select 
                      value={venteBarId} 
                      onChange={(e) => setVenteBarId(e.target.value)}
                      className="w-full px-4 py-3 bg-neutral-800 rounded-lg"
                    >
                      <option value="">S√©lectionner...</option>
                      {barsNomades.map(bar => (
                        <option key={bar.id} value={bar.id}>{bar.nom}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Montant (‚Ç¨)</label>
                    <input type="number" step="0.01" value={venteMontant} onChange={(e) => setVenteMontant(e.target.value)} className="w-full px-4 py-3 bg-neutral-800 rounded-lg text-xl" placeholder="0.00" />
                  </div>

                  <div className="grid grid-cols-3 gap-2">
                    <div>
                      <label className="block text-sm text-neutral-400 mb-1">Pintes</label>
                      <input type="number" value={venteNbPintes} onChange={(e) => setVenteNbPintes(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" />
                    </div>
                    <div>
                      <label className="block text-sm text-neutral-400 mb-1">Pichets</label>
                      <input type="number" value={venteNbPichets} onChange={(e) => setVenteNbPichets(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" />
                    </div>
                    <div>
                      <label className="block text-sm text-neutral-400 mb-1">Gobelets</label>
                      <input type="number" value={venteNbGobelets} onChange={(e) => setVenteNbGobelets(e.target.value)} className="w-full px-3 py-2 bg-neutral-800 rounded-lg text-center" />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Commentaire</label>
                    <textarea value={venteCommentaire} onChange={(e) => setVenteCommentaire(e.target.value)} className="w-full px-4 py-2 bg-neutral-800 rounded-lg" rows="2" />
                  </div>
                </div>

                <div className="flex gap-2 mt-6">
                  <button onClick={() => setShowModalVentes(false)} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={enregistrerVente} className="flex-1 py-3 bg-emerald-600 rounded-lg font-medium">‚úì Enregistrer</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Param√®tres */}
          {showParametres && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-4">‚öôÔ∏è Param√®tres</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Stock initial Bi√®re</label>
                    <input type="number" defaultValue={config.stockInitialBiere} id="stockBiere" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Stock initial Cidre</label>
                    <input type="number" defaultValue={config.stockInitialCidre} id="stockCidre" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Max f√ªts par bar</label>
                    <input type="number" defaultValue={config.maxFutsParBar} id="maxFuts" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm text-neutral-400 mb-1">Nombre de jours</label>
                    <input type="number" defaultValue={config.nombreJours} id="nbJours" className="w-full px-4 py-2 bg-neutral-800 rounded-lg" />
                  </div>

                  <hr className="border-neutral-700" />

                  <div>
                    <h4 className="font-bold mb-2">Bars Nomades</h4>
                    <div className="space-y-2 mb-4">
                      {barsNomades.map(bar => (
                        <div key={bar.id} className="flex items-center justify-between bg-neutral-800 p-2 rounded">
                          <span>{bar.type === 'biere' ? 'üç∫' : 'üçé'} {bar.nom}</span>
                          <button onClick={() => supprimerBar(bar.id)} className="text-red-400 text-sm">‚úï</button>
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2">
                      <input type="text" id="newBarNom" placeholder="Nom du bar" className="flex-1 px-3 py-2 bg-neutral-800 rounded-lg text-sm" />
                      <select id="newBarType" className="px-3 py-2 bg-neutral-800 rounded-lg text-sm">
                        <option value="biere">üç∫ Bi√®re</option>
                        <option value="cidre">üçé Cidre</option>
                      </select>
                      <button onClick={() => {
                        const nom = document.getElementById('newBarNom').value;
                        const type = document.getElementById('newBarType').value;
                        if (nom) {
                          ajouterBar(nom, type);
                          document.getElementById('newBarNom').value = '';
                        }
                      }} className="px-4 py-2 bg-red-600 rounded-lg text-sm">+</button>
                    </div>
                  </div>
                </div>

                <div className="flex gap-2 mt-6">
                  <button onClick={() => setShowParametres(false)} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={() => {
                    sauvegarderConfig({
                      stockInitialBiere: parseInt(document.getElementById('stockBiere').value) || 50,
                      stockInitialCidre: parseInt(document.getElementById('stockCidre').value) || 20,
                      maxFutsParBar: parseInt(document.getElementById('maxFuts').value) || 3,
                      nombreJours: parseInt(document.getElementById('nbJours').value) || 4
                    });
                  }} className="flex-1 py-3 bg-red-600 rounded-lg font-medium">üíæ Sauvegarder</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Export */}
          {showModalExport && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üì• Exporter</h3>
                <div className="space-y-2">
                  <button onClick={() => { exporterHistoriqueFuts(); setShowModalExport(false); }} disabled={historique.length === 0} className="w-full py-3 bg-purple-600 rounded-lg disabled:opacity-50">üìã Historique F√ªts ({historique.length})</button>
                  <button onClick={() => { exporterHistoriqueVentes(); setShowModalExport(false); }} disabled={historiqueVentes.length === 0} className="w-full py-3 bg-emerald-600 rounded-lg disabled:opacity-50">üí∞ Historique Ventes ({historiqueVentes.length})</button>
                  <button onClick={() => { exporterBenevoles(); setShowModalExport(false); }} disabled={nbAffectations === 0} className="w-full py-3 bg-indigo-600 rounded-lg disabled:opacity-50">üë• Planning B√©n√©voles ({nbAffectations})</button>
                  <button onClick={() => setShowModalExport(false)} className="w-full py-3 bg-neutral-700 rounded-lg mt-4">Fermer</button>
                </div>
              </div>
            </div>
          )}

          {/* Modal Session Info */}
          {showSessionInfo && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-sm p-6">
                <h3 className="text-xl font-bold mb-4">üì° Session</h3>
                <div className="bg-neutral-800 p-4 rounded-xl mb-4 text-center">
                  <p className="text-sm text-neutral-400">Code √† partager</p>
                  <p className="text-2xl font-mono font-bold text-red-400">{session}</p>
                </div>
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-sm text-neutral-400">Utilisateurs connect√©s ({connectedUsers.length})</p>
                    {isAdmin && <span className="text-xs text-green-400 bg-green-900/50 px-2 py-0.5 rounded">üîì Admin</span>}
                  </div>
                  <div className="space-y-1">
                    {connectedUsers.map(user => (
                      <div key={user} className="flex items-center justify-between bg-neutral-800 px-3 py-2 rounded">
                        <div className="flex items-center gap-2">
                          <div className="w-2 h-2 bg-green-500 rounded-full" />
                          <span>{user} {user === userName && '(vous)'}</span>
                        </div>
                        {isAdmin && user !== userName && (
                          <button 
                            onClick={() => ejecterUtilisateur(user)}
                            className="px-2 py-1 bg-red-600/50 hover:bg-red-600 rounded text-xs font-medium transition-colors"
                          >
                            ‚ùå √âjecter
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
                <button onClick={() => setShowSessionInfo(false)} className="w-full py-3 bg-neutral-700 rounded-lg mt-4">Fermer</button>
              </div>
            </div>
          )}

          {/* ==================== MODAL B√âN√âVOLES ==================== */}
          {showModalBenevoles && (
            <div className="fixed inset-0 bg-black/90 flex flex-col z-50">
              {/* Header */}
              <div className="bg-indigo-900 px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-xl">üë•</span>
                  <h3 className="font-bold">Gestion B√©n√©voles</h3>
                </div>
                <button onClick={() => setShowModalBenevoles(false)} className="text-2xl">‚úï</button>
              </div>

              {/* Onglets */}
              <div className="flex border-b border-neutral-700">
                <button 
                  onClick={() => setBenevoleOnglet('planning')}
                  className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'planning' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                >
                  üìÖ Planning
                </button>
                <button 
                  onClick={() => setBenevoleOnglet('synthese')}
                  className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'synthese' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                >
                  üìä Synth√®se
                </button>
                <button 
                  onClick={ouvrirParametresCreneaux}
                  className={`flex-1 py-3 text-sm font-medium ${benevoleOnglet === 'parametres' ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}
                >
                  ‚è∞ Cr√©neaux
                </button>
              </div>

              {/* Contenu */}
              <div className="flex-1 overflow-y-auto p-4">
                
                {/* ONGLET PLANNING */}
                {benevoleOnglet === 'planning' && (
                  <div>
                    {barsNomades.length === 0 ? (
                      <div className="text-center py-8 text-neutral-500">
                        <p>Aucun bar configur√©</p>
                        <p className="text-sm">Ajoutez des bars dans les param√®tres</p>
                      </div>
                    ) : (
                      <>
                        {/* S√©lecteur de bar */}
                        <div className="flex items-center justify-center gap-4 mb-6">
                          <button 
                            onClick={() => {
                              const idx = barsNomades.findIndex(b => b.id === selectedBarPlanning);
                              if (idx > 0) setSelectedBarPlanning(barsNomades[idx - 1].id);
                            }}
                            disabled={barsNomades.findIndex(b => b.id === selectedBarPlanning) === 0}
                            className="w-10 h-10 bg-neutral-700 rounded-full disabled:opacity-30"
                          >‚óÄ</button>
                          
                          <div className="text-center">
                            <h4 className="text-lg font-bold">{barsNomades.find(b => b.id === selectedBarPlanning)?.nom || 'Bar'}</h4>
                            <p className="text-sm text-neutral-400">
                              {barsNomades.find(b => b.id === selectedBarPlanning)?.type === 'biere' ? 'üç∫ Bi√®re' : 'üçé Cidre'}
                            </p>
                          </div>
                          
                          <button 
                            onClick={() => {
                              const idx = barsNomades.findIndex(b => b.id === selectedBarPlanning);
                              if (idx < barsNomades.length - 1) setSelectedBarPlanning(barsNomades[idx + 1].id);
                            }}
                            disabled={barsNomades.findIndex(b => b.id === selectedBarPlanning) === barsNomades.length - 1}
                            className="w-10 h-10 bg-neutral-700 rounded-full disabled:opacity-30"
                          >‚ñ∂</button>
                        </div>

                        {/* Indicateurs bars */}
                        <div className="flex justify-center gap-2 mb-6">
                          {barsNomades.map(bar => {
                            const hasAff = affectations[bar.id] && Object.keys(affectations[bar.id]).length > 0;
                            return (
                              <button
                                key={bar.id}
                                onClick={() => setSelectedBarPlanning(bar.id)}
                                className={`w-10 h-10 rounded-full font-bold text-sm ${
                                  selectedBarPlanning === bar.id
                                    ? 'bg-indigo-600 text-white scale-110'
                                    : hasAff
                                      ? 'bg-green-600 text-white'
                                      : 'bg-neutral-700 text-neutral-400'
                                }`}
                              >
                                {barsNomades.indexOf(bar) + 1}
                              </button>
                            );
                          })}
                        </div>

                        {/* Cr√©neaux */}
                        <div className="space-y-3">
                          {creneaux.map(creneau => {
                            const aff = selectedBarPlanning ? getAffectation(selectedBarPlanning, creneau.id) : null;
                            const hasAffectation = aff && (aff.vendeur?.nom || aff.serveur?.nom || aff.runner?.nom);

                            return (
                              <div key={creneau.id} className={`rounded-xl p-4 ${hasAffectation ? 'bg-green-900/30 border border-green-700' : 'bg-neutral-800'}`}>
                                <div className="flex items-center justify-between mb-3">
                                  <div className="flex items-center gap-2">
                                    <span className="text-lg">‚è∞</span>
                                    <span className="font-bold">{creneau.label}</span>
                                  </div>
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => ouvrirEditionAffectation(selectedBarPlanning, creneau.id)}
                                      className="px-3 py-1.5 bg-indigo-600 rounded-lg text-sm"
                                    >
                                      {hasAffectation ? '‚úèÔ∏è Modifier' : '‚ûï Affecter'}
                                    </button>
                                    {hasAffectation && (
                                      <button
                                        onClick={() => supprimerAffectation(selectedBarPlanning, creneau.id)}
                                        className="px-3 py-1.5 bg-red-600/50 rounded-lg text-sm"
                                      >üóëÔ∏è</button>
                                    )}
                                  </div>
                                </div>

                                {hasAffectation ? (
                                  <div className="grid grid-cols-3 gap-2">
                                    <div className="bg-amber-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-amber-400 mb-1">üõí Vendeur</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.vendeur)}</p>
                                    </div>
                                    <div className="bg-blue-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-blue-400 mb-1">üç∫ Serveur</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.serveur)}</p>
                                    </div>
                                    <div className="bg-purple-900/30 p-2 rounded-lg">
                                      <p className="text-xs text-purple-400 mb-1">üèÉ Runner</p>
                                      <p className="text-sm font-medium">{getNomComplet(aff.runner)}</p>
                                    </div>
                                  </div>
                                ) : (
                                  <p className="text-neutral-500 text-sm text-center py-2">Aucun b√©n√©vole affect√©</p>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </>
                    )}
                  </div>
                )}

                {/* ONGLET SYNTH√àSE */}
                {benevoleOnglet === 'synthese' && (
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h4 className="font-bold">Tableau de synth√®se</h4>
                      <button 
                        onClick={exporterBenevoles}
                        disabled={nbAffectations === 0}
                        className="px-4 py-2 bg-green-600 rounded-lg text-sm disabled:opacity-50"
                      >
                        üì• Exporter CSV
                      </button>
                    </div>

                    <div className="overflow-x-auto">
                      <table className="w-full text-sm border-collapse">
                        <thead>
                          <tr className="bg-indigo-900">
                            <th className="border border-indigo-700 px-2 py-2 text-left">Bar</th>
                            <th className="border border-indigo-700 px-2 py-2 text-left">Cr√©neau</th>
                            <th className="border border-indigo-700 px-2 py-2 text-amber-400">üõí</th>
                            <th className="border border-indigo-700 px-2 py-2 text-blue-400">üç∫</th>
                            <th className="border border-indigo-700 px-2 py-2 text-purple-400">üèÉ</th>
                          </tr>
                        </thead>
                        <tbody>
                          {barsNomades.map((bar, barIdx) => (
                            creneaux.map((creneau, creneauIdx) => {
                              const aff = getAffectation(bar.id, creneau.id);
                              return (
                                <tr key={`${bar.id}-${creneau.id}`} className={creneauIdx % 2 === 0 ? 'bg-neutral-900' : 'bg-neutral-800'}>
                                  {creneauIdx === 0 && (
                                    <td 
                                      rowSpan={creneaux.length} 
                                      className={`border border-neutral-700 px-2 py-1 font-medium ${bar.type === 'biere' ? 'bg-amber-900/30' : 'bg-orange-900/30'}`}
                                    >
                                      {bar.nom}
                                    </td>
                                  )}
                                  <td className="border border-neutral-700 px-2 py-1 text-neutral-400">{creneau.label}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.vendeur) : '-'}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.serveur) : '-'}</td>
                                  <td className="border border-neutral-700 px-2 py-1 text-xs">{aff ? getNomComplet(aff.runner) : '-'}</td>
                                </tr>
                              );
                            })
                          ))}
                        </tbody>
                      </table>
                    </div>

                    <div className="mt-4 p-3 bg-indigo-900/30 rounded-xl">
                      <p className="text-sm">
                        <strong>R√©sum√© :</strong> {nbAffectations} cr√©neau(x) avec affectation(s) sur {barsNomades.length * creneaux.length} possibles
                      </p>
                    </div>
                  </div>
                )}

                {/* ONGLET PARAM√àTRES CR√âNEAUX */}
                {benevoleOnglet === 'parametres' && (
                  <div>
                    <h4 className="font-bold mb-4">Configuration des cr√©neaux horaires</h4>
                    
                    <div className="space-y-2 mb-6">
                      {tempCreneaux.map((creneau, index) => (
                        <div key={creneau.id} className="flex items-center gap-2 bg-neutral-800 p-3 rounded-lg">
                          <span className="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">
                            {index + 1}
                          </span>
                          <input
                            type="text"
                            value={creneau.label}
                            onChange={(e) => {
                              const updated = [...tempCreneaux];
                              updated[index] = { ...creneau, label: e.target.value };
                              setTempCreneaux(updated);
                            }}
                            className="flex-1 px-3 py-2 bg-neutral-700 rounded-lg"
                          />
                          <button
                            onClick={() => supprimerCreneauTemp(creneau.id)}
                            disabled={tempCreneaux.length <= 1}
                            className="p-2 text-red-400 disabled:opacity-30"
                          >üóëÔ∏è</button>
                        </div>
                      ))}
                    </div>

                    {tempCreneaux.length < 10 && (
                      <div className="flex gap-2 mb-6">
                        <input
                          type="text"
                          value={nouveauCreneau}
                          onChange={(e) => setNouveauCreneau(e.target.value)}
                          placeholder="Nouveau cr√©neau (ex: 14h-16h)"
                          className="flex-1 px-4 py-2 bg-neutral-800 rounded-lg"
                          onKeyDown={(e) => e.key === 'Enter' && ajouterCreneau()}
                        />
                        <button
                          onClick={ajouterCreneau}
                          disabled={!nouveauCreneau.trim()}
                          className="px-4 py-2 bg-indigo-600 rounded-lg disabled:opacity-50"
                        >‚ûï</button>
                      </div>
                    )}

                    <div className="flex gap-2">
                      <button onClick={() => setBenevoleOnglet('planning')} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                      <button onClick={sauvegarderCreneaux} className="flex-1 py-3 bg-indigo-600 rounded-lg font-medium">üíæ Sauvegarder</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Modal √âdition Affectation */}
          {showModalAffectation && editAffectation && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[60]">
              <div className="bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-bold mb-2">üë• Affecter les b√©n√©voles</h3>
                <p className="text-neutral-400 text-sm mb-4">
                  {barsNomades.find(b => b.id === editAffectation.barId)?.nom} - {creneaux.find(c => c.id === editAffectation.creneauId)?.label}
                </p>

                <div className="space-y-4">
                  {/* Vendeur */}
                  <div className="bg-amber-900/20 p-4 rounded-xl border border-amber-700">
                    <label className="block text-sm font-bold text-amber-400 mb-2">üõí Vendeur</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.vendeur.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          vendeur: { ...prev.vendeur, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.vendeur.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          vendeur: { ...prev.vendeur, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>

                  {/* Serveur */}
                  <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-700">
                    <label className="block text-sm font-bold text-blue-400 mb-2">üç∫ Serveur</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.serveur.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          serveur: { ...prev.serveur, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.serveur.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          serveur: { ...prev.serveur, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>

                  {/* Runner */}
                  <div className="bg-purple-900/20 p-4 rounded-xl border border-purple-700">
                    <label className="block text-sm font-bold text-purple-400 mb-2">üèÉ Runner</label>
                    <div className="grid grid-cols-2 gap-2">
                      <input
                        type="text"
                        placeholder="Pr√©nom"
                        value={editAffectation.runner.prenom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          runner: { ...prev.runner, prenom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Nom"
                        value={editAffectation.runner.nom}
                        onChange={(e) => setEditAffectation(prev => ({
                          ...prev,
                          runner: { ...prev.runner, nom: e.target.value }
                        }))}
                        className="px-3 py-2 bg-neutral-800 rounded-lg"
                      />
                    </div>
                  </div>
                </div>

                <div className="flex gap-2 mt-6">
                  <button onClick={() => { setShowModalAffectation(false); setEditAffectation(null); }} className="flex-1 py-3 bg-neutral-700 rounded-lg">Annuler</button>
                  <button onClick={sauvegarderAffectation} className="flex-1 py-3 bg-indigo-600 rounded-lg font-medium">‚úì Enregistrer</button>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
