<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bar Nomade">
  <meta name="theme-color" content="#39ff14">
  <meta name="description" content="Gestion des f√ªts pour les bars nomades du Hellfest 2026">
  <title>Gestion F√ªts - Hellfest 2026</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; background: #000; }
    @media (display-mode: standalone) { body { padding-top: env(safe-area-inset-top); } }
    #loading-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: #39ff14; }
    #loading-screen.hidden { display: none; }
    .loader-logo { width: 80px; height: 80px; }
  </style>
</head>
<body class="bg-black">
  <div id="loading-screen">
    <img src="logo-hellfest.png" alt="Hellfest" class="loader-logo">
    <p style="margin-top: 20px; font-size: 18px; color: white;">Chargement...</p>
    <p style="margin-top: 8px; font-size: 12px; color: #39ff14; font-weight: bold;">HELLFEST 2026</p>
  </div>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
const { useState, useEffect, useCallback, useRef } = React;

// ==================== CONFIG ====================
const firebaseConfig = {
  apiKey: "AIzaSyCgl30syyCEJif9q96E2jzv-aTXxXgvgv0",
  authDomain: "gestion-futs-hellfest.firebaseapp.com",
  databaseURL: "https://gestion-futs-hellfest-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gestion-futs-hellfest",
  storageBucket: "gestion-futs-hellfest.firebasestorage.app",
  messagingSenderId: "107509834680",
  appId: "1:107509834680:web:3a58295d3268b5d19f654d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================== SYST√àME DE R√îLES ====================
const ROLES = { SUPERADMIN: 'superadmin', ADMIN: 'admin', SECRETAIRE: 'secretaire', VISITEUR: 'visiteur' };

const verifyPassword = (pwd, targetRole) => {
  if (targetRole === 'superadmin') return pwd === 'HF2026Admin';
  if (targetRole === 'admin') return pwd === 'Hellfest26';
  return false;
};

const getRoleFromPassword = (pwd) => {
  if (pwd === 'HF2026Admin') return ROLES.SUPERADMIN;
  if (pwd === 'Hellfest26') return ROLES.ADMIN;
  return ROLES.VISITEUR;
};

const PERMISSIONS = {
  view_stocks: ['superadmin', 'admin'],
  view_plan: ['superadmin', 'admin', 'secretaire', 'visiteur'],
  view_bars: ['superadmin', 'admin', 'secretaire', 'visiteur'],
  attribuer_fut: ['superadmin', 'admin', 'secretaire'],
  retourner_fut: ['superadmin', 'admin', 'secretaire'],
  enregistrer_vente: ['superadmin', 'admin', 'secretaire'],
  saisir_benevoles: ['superadmin', 'admin', 'secretaire'],
  dashboard: ['superadmin', 'admin'],
  historiques: ['superadmin', 'admin'],
  exports: ['superadmin', 'admin'],
  parametres: ['superadmin', 'admin'],
  gerer_bars: ['superadmin', 'admin'],
  promouvoir_secretaire: ['superadmin', 'admin'],
  retrograder_visiteur: ['superadmin', 'admin'],
  ejecter_visiteur: ['superadmin', 'admin'],
  ejecter_secretaire: ['superadmin', 'admin'],
  promouvoir_admin: ['superadmin'],
  ejecter_admin: ['superadmin'],
  reset_rgpd: ['superadmin'],
  panel_sessions: ['superadmin']
};

const canDo = (role, action) => PERMISSIONS[action]?.includes(role) || false;
const getRoleLabel = (r) => ({ superadmin: 'üëë Super Admin', admin: 'üîê Admin', secretaire: 'üìù Secr√©taire', visiteur: 'üëÅÔ∏è Visiteur' }[r] || 'üëÅÔ∏è Visiteur');
const getRoleColor = (r) => ({ superadmin: 'text-yellow-400', admin: 'text-blue-400', secretaire: 'text-green-400', visiteur: 'text-neutral-400' }[r] || 'text-neutral-400');
const getRoleBg = (r) => ({ superadmin: 'bg-yellow-900/30 border-yellow-600', admin: 'bg-blue-900/30 border-blue-600', secretaire: 'bg-green-900/30 border-green-600', visiteur: 'bg-neutral-800 border-neutral-600' }[r] || 'bg-neutral-800 border-neutral-600');

const hideLoading = () => document.getElementById('loading-screen')?.classList.add('hidden');
const formatDate = (ts) => ts ? new Date(ts).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

// ==================== COMPOSANT BADGE R√îLE ====================
const RoleBadge = ({ role }) => React.createElement('span', { className: `text-xs px-2 py-0.5 rounded-full border ${getRoleBg(role)} ${getRoleColor(role)}` }, getRoleLabel(role));

// ==================== √âCRAN DE CONNEXION ====================
const LoginScreen = ({ onLogin }) => {
  const [mode, setMode] = useState('choice');
  const [sessionCode, setSessionCode] = useState('');
  const [userName, setUserName] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [savedSession, setSavedSession] = useState(null);
  const [checkingSession, setCheckingSession] = useState(true);
  const [showSuperPanel, setShowSuperPanel] = useState(false);
  const [allSessions, setAllSessions] = useState([]);
  const [superPassword, setSuperPassword] = useState('');

  useEffect(() => {
    hideLoading();
    // V√©rifier URL params
    const params = new URLSearchParams(window.location.search);
    const urlSession = params.get('session');
    if (urlSession) {
      setSessionCode(urlSession.toUpperCase());
      setMode('join');
      window.history.replaceState({}, '', window.location.pathname);
    }
    // V√©rifier session sauvegard√©e
    const saved = localStorage.getItem('gestionFuts_session');
    const savedUser = localStorage.getItem('gestionFuts_userName');
    const savedRole = localStorage.getItem('gestionFuts_role');
    if (saved && savedUser) {
      db.ref(`sessions/${saved}`).once('value', snap => {
        if (snap.exists()) {
          setSavedSession({ code: saved, userName: savedUser, role: savedRole || 'visiteur' });
        } else {
          localStorage.clear();
        }
        setCheckingSession(false);
      });
    } else {
      setCheckingSession(false);
    }
  }, []);

  const resumeSession = async () => {
    if (!savedSession) return;
    setLoading(true);
    await db.ref(`sessions/${savedSession.code}/users/${savedSession.userName}`).update({ lastActive: Date.now() });
    onLogin(savedSession.code, savedSession.userName, savedSession.role);
  };

  const forgetSession = () => {
    localStorage.clear();
    setSavedSession(null);
  };

  const createSession = async () => {
    if (!userName.trim()) return setError('Nom requis');
    if (!verifyPassword(password, 'superadmin') && !verifyPassword(password, 'admin')) return setError('Mot de passe Admin ou Super Admin requis');
    setLoading(true);
    const role = getRoleFromPassword(password);
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    const config = {
      stockInitialBiere: 150, stockInitialCidre: 50, maxFutsParBar: 3, nombreJours: 4,
      prixPinte: 7, prixPichet: 17, prixGobelet: 5, volumePinte: 0.5, volumePichet: 1.5,
      volumeFutBiere: 30, volumeFutCidre: 20, seuilPerte: 15, createdAt: Date.now(), createdBy: userName.trim()
    };
    const creneaux = [
      { id: 'c1', label: '14h-16h' }, { id: 'c2', label: '16h-18h' }, { id: 'c3', label: '18h-20h' },
      { id: 'c4', label: '20h-22h' }, { id: 'c5', label: '22h-00h' }, { id: 'c6', label: '00h-02h' }
    ];
    const bars = {
      bar1: { id: 'bar1', nom: 'Bar Central', type: 'biere', futs: [] },
      bar2: { id: 'bar2', nom: 'Bar Nord', type: 'biere', futs: [] },
      bar3: { id: 'bar3', nom: 'Bar Cidre', type: 'cidre', futs: [] }
    };
    await db.ref(`sessions/${code}`).set({ config, jourActuel: 1, creneaux, barsNomades: bars });
    await db.ref(`sessions/${code}/users/${userName.trim()}`).set({ role, joinedAt: Date.now(), lastActive: Date.now() });
    localStorage.setItem('gestionFuts_session', code);
    localStorage.setItem('gestionFuts_userName', userName.trim());
    localStorage.setItem('gestionFuts_role', role);
    onLogin(code, userName.trim(), role);
  };

  const joinSession = async () => {
    if (!sessionCode.trim() || !userName.trim()) return setError('Code et nom requis');
    setLoading(true);
    const code = sessionCode.trim().toUpperCase();
    const snap = await db.ref(`sessions/${code}`).once('value');
    if (!snap.exists()) { setLoading(false); return setError('Session introuvable'); }
    
    const role = getRoleFromPassword(password);
    let finalName = userName.trim();
    
    // V√©rifier si le nom existe d√©j√†
    const usersSnap = await db.ref(`sessions/${code}/users`).once('value');
    if (usersSnap.exists() && usersSnap.val()[finalName]) {
      finalName = `${finalName}_${Date.now().toString(36).slice(-4)}`;
    }
    
    await db.ref(`sessions/${code}/users/${finalName}`).set({ role, joinedAt: Date.now(), lastActive: Date.now() });
    localStorage.setItem('gestionFuts_session', code);
    localStorage.setItem('gestionFuts_userName', finalName);
    localStorage.setItem('gestionFuts_role', role);
    onLogin(code, finalName, role);
  };

  const loadAllSessions = async () => {
    const snap = await db.ref('sessions').once('value');
    if (snap.exists()) {
      const sessions = Object.entries(snap.val()).map(([code, data]) => ({
        code,
        createdAt: data.config?.createdAt,
        createdBy: data.config?.createdBy,
        usersCount: data.users ? Object.keys(data.users).length : 0,
        barsCount: data.barsNomades ? Object.keys(data.barsNomades).length : 0
      })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      setAllSessions(sessions);
    }
  };

  const deleteSession = async (code) => {
    if (!confirm(`Supprimer d√©finitivement la session ${code} ?`)) return;
    await db.ref(`sessions/${code}`).remove();
    loadAllSessions();
  };

  const openSuperPanel = () => {
    if (!verifyPassword(superPassword, 'superadmin')) return setError('Mot de passe Super Admin incorrect');
    loadAllSessions();
    setShowSuperPanel(true);
    setError('');
  };

  if (checkingSession) {
    return React.createElement('div', { className: 'min-h-screen bg-black flex items-center justify-center' },
      React.createElement('div', { className: 'text-white text-center' }, 'Chargement...')
    );
  }

  // Panel Super Admin
  if (showSuperPanel) {
    return React.createElement('div', { className: 'min-h-screen bg-black p-4' },
      React.createElement('div', { className: 'max-w-lg mx-auto' },
        React.createElement('div', { className: 'flex items-center justify-between mb-6' },
          React.createElement('h2', { className: 'text-xl font-bold text-yellow-400' }, 'üëë Panel Super Admin'),
          React.createElement('button', { onClick: () => setShowSuperPanel(false), className: 'text-neutral-400 text-xl' }, '‚úï')
        ),
        React.createElement('div', { className: 'space-y-2 max-h-96 overflow-y-auto' },
          allSessions.map(s => React.createElement('div', { key: s.code, className: 'flex items-center justify-between bg-neutral-900 p-3 rounded-lg' },
            React.createElement('div', null,
              React.createElement('p', { className: 'font-mono font-bold text-white' }, s.code),
              React.createElement('p', { className: 'text-xs text-neutral-400' }, `${s.createdBy || '?'} ‚Ä¢ ${s.usersCount} users ‚Ä¢ ${s.barsCount} bars`)
            ),
            React.createElement('button', { onClick: () => deleteSession(s.code), className: 'text-red-400 hover:text-red-300 px-2' }, 'üóëÔ∏è')
          )),
          allSessions.length === 0 && React.createElement('p', { className: 'text-neutral-500 text-center py-8' }, 'Aucune session')
        ),
        React.createElement('button', { onClick: () => { localStorage.clear(); location.reload(); }, className: 'w-full mt-6 py-3 bg-red-900 hover:bg-red-800 rounded-lg text-white' }, 'üßπ Purger localStorage')
      )
    );
  }

  // Session sauvegard√©e
  if (savedSession) {
    return React.createElement('div', { className: 'min-h-screen bg-black flex items-center justify-center p-4' },
      React.createElement('div', { className: 'w-full max-w-sm text-center' },
        React.createElement('h1', { className: 'text-2xl font-bold text-white mb-2' }, 'üç∫ GESTION F√õTS'),
        React.createElement('p', { className: 'text-[#39ff14] font-bold mb-8' }, 'HELLFEST 2026'),
        React.createElement('div', { className: 'bg-neutral-900 rounded-xl p-6 mb-4' },
          React.createElement('p', { className: 'text-neutral-400 mb-2' }, 'Session en cours'),
          React.createElement('p', { className: 'text-3xl font-mono font-bold text-white mb-2' }, savedSession.code),
          React.createElement('p', { className: 'text-white mb-1' }, savedSession.userName),
          React.createElement(RoleBadge, { role: savedSession.role })
        ),
        React.createElement('button', { onClick: resumeSession, disabled: loading, className: 'w-full py-4 bg-red-600 hover:bg-red-700 rounded-xl font-bold text-white text-lg mb-3 disabled:opacity-50' }, loading ? '...' : '‚ñ∂Ô∏è Reprendre'),
        React.createElement('button', { onClick: forgetSession, className: 'w-full py-3 text-neutral-400 hover:text-white' }, 'Changer de session')
      )
    );
  }

  // Formulaires
  return React.createElement('div', { className: 'min-h-screen bg-black flex items-center justify-center p-4' },
    React.createElement('div', { className: 'w-full max-w-sm' },
      React.createElement('div', { className: 'text-center mb-8' },
        React.createElement('h1', { className: 'text-3xl font-black text-white' }, 'üç∫ GESTION F√õTS'),
        React.createElement('p', { className: 'text-[#39ff14] font-bold' }, 'HELLFEST 2026')
      ),
      error && React.createElement('div', { className: 'bg-red-900/50 text-red-300 p-3 rounded-lg mb-4 text-sm' }, error),
      
      mode === 'choice' && React.createElement('div', { className: 'space-y-3' },
        React.createElement('button', { onClick: () => setMode('create'), className: 'w-full py-4 bg-red-600 hover:bg-red-700 rounded-xl font-bold text-white text-lg' }, '‚ûï Cr√©er une session'),
        React.createElement('button', { onClick: () => setMode('join'), className: 'w-full py-4 bg-neutral-800 hover:bg-neutral-700 rounded-xl font-bold text-white text-lg' }, 'üîó Rejoindre'),
        React.createElement('div', { className: 'pt-4 border-t border-neutral-800 mt-4' },
          React.createElement('input', { type: 'password', value: superPassword, onChange: e => setSuperPassword(e.target.value), placeholder: 'Mot de passe Super Admin', className: 'w-full px-4 py-3 bg-neutral-900 rounded-lg text-white mb-2' }),
          React.createElement('button', { onClick: openSuperPanel, className: 'w-full py-3 bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-400 rounded-xl text-sm' }, 'üëë Panel Super Admin')
        )
      ),

      mode === 'create' && React.createElement('div', { className: 'space-y-4' },
        React.createElement('input', { type: 'text', value: userName, onChange: e => setUserName(e.target.value), placeholder: 'Votre nom', className: 'w-full px-4 py-3 bg-neutral-900 rounded-xl text-white' }),
        React.createElement('input', { type: 'password', value: password, onChange: e => setPassword(e.target.value), placeholder: 'Mot de passe Admin ou Super Admin', className: 'w-full px-4 py-3 bg-neutral-900 rounded-xl text-white' }),
        React.createElement('p', { className: 'text-xs text-neutral-500' }, 'Un mot de passe Admin ou Super Admin est requis pour cr√©er une session'),
        React.createElement('button', { onClick: createSession, disabled: loading, className: 'w-full py-4 bg-red-600 rounded-xl font-bold text-white disabled:opacity-50' }, loading ? '...' : 'üöÄ Cr√©er'),
        React.createElement('button', { onClick: () => { setMode('choice'); setError(''); }, className: 'w-full py-3 text-neutral-400' }, '‚Üê Retour')
      ),

      mode === 'join' && React.createElement('div', { className: 'space-y-4' },
        React.createElement('input', { type: 'text', value: sessionCode, onChange: e => setSessionCode(e.target.value.toUpperCase()), placeholder: 'Code session', maxLength: 6, className: 'w-full px-4 py-3 bg-neutral-900 rounded-xl text-white font-mono text-center text-xl tracking-widest' }),
        React.createElement('input', { type: 'text', value: userName, onChange: e => setUserName(e.target.value), placeholder: 'Votre nom', className: 'w-full px-4 py-3 bg-neutral-900 rounded-xl text-white' }),
        React.createElement('input', { type: 'password', value: password, onChange: e => setPassword(e.target.value), placeholder: 'Mot de passe (optionnel)', className: 'w-full px-4 py-3 bg-neutral-900 rounded-xl text-white' }),
        React.createElement('p', { className: 'text-xs text-neutral-500' }, 'Sans mot de passe = Visiteur (lecture seule)'),
        React.createElement('button', { onClick: joinSession, disabled: loading, className: 'w-full py-4 bg-emerald-600 rounded-xl font-bold text-white disabled:opacity-50' }, loading ? '...' : 'üîó Rejoindre'),
        React.createElement('button', { onClick: () => { setMode('choice'); setError(''); }, className: 'w-full py-3 text-neutral-400' }, '‚Üê Retour')
      )
    )
  );
};

// ==================== APPLICATION PRINCIPALE ====================
const MainApp = ({ session, userName, initialRole, onLogout }) => {
  // √âtats donn√©es
  const [config, setConfig] = useState({ stockInitialBiere: 150, stockInitialCidre: 50, maxFutsParBar: 3, nombreJours: 4, prixPinte: 7, prixPichet: 17, prixGobelet: 5, volumePinte: 0.5, volumePichet: 1.5, volumeFutBiere: 30, volumeFutCidre: 20, seuilPerte: 15 });
  const [jourActuel, setJourActuel] = useState(1);
  const [barsNomades, setBarsNomades] = useState([]);
  const [historique, setHistorique] = useState([]);
  const [historiqueVentes, setHistoriqueVentes] = useState([]);
  const [creneaux, setCreneaux] = useState([]);
  const [users, setUsers] = useState({});
  const [role, setRole] = useState(initialRole);
  const [futsEnAttente, setFutsEnAttente] = useState([]);
  const [barPositions, setBarPositions] = useState({});
  const [benevoles, setBenevoles] = useState({});

  // √âtats UI
  const [notification, setNotification] = useState('');
  const [activeTab, setActiveTab] = useState('bars');
  const [showModalSession, setShowModalSession] = useState(false);
  const [showModalAttribution, setShowModalAttribution] = useState(false);
  const [showModalRetour, setShowModalRetour] = useState(false);
  const [showModalVente, setShowModalVente] = useState(false);
  const [showModalParametres, setShowModalParametres] = useState(false);
  const [showModalHistorique, setShowModalHistorique] = useState(false);
  const [showModalHistoriqueVentes, setShowModalHistoriqueVentes] = useState(false);
  const [showModalDashboard, setShowModalDashboard] = useState(false);
  const [showModalPlan, setShowModalPlan] = useState(false);
  const [showModalExport, setShowModalExport] = useState(false);
  const [showModalBenevoles, setShowModalBenevoles] = useState(false);
  const [showModalReset, setShowModalReset] = useState(false);
  const [showModalQR, setShowModalQR] = useState(false);
  const [showModalAjoutBar, setShowModalAjoutBar] = useState(false);
  const [selectedBar, setSelectedBar] = useState(null);
  const [selectedFut, setSelectedFut] = useState(null);
  const [editingPlan, setEditingPlan] = useState(false);
  const [newArrivals, setNewArrivals] = useState([]);

  const isDisconnectingRef = useRef(false);
  const sessionRef = db.ref(`sessions/${session}`);

  // Raccourcis permissions
  const isAdmin = role === 'admin' || role === 'superadmin';
  const isSuperAdmin = role === 'superadmin';
  const isSecretaire = role === 'secretaire';
  const canEdit = canDo(role, 'attribuer_fut');

  // Notification
  const showNotif = (msg) => { setNotification(msg); setTimeout(() => setNotification(''), 3000); };

  // Firebase listeners
  useEffect(() => {
    hideLoading();
    const refs = [];
    const listen = (path, cb) => { const ref = sessionRef.child(path); ref.on('value', cb); refs.push(ref); };

    listen('config', snap => { if (snap.exists()) setConfig(snap.val()); });
    listen('jourActuel', snap => { if (snap.exists()) setJourActuel(snap.val()); });
    listen('barsNomades', snap => { setBarsNomades(snap.exists() ? Object.values(snap.val()) : []); });
    listen('historique', snap => { setHistorique(snap.exists() ? Object.values(snap.val()).sort((a, b) => b.timestamp - a.timestamp) : []); });
    listen('historiqueVentes', snap => { setHistoriqueVentes(snap.exists() ? Object.values(snap.val()).sort((a, b) => b.timestamp - a.timestamp) : []); });
    listen('creneaux', snap => { if (snap.exists()) setCreneaux(snap.val()); });
    listen('futsEnAttente', snap => { setFutsEnAttente(snap.exists() ? Object.values(snap.val()) : []); });
    listen('barPositions', snap => { if (snap.exists()) setBarPositions(snap.val()); });
    listen('benevoles', snap => { setBenevoles(snap.exists() ? snap.val() : {}); });
    listen('users', snap => {
      if (snap.exists()) {
        const u = snap.val();
        setUsers(u);
        // Mettre √† jour le r√¥le si modifi√© par un admin
        if (u[userName]) {
          setRole(u[userName].role);
          localStorage.setItem('gestionFuts_role', u[userName].role);
        } else if (!isDisconnectingRef.current) {
          alert('Vous avez √©t√© d√©connect√© par un administrateur');
          onLogout();
        }
        // D√©tecter nouveaux arrivants (visiteurs < 60s)
        const now = Date.now();
        const arrivals = Object.entries(u)
          .filter(([name, data]) => data.role === 'visiteur' && (now - data.joinedAt) < 60000)
          .map(([name]) => name);
        setNewArrivals(arrivals);
      }
    });

    // Heartbeat
    const hb = setInterval(() => sessionRef.child(`users/${userName}/lastActive`).set(Date.now()), 30000);
    return () => { refs.forEach(r => r.off()); clearInterval(hb); };
  }, []);

  // Calculs stocks
  const futsSortisBiere = historique.filter(m => !m.annule && m.type === 'SORTIE' && m.typeFut === 'biere').reduce((sum, m) => sum + (m.jour <= jourActuel ? 1 : 0), 0);
  const futsSortisCidre = historique.filter(m => !m.annule && m.type === 'SORTIE' && m.typeFut === 'cidre').reduce((sum, m) => sum + (m.jour <= jourActuel ? 1 : 0), 0);
  const futsRetoursBiere = historique.filter(m => !m.annule && m.type === 'RETOUR_PLEIN' && m.typeFut === 'biere').reduce((sum, m) => sum + (m.jour <= jourActuel ? 1 : 0), 0);
  const futsRetoursCidre = historique.filter(m => !m.annule && m.type === 'RETOUR_PLEIN' && m.typeFut === 'cidre').reduce((sum, m) => sum + (m.jour <= jourActuel ? 1 : 0), 0);
  const stockBiere = config.stockInitialBiere - futsSortisBiere + futsRetoursBiere;
  const stockCidre = config.stockInitialCidre - futsSortisCidre + futsRetoursCidre;

  // ==================== ACTIONS ====================
  const attribuerFut = async (barId, typeFut, futAttenteId = null) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (!bar) return;
    if ((bar.futs?.length || 0) >= config.maxFutsParBar) return showNotif('‚ùå Bar au maximum de f√ªts');
    const stock = typeFut === 'biere' ? stockBiere : stockCidre;
    if (stock <= 0 && !futAttenteId) return showNotif('‚ùå Stock insuffisant');

    const futId = futAttenteId || `fut_${Date.now()}`;
    const newFut = { id: futId, type: typeFut, dateAttribution: Date.now() };
    await sessionRef.child(`barsNomades/${barId}/futs`).set([...(bar.futs || []), newFut]);
    await sessionRef.child('historique').push({
      id: futId, type: 'SORTIE', barId, barNom: bar.nom,
      typeFut: futAttenteId ? futsEnAttente.find(f => f.id === futAttenteId)?.typeFut : typeFut,
      jour: jourActuel, timestamp: Date.now(), user: userName
    });
    if (futAttenteId) await sessionRef.child(`futsEnAttente/${futAttenteId}`).remove();
    setShowModalAttribution(false);
    showNotif(`‚úÖ F√ªt attribu√© √† ${bar.nom}`);
  };

  const retournerFut = async (barId, futId, etat) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (!bar) return;
    const newFuts = (bar.futs || []).filter(f => f.id !== futId);
    await sessionRef.child(`barsNomades/${barId}/futs`).set(newFuts.length ? newFuts : null);
    
    const typeRetour = etat === 'vide' ? 'RETOUR_VIDE' : etat === 'casse' ? 'RETOUR_CASSE' : 'RETOUR_PLEIN';
    await sessionRef.child('historique').push({
      id: futId, type: typeRetour, barId, barNom: bar.nom, typeFut: bar.type,
      jour: jourActuel, timestamp: Date.now(), user: userName
    });
    if (etat === 'plein') {
      await sessionRef.child(`futsEnAttente/${futId}`).set({ id: futId, typeFut: bar.type, fromBar: bar.nom, timestamp: Date.now() });
    }
    setShowModalRetour(false);
    setSelectedBar(null);
    setSelectedFut(null);
    showNotif(`‚úÖ F√ªt retourn√© (${etat})`);
  };

  const enregistrerVente = async (data) => {
    await sessionRef.child('historiqueVentes').push({
      id: `vente_${Date.now()}`, ...data, jour: jourActuel, timestamp: Date.now(), user: userName
    });
    setShowModalVente(false);
    showNotif('‚úÖ Vente enregistr√©e');
  };

  const promouvoir = async (name, newRole) => {
    await sessionRef.child(`users/${name}/role`).set(newRole);
    showNotif(`‚úÖ ${name} ‚Üí ${getRoleLabel(newRole)}`);
  };

  const ejecter = async (name) => {
    if (!confirm(`√âjecter ${name} de la session ?`)) return;
    await sessionRef.child(`users/${name}`).remove();
    showNotif(`‚úÖ ${name} √©ject√©`);
  };

  const disconnect = () => {
    isDisconnectingRef.current = true;
    sessionRef.child(`users/${userName}`).remove();
    localStorage.clear();
    onLogout();
  };

  const changerJour = async (delta) => {
    const newJour = Math.max(1, Math.min(config.nombreJours, jourActuel + delta));
    await sessionRef.child('jourActuel').set(newJour);
  };

  const ajouterBar = async (nom, type) => {
    const id = `bar_${Date.now()}`;
    await sessionRef.child(`barsNomades/${id}`).set({ id, nom, type, futs: [] });
    setShowModalAjoutBar(false);
    showNotif('‚úÖ Bar ajout√©');
  };

  const supprimerBar = async (barId) => {
    const bar = barsNomades.find(b => b.id === barId);
    if (bar?.futs?.length > 0) return showNotif('‚ùå Retournez les f√ªts d\'abord');
    if (!confirm(`Supprimer ${bar?.nom} ?`)) return;
    await sessionRef.child(`barsNomades/${barId}`).remove();
    showNotif('‚úÖ Bar supprim√©');
  };

  const annulerMouvement = async (mvtId) => {
    if (!confirm('Annuler ce mouvement ?')) return;
    const snap = await sessionRef.child('historique').once('value');
    if (snap.exists()) {
      const entries = Object.entries(snap.val());
      const found = entries.find(([k, v]) => v.id === mvtId);
      if (found) {
        await sessionRef.child(`historique/${found[0]}/annule`).set(true);
        showNotif('‚úÖ Mouvement annul√©');
      }
    }
  };

  const sauvegarderConfig = async (newConfig) => {
    await sessionRef.child('config').update(newConfig);
    setShowModalParametres(false);
    showNotif('‚úÖ Configuration sauvegard√©e');
  };

  const resetRGPD = async () => {
    if (!confirm('‚ö†Ô∏è ATTENTION: Supprimer TOUTES les donn√©es (historiques, ventes, b√©n√©voles) ?')) return;
    await sessionRef.child('historique').remove();
    await sessionRef.child('historiqueVentes').remove();
    await sessionRef.child('benevoles').remove();
    await sessionRef.child('futsEnAttente').remove();
    for (const bar of barsNomades) {
      await sessionRef.child(`barsNomades/${bar.id}/futs`).remove();
    }
    setShowModalReset(false);
    showNotif('‚úÖ Donn√©es r√©initialis√©es');
  };

  // Export CSV
  const exportCSV = (type) => {
    let csv, filename;
    if (type === 'futs') {
      const headers = ['Date', 'Type', 'Bar', 'Type F√ªt', 'Jour', 'Utilisateur', 'Annul√©'];
      const rows = historique.map(m => [formatDate(m.timestamp), m.type, m.barNom, m.typeFut, `J${m.jour}`, m.user, m.annule ? 'Oui' : '']);
      csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      filename = `historique_futs_${session}.csv`;
    } else {
      const headers = ['Date', 'Bar', 'Cr√©neau', 'Montant', 'Pintes', 'Pichets', 'Gobelets', 'Jour', 'Utilisateur'];
      const rows = historiqueVentes.map(v => [formatDate(v.timestamp), v.barNom, v.creneauLabel, v.montant?.toFixed(2), v.pintes, v.pichets, v.gobelets, `J${v.jour}`, v.user]);
      csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
      filename = `historique_ventes_${session}.csv`;
    }
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    showNotif('üì• CSV export√©');
  };

  // ==================== RENDER ====================
  const e = React.createElement;

  // Header
  const renderHeader = () => e('div', { className: 'bg-neutral-900 px-4 py-3 flex items-center justify-between sticky top-0 z-40 border-b border-neutral-800' },
    e('div', null,
      e('h1', { className: 'font-bold text-lg text-white' }, `üç∫ Hellfest J${jourActuel}`),
      e('div', { className: 'flex items-center gap-2' },
        e('span', { className: 'text-sm text-neutral-400' }, userName),
        e(RoleBadge, { role })
      )
    ),
    e('button', { onClick: () => setShowModalSession(true), className: 'bg-neutral-800 px-3 py-2 rounded-lg text-sm font-mono text-white' }, session)
  );

  // Alerte nouveaux arrivants (pour admins)
  const renderNewArrivals = () => {
    if (!isAdmin || newArrivals.length === 0) return null;
    return e('div', { className: 'mx-4 mt-3 p-3 bg-blue-900/50 rounded-xl border border-blue-600' },
      e('p', { className: 'text-sm font-medium text-blue-200 mb-2' }, `üÜï ${newArrivals.length} nouveau(x) visiteur(s)`),
      e('div', { className: 'flex flex-wrap gap-2' },
        newArrivals.map(name => e('button', {
          key: name,
          onClick: () => promouvoir(name, 'secretaire'),
          className: 'text-xs bg-green-600 hover:bg-green-500 px-3 py-1 rounded-full text-white'
        }, `${name} ‚Üí Secr√©taire`))
      )
    );
  };

  // Stocks (visibles uniquement pour admin)
  const renderStocks = () => {
    if (!canDo(role, 'view_stocks')) return null;
    return e('div', { className: 'p-4 grid grid-cols-2 gap-3' },
      e('div', { className: 'bg-amber-900/30 p-4 rounded-xl border border-amber-700' },
        e('p', { className: 'text-xs text-amber-300' }, 'üç∫ Stock Bi√®re'),
        e('p', { className: 'text-3xl font-black text-amber-400' }, stockBiere),
        e('p', { className: 'text-xs text-neutral-400' }, `sur ${config.stockInitialBiere}`)
      ),
      e('div', { className: 'bg-green-900/30 p-4 rounded-xl border border-green-700' },
        e('p', { className: 'text-xs text-green-300' }, 'üçé Stock Cidre'),
        e('p', { className: 'text-3xl font-black text-green-400' }, stockCidre),
        e('p', { className: 'text-xs text-neutral-400' }, `sur ${config.stockInitialCidre}`)
      )
    );
  };

  // Message visiteur
  const renderVisitorMessage = () => {
    if (role !== 'visiteur') return null;
    return e('div', { className: 'mx-4 mt-3 p-4 bg-neutral-800 rounded-xl border border-neutral-700 text-center' },
      e('p', { className: 'text-neutral-300' }, 'üëÅÔ∏è Mode lecture seule'),
      e('p', { className: 'text-sm text-neutral-500 mt-1' }, 'Contactez un admin pour √™tre promu Secr√©taire')
    );
  };

  // F√ªts en attente
  const renderFutsEnAttente = () => {
    if (!canEdit || futsEnAttente.length === 0) return null;
    return e('div', { className: 'mx-4 mb-3 p-3 bg-purple-900/30 rounded-xl border border-purple-600' },
      e('p', { className: 'text-sm font-medium text-purple-300' }, `üì¶ ${futsEnAttente.length} f√ªt(s) plein(s) en attente de r√©attribution`)
    );
  };

  // Liste des bars
  const renderBars = () => e('div', { className: 'px-4 space-y-3 pb-4' },
    e('div', { className: 'flex items-center justify-between' },
      e('h2', { className: 'font-bold text-lg text-white' }, 'Bars Nomades'),
      canDo(role, 'gerer_bars') && e('button', { onClick: () => setShowModalAjoutBar(true), className: 'text-sm bg-red-600 px-3 py-1 rounded-lg text-white' }, '+ Bar')
    ),
    barsNomades.map(bar => {
      const futsCount = bar.futs?.length || 0;
      const isFull = futsCount >= config.maxFutsParBar;
      return e('div', { key: bar.id, className: 'bg-neutral-900 rounded-xl p-4' },
        e('div', { className: 'flex items-center justify-between mb-3' },
          e('div', null,
            e('p', { className: 'font-bold text-white' }, `${bar.type === 'biere' ? 'üç∫' : 'üçé'} ${bar.nom}`),
            e('p', { className: 'text-xs text-neutral-400' }, `${futsCount}/${config.maxFutsParBar} f√ªts`)
          ),
          e('div', { className: 'flex gap-2' },
            canEdit && e('button', {
              onClick: () => { setSelectedBar(bar); setShowModalAttribution(true); },
              disabled: isFull,
              className: `px-3 py-2 rounded-lg text-sm text-white ${isFull ? 'bg-neutral-700 opacity-50' : 'bg-red-600 hover:bg-red-500'}`
            }, '+ F√ªt'),
            canDo(role, 'gerer_bars') && e('button', { onClick: () => supprimerBar(bar.id), className: 'text-red-400 hover:text-red-300 px-2' }, 'üóëÔ∏è')
          )
        ),
        futsCount > 0 && e('div', { className: 'space-y-2' },
          bar.futs.map(fut => e('div', { key: fut.id, className: 'flex items-center justify-between bg-neutral-800 p-2 rounded-lg' },
            e('span', { className: 'font-mono text-xs text-neutral-300' }, fut.id.slice(-8)),
            canEdit && e('div', { className: 'flex gap-1' },
              e('button', { onClick: () => retournerFut(bar.id, fut.id, 'vide'), className: 'px-2 py-1 bg-orange-600 hover:bg-orange-500 rounded text-xs text-white' }, 'Vide'),
              e('button', { onClick: () => retournerFut(bar.id, fut.id, 'casse'), className: 'px-2 py-1 bg-red-600 hover:bg-red-500 rounded text-xs text-white' }, 'Cass√©'),
              e('button', { onClick: () => retournerFut(bar.id, fut.id, 'plein'), className: 'px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs text-white' }, 'Plein')
            )
          ))
        )
      );
    }),
    barsNomades.length === 0 && e('p', { className: 'text-center text-neutral-500 py-8' }, 'Aucun bar configur√©')
  );

  // Barre d'actions
  const renderActionBar = () => e('div', { className: 'fixed bottom-0 left-0 right-0 bg-neutral-900 border-t border-neutral-800 px-4 py-3 z-30' },
    e('div', { className: 'flex gap-2 justify-center flex-wrap' },
      canDo(role, 'enregistrer_vente') && e('button', { onClick: () => setShowModalVente(true), className: 'px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm text-white' }, 'üí∞ Vente'),
      canDo(role, 'dashboard') && e('button', { onClick: () => setShowModalDashboard(true), className: 'px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm text-white' }, 'üìä Dashboard'),
      canDo(role, 'view_plan') && e('button', { onClick: () => setShowModalPlan(true), className: 'px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm text-white' }, 'üó∫Ô∏è Plan'),
      canDo(role, 'historiques') && e('button', { onClick: () => setShowModalHistorique(true), className: 'px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm text-white' }, 'üìã Histo'),
      canDo(role, 'exports') && e('button', { onClick: () => setShowModalExport(true), className: 'px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg text-sm text-white' }, 'üì• Export'),
      canDo(role, 'parametres') && e('button', { onClick: () => setShowModalParametres(true), className: 'px-4 py-2 bg-neutral-700 hover:bg-neutral-600 rounded-lg text-sm text-white' }, '‚öôÔ∏è')
    )
  );

  // Notification toast
  const renderNotification = () => notification && e('div', { className: 'fixed top-20 left-4 right-4 bg-neutral-800 text-white p-3 rounded-lg text-center z-50 shadow-lg' }, notification);

  // ==================== MODALS ====================

  // Modal Session
  const renderModalSession = () => showModalSession && e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50', onClick: () => setShowModalSession(false) },
    e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto', onClick: ev => ev.stopPropagation() },
      e('div', { className: 'flex items-center justify-between mb-4' },
        e('h3', { className: 'text-xl font-bold text-white' }, 'üì± Session'),
        e('button', { onClick: () => setShowModalSession(false), className: 'text-neutral-400 text-xl' }, '‚úï')
      ),
      e('div', { className: 'bg-neutral-800 p-4 rounded-xl mb-4 text-center' },
        e('p', { className: 'text-3xl font-mono font-bold text-white tracking-widest' }, session),
        e('button', { onClick: () => setShowModalQR(true), className: 'text-sm text-blue-400 mt-2' }, 'üì∑ QR Code')
      ),
      e('h4', { className: 'font-bold text-white mb-2' }, `Utilisateurs (${Object.keys(users).length})`),
      e('div', { className: 'space-y-2 mb-4 max-h-60 overflow-y-auto' },
        Object.entries(users).map(([name, data]) => e('div', { key: name, className: 'flex items-center justify-between bg-neutral-800 p-3 rounded-lg' },
          e('div', null,
            e('p', { className: 'font-medium text-white' }, name, name === userName && e('span', { className: 'text-xs text-neutral-500 ml-2' }, '(vous)')),
            e(RoleBadge, { role: data.role })
          ),
          isAdmin && name !== userName && e('div', { className: 'flex gap-1 flex-wrap justify-end' },
            // Promouvoir visiteur ‚Üí secr√©taire
            canDo(role, 'promouvoir_secretaire') && data.role === 'visiteur' && e('button', { onClick: () => promouvoir(name, 'secretaire'), className: 'text-xs bg-green-600 px-2 py-1 rounded text-white' }, '‚Üí Sec'),
            // R√©trograder secr√©taire ‚Üí visiteur
            canDo(role, 'retrograder_visiteur') && data.role === 'secretaire' && e('button', { onClick: () => promouvoir(name, 'visiteur'), className: 'text-xs bg-orange-600 px-2 py-1 rounded text-white' }, '‚Üí Vis'),
            // Promouvoir secr√©taire ‚Üí admin (super admin only)
            canDo(role, 'promouvoir_admin') && data.role === 'secretaire' && e('button', { onClick: () => promouvoir(name, 'admin'), className: 'text-xs bg-blue-600 px-2 py-1 rounded text-white' }, '‚Üí Adm'),
            // √âjecter
            ((data.role === 'visiteur' && canDo(role, 'ejecter_visiteur')) ||
             (data.role === 'secretaire' && canDo(role, 'ejecter_secretaire')) ||
             (data.role === 'admin' && canDo(role, 'ejecter_admin'))) &&
              e('button', { onClick: () => ejecter(name), className: 'text-xs bg-red-600 px-2 py-1 rounded text-white' }, '‚úï')
          )
        ))
      ),
      e('div', { className: 'flex gap-2' },
        e('button', { onClick: () => setShowModalSession(false), className: 'flex-1 py-3 bg-neutral-700 rounded-lg text-white' }, 'Fermer'),
        e('button', { onClick: disconnect, className: 'py-3 px-4 bg-red-600 rounded-lg text-white' }, 'Quitter')
      )
    )
  );

  // Modal Attribution
  const renderModalAttribution = () => showModalAttribution && selectedBar && e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
    e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-sm p-6' },
      e('h3', { className: 'text-xl font-bold text-white mb-4' }, `‚ûï Attribuer √† ${selectedBar.nom}`),
      e('div', { className: 'space-y-3' },
        futsEnAttente.length > 0 && e('div', { className: 'mb-4' },
          e('p', { className: 'text-sm text-purple-300 mb-2' }, 'üì¶ F√ªts en attente :'),
          futsEnAttente.map(f => e('button', {
            key: f.id,
            onClick: () => attribuerFut(selectedBar.id, f.typeFut, f.id),
            className: 'w-full py-2 px-3 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm mb-1'
          }, `${f.typeFut === 'biere' ? 'üç∫' : 'üçé'} ${f.id.slice(-8)} (de ${f.fromBar})`))
        ),
        e('p', { className: 'text-sm text-neutral-400 mb-2' }, 'Nouveau f√ªt du stock :'),
        e('button', {
          onClick: () => attribuerFut(selectedBar.id, 'biere'),
          disabled: stockBiere <= 0,
          className: 'w-full py-3 bg-amber-600 hover:bg-amber-500 rounded-lg text-white disabled:opacity-50 mb-2'
        }, `üç∫ Bi√®re (${stockBiere} dispo)`),
        e('button', {
          onClick: () => attribuerFut(selectedBar.id, 'cidre'),
          disabled: stockCidre <= 0,
          className: 'w-full py-3 bg-green-600 hover:bg-green-500 rounded-lg text-white disabled:opacity-50'
        }, `üçé Cidre (${stockCidre} dispo)`)
      ),
      e('button', { onClick: () => { setShowModalAttribution(false); setSelectedBar(null); }, className: 'w-full py-3 bg-neutral-700 rounded-lg text-white mt-4' }, 'Annuler')
    )
  );

  // Modal Vente
  const renderModalVente = () => {
    const [barId, setBarId] = useState('');
    const [creneauId, setCreneauId] = useState(creneaux[0]?.id || '');
    const [montant, setMontant] = useState('');
    const [pintes, setPintes] = useState('');
    const [pichets, setPichets] = useState('');
    const [gobelets, setGobelets] = useState('');

    if (!showModalVente) return null;
    const bar = barsNomades.find(b => b.id === barId);
    const creneau = creneaux.find(c => c.id === creneauId);

    return e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
      e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-sm p-6' },
        e('h3', { className: 'text-xl font-bold text-white mb-4' }, 'üí∞ Nouvelle vente'),
        e('div', { className: 'space-y-3' },
          e('select', { value: barId, onChange: ev => setBarId(ev.target.value), className: 'w-full px-4 py-3 bg-neutral-800 rounded-lg text-white' },
            e('option', { value: '' }, 'S√©lectionner un bar'),
            barsNomades.map(b => e('option', { key: b.id, value: b.id }, `${b.type === 'biere' ? 'üç∫' : 'üçé'} ${b.nom}`))
          ),
          e('select', { value: creneauId, onChange: ev => setCreneauId(ev.target.value), className: 'w-full px-4 py-3 bg-neutral-800 rounded-lg text-white' },
            creneaux.map(c => e('option', { key: c.id, value: c.id }, c.label))
          ),
          e('input', { type: 'number', value: montant, onChange: ev => setMontant(ev.target.value), placeholder: 'Montant (‚Ç¨)', step: '0.01', className: 'w-full px-4 py-3 bg-neutral-800 rounded-lg text-white' }),
          e('div', { className: 'grid grid-cols-3 gap-2' },
            e('input', { type: 'number', value: pintes, onChange: ev => setPintes(ev.target.value), placeholder: 'Pintes', className: 'px-3 py-2 bg-neutral-800 rounded-lg text-white text-center' }),
            e('input', { type: 'number', value: pichets, onChange: ev => setPichets(ev.target.value), placeholder: 'Pichets', className: 'px-3 py-2 bg-neutral-800 rounded-lg text-white text-center' }),
            e('input', { type: 'number', value: gobelets, onChange: ev => setGobelets(ev.target.value), placeholder: 'Gobelets', className: 'px-3 py-2 bg-neutral-800 rounded-lg text-white text-center' })
          )
        ),
        e('div', { className: 'flex gap-2 mt-4' },
          e('button', { onClick: () => setShowModalVente(false), className: 'flex-1 py-3 bg-neutral-700 rounded-lg text-white' }, 'Annuler'),
          e('button', {
            onClick: () => {
              if (!barId || !montant) return;
              enregistrerVente({
                barId, barNom: bar?.nom, barType: bar?.type,
                creneauId, creneauLabel: creneau?.label,
                montant: parseFloat(montant) || 0,
                pintes: parseInt(pintes) || 0,
                pichets: parseInt(pichets) || 0,
                gobelets: parseInt(gobelets) || 0
              });
            },
            disabled: !barId || !montant,
            className: 'flex-1 py-3 bg-emerald-600 rounded-lg text-white font-medium disabled:opacity-50'
          }, 'Valider')
        )
      )
    );
  };

  // Modal Dashboard
  const renderModalDashboard = () => {
    if (!showModalDashboard || !isAdmin) return null;
    const caJour = historiqueVentes.filter(v => v.jour === jourActuel).reduce((s, v) => s + (v.montant || 0), 0);
    const caTotal = historiqueVentes.reduce((s, v) => s + (v.montant || 0), 0);
    const futsJour = historique.filter(m => !m.annule && m.type === 'SORTIE' && m.jour === jourActuel).length;
    const futsCasses = historique.filter(m => !m.annule && m.type === 'RETOUR_CASSE').length;

    return e('div', { className: 'fixed inset-0 bg-black/90 flex flex-col z-50' },
      e('div', { className: 'bg-amber-900 px-4 py-3 flex items-center justify-between' },
        e('h3', { className: 'text-xl font-bold text-white' }, `üìä Dashboard J${jourActuel}`),
        e('button', { onClick: () => setShowModalDashboard(false), className: 'text-white text-2xl' }, '‚úï')
      ),
      e('div', { className: 'flex-1 overflow-y-auto p-4' },
        e('div', { className: 'max-w-2xl mx-auto space-y-4' },
          e('div', { className: 'grid grid-cols-2 gap-3' },
            e('div', { className: 'bg-emerald-900/30 p-4 rounded-xl border border-emerald-700' },
              e('p', { className: 'text-xs text-emerald-300' }, 'üí∞ CA Jour'),
              e('p', { className: 'text-3xl font-black text-emerald-400' }, `${caJour.toFixed(0)} ‚Ç¨`)
            ),
            e('div', { className: 'bg-blue-900/30 p-4 rounded-xl border border-blue-700' },
              e('p', { className: 'text-xs text-blue-300' }, 'üõ¢Ô∏è F√ªts sortis (jour)'),
              e('p', { className: 'text-3xl font-black text-blue-400' }, futsJour)
            ),
            e('div', { className: 'bg-amber-900/30 p-4 rounded-xl border border-amber-700' },
              e('p', { className: 'text-xs text-amber-300' }, 'üí∞ CA Total'),
              e('p', { className: 'text-3xl font-black text-amber-400' }, `${caTotal.toFixed(0)} ‚Ç¨`)
            ),
            e('div', { className: 'bg-red-900/30 p-4 rounded-xl border border-red-700' },
              e('p', { className: 'text-xs text-red-300' }, 'üíî F√ªts cass√©s'),
              e('p', { className: 'text-3xl font-black text-red-400' }, futsCasses)
            )
          ),
          e('div', { className: 'bg-neutral-800 p-4 rounded-xl' },
            e('h4', { className: 'font-bold text-white mb-3' }, 'üìä CA par bar (jour)'),
            barsNomades.map(bar => {
              const ca = historiqueVentes.filter(v => v.barId === bar.id && v.jour === jourActuel).reduce((s, v) => s + (v.montant || 0), 0);
              return e('div', { key: bar.id, className: 'flex items-center justify-between py-2 border-b border-neutral-700 last:border-0' },
                e('span', { className: 'text-white' }, `${bar.type === 'biere' ? 'üç∫' : 'üçé'} ${bar.nom}`),
                e('span', { className: 'font-bold text-emerald-400' }, `${ca.toFixed(0)} ‚Ç¨`)
              );
            })
          )
        )
      )
    );
  };

  // Modal Historique
  const renderModalHistorique = () => {
    if (!showModalHistorique || !isAdmin) return null;
    return e('div', { className: 'fixed inset-0 bg-black/90 flex flex-col z-50' },
      e('div', { className: 'bg-purple-900 px-4 py-3 flex items-center justify-between' },
        e('h3', { className: 'text-xl font-bold text-white' }, 'üìã Historique F√ªts'),
        e('button', { onClick: () => setShowModalHistorique(false), className: 'text-white text-2xl' }, '‚úï')
      ),
      e('div', { className: 'flex-1 overflow-y-auto p-4' },
        e('div', { className: 'space-y-2' },
          historique.slice(0, 100).map((mvt, i) => e('div', {
            key: i,
            className: `flex items-center justify-between p-3 rounded-lg ${mvt.annule ? 'bg-neutral-800 opacity-50' : 'bg-neutral-800'}`
          },
            e('div', null,
              e('p', { className: 'font-medium text-white' },
                mvt.type === 'SORTIE' ? 'üì§' : mvt.type === 'RETOUR_VIDE' ? 'üì•' : mvt.type === 'RETOUR_CASSE' ? 'üíî' : 'üîÑ',
                ' ', mvt.type, ' - ', mvt.barNom,
                mvt.annule && e('span', { className: 'text-red-400 ml-2' }, '(annul√©)')
              ),
              e('p', { className: 'text-xs text-neutral-400' }, `${formatDate(mvt.timestamp)} ‚Ä¢ ${mvt.user} ‚Ä¢ J${mvt.jour}`)
            ),
            !mvt.annule && canDo(role, 'historiques') && e('button', { onClick: () => annulerMouvement(mvt.id), className: 'text-red-400 hover:text-red-300 px-2' }, '‚úï')
          )),
          historique.length === 0 && e('p', { className: 'text-center text-neutral-500 py-8' }, 'Aucun mouvement')
        )
      )
    );
  };

  // Modal Export
  const renderModalExport = () => showModalExport && isAdmin && e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
    e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-sm p-6' },
      e('h3', { className: 'text-xl font-bold text-white mb-4' }, 'üì• Exporter'),
      e('div', { className: 'space-y-2' },
        e('button', { onClick: () => exportCSV('futs'), disabled: historique.length === 0, className: 'w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg text-white disabled:opacity-50' }, `üìã CSV F√ªts (${historique.length})`),
        e('button', { onClick: () => exportCSV('ventes'), disabled: historiqueVentes.length === 0, className: 'w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white disabled:opacity-50' }, `üí∞ CSV Ventes (${historiqueVentes.length})`)
      ),
      e('button', { onClick: () => setShowModalExport(false), className: 'w-full py-3 bg-neutral-700 rounded-lg text-white mt-4' }, 'Fermer')
    )
  );

  // Modal Param√®tres
  const renderModalParametres = () => {
    const [localConfig, setLocalConfig] = useState(config);
    if (!showModalParametres || !isAdmin) return null;

    return e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
      e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto' },
        e('h3', { className: 'text-xl font-bold text-white mb-4' }, '‚öôÔ∏è Param√®tres'),
        
        e('div', { className: 'mb-4' },
          e('h4', { className: 'font-bold text-sm text-neutral-400 mb-2' }, 'Jour actuel'),
          e('div', { className: 'flex items-center gap-2' },
            e('button', { onClick: () => changerJour(-1), disabled: jourActuel <= 1, className: 'px-4 py-2 bg-neutral-700 rounded-lg text-white disabled:opacity-50' }, '‚Üê'),
            e('span', { className: 'flex-1 text-center text-2xl font-bold text-white' }, `J${jourActuel}`),
            e('button', { onClick: () => changerJour(1), disabled: jourActuel >= config.nombreJours, className: 'px-4 py-2 bg-neutral-700 rounded-lg text-white disabled:opacity-50' }, '‚Üí')
          )
        ),

        isSuperAdmin && e('div', { className: 'space-y-3 mb-4' },
          e('h4', { className: 'font-bold text-sm text-neutral-400' }, 'Stocks initiaux'),
          e('div', { className: 'grid grid-cols-2 gap-2' },
            e('div', null,
              e('label', { className: 'text-xs text-neutral-400' }, 'üç∫ Bi√®re'),
              e('input', { type: 'number', value: localConfig.stockInitialBiere, onChange: ev => setLocalConfig({ ...localConfig, stockInitialBiere: parseInt(ev.target.value) || 0 }), className: 'w-full px-3 py-2 bg-neutral-800 rounded-lg text-white' })
            ),
            e('div', null,
              e('label', { className: 'text-xs text-neutral-400' }, 'üçé Cidre'),
              e('input', { type: 'number', value: localConfig.stockInitialCidre, onChange: ev => setLocalConfig({ ...localConfig, stockInitialCidre: parseInt(ev.target.value) || 0 }), className: 'w-full px-3 py-2 bg-neutral-800 rounded-lg text-white' })
            )
          ),
          e('div', { className: 'grid grid-cols-2 gap-2' },
            e('div', null,
              e('label', { className: 'text-xs text-neutral-400' }, 'Max f√ªts/bar'),
              e('input', { type: 'number', value: localConfig.maxFutsParBar, onChange: ev => setLocalConfig({ ...localConfig, maxFutsParBar: parseInt(ev.target.value) || 1 }), className: 'w-full px-3 py-2 bg-neutral-800 rounded-lg text-white' })
            ),
            e('div', null,
              e('label', { className: 'text-xs text-neutral-400' }, 'Nb jours'),
              e('input', { type: 'number', value: localConfig.nombreJours, onChange: ev => setLocalConfig({ ...localConfig, nombreJours: parseInt(ev.target.value) || 1 }), className: 'w-full px-3 py-2 bg-neutral-800 rounded-lg text-white' })
            )
          )
        ),

        e('div', { className: 'flex gap-2' },
          e('button', { onClick: () => setShowModalParametres(false), className: 'flex-1 py-3 bg-neutral-700 rounded-lg text-white' }, 'Fermer'),
          isSuperAdmin && e('button', { onClick: () => sauvegarderConfig(localConfig), className: 'flex-1 py-3 bg-red-600 rounded-lg text-white font-medium' }, 'üíæ Sauver')
        ),

        isSuperAdmin && e('button', { onClick: () => { setShowModalParametres(false); setShowModalReset(true); }, className: 'w-full mt-4 py-3 bg-red-900 hover:bg-red-800 rounded-lg text-white border border-red-600' }, 'üîí R√©initialisation RGPD')
      )
    );
  };

  // Modal Reset RGPD
  const renderModalReset = () => showModalReset && isSuperAdmin && e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
    e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-sm p-6' },
      e('h3', { className: 'text-xl font-bold text-red-400 mb-4' }, '‚ö†Ô∏è R√©initialisation RGPD'),
      e('p', { className: 'text-sm text-neutral-400 mb-4' }, 'Cette action supprimera d√©finitivement tous les historiques, ventes et donn√©es de b√©n√©voles.'),
      e('div', { className: 'flex gap-2' },
        e('button', { onClick: () => setShowModalReset(false), className: 'flex-1 py-3 bg-neutral-700 rounded-lg text-white' }, 'Annuler'),
        e('button', { onClick: resetRGPD, className: 'flex-1 py-3 bg-red-600 rounded-lg text-white font-medium' }, 'Confirmer')
      )
    )
  );

  // Modal Plan
  const renderModalPlan = () => showModalPlan && e('div', { className: 'fixed inset-0 bg-black/90 flex flex-col z-50' },
    e('div', { className: 'bg-blue-900 px-4 py-3 flex items-center justify-between' },
      e('h3', { className: 'text-xl font-bold text-white' }, 'üó∫Ô∏è Plan des bars'),
      e('button', { onClick: () => setShowModalPlan(false), className: 'text-white text-2xl' }, '‚úï')
    ),
    e('div', { className: 'flex-1 relative bg-neutral-900 overflow-hidden' },
      e('div', { className: 'absolute inset-4 border-2 border-dashed border-neutral-700 rounded-xl flex items-center justify-center' },
        e('div', { className: 'grid grid-cols-2 gap-4 p-4' },
          barsNomades.map(bar => {
            const futsCount = bar.futs?.length || 0;
            const color = futsCount === 0 ? 'bg-green-600' : futsCount >= config.maxFutsParBar ? 'bg-red-600' : 'bg-yellow-600';
            return e('div', { key: bar.id, className: `${color} px-4 py-3 rounded-xl text-center` },
              e('p', { className: 'font-bold text-white' }, `${bar.type === 'biere' ? 'üç∫' : 'üçé'} ${bar.nom}`),
              e('p', { className: 'text-sm text-white/80' }, `${futsCount}/${config.maxFutsParBar} f√ªts`)
            );
          })
        )
      ),
      e('div', { className: 'absolute bottom-4 left-4 text-xs text-neutral-500' }, 'üü¢ Disponible | üü° En service | üî¥ Complet')
    )
  );

  // Modal QR
  const renderModalQR = () => showModalQR && e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50', onClick: () => setShowModalQR(false) },
    e('div', { className: 'bg-neutral-900 rounded-2xl p-6 text-center', onClick: ev => ev.stopPropagation() },
      e('h3', { className: 'text-xl font-bold text-white mb-4' }, 'üì∑ QR Code'),
      e('div', { className: 'bg-white p-4 rounded-xl inline-block mb-4' },
        e('img', { src: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.origin + '?session=' + session)}`, alt: 'QR' })
      ),
      e('p', { className: 'text-3xl font-mono font-bold text-white' }, session)
    )
  );

  // Modal Ajout Bar
  const renderModalAjoutBar = () => {
    const [nom, setNom] = useState('');
    const [type, setType] = useState('biere');
    if (!showModalAjoutBar) return null;
    
    return e('div', { className: 'fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50' },
      e('div', { className: 'bg-neutral-900 rounded-2xl w-full max-w-sm p-6' },
        e('h3', { className: 'text-xl font-bold text-white mb-4' }, '‚ûï Nouveau bar'),
        e('input', { type: 'text', value: nom, onChange: ev => setNom(ev.target.value), placeholder: 'Nom du bar', className: 'w-full px-4 py-3 bg-neutral-800 rounded-lg text-white mb-3' }),
        e('select', { value: type, onChange: ev => setType(ev.target.value), className: 'w-full px-4 py-3 bg-neutral-800 rounded-lg text-white mb-4' },
          e('option', { value: 'biere' }, 'üç∫ Bi√®re'),
          e('option', { value: 'cidre' }, 'üçé Cidre')
        ),
        e('div', { className: 'flex gap-2' },
          e('button', { onClick: () => setShowModalAjoutBar(false), className: 'flex-1 py-3 bg-neutral-700 rounded-lg text-white' }, 'Annuler'),
          e('button', { onClick: () => nom.trim() && ajouterBar(nom.trim(), type), disabled: !nom.trim(), className: 'flex-1 py-3 bg-red-600 rounded-lg text-white font-medium disabled:opacity-50' }, 'Ajouter')
        )
      )
    );
  };

  // ==================== RENDER PRINCIPAL ====================
  return e('div', { className: 'min-h-screen bg-black text-white pb-24' },
    renderHeader(),
    renderNewArrivals(),
    renderVisitorMessage(),
    renderStocks(),
    renderFutsEnAttente(),
    renderBars(),
    renderActionBar(),
    renderNotification(),
    // Modals
    renderModalSession(),
    renderModalAttribution(),
    renderModalVente(),
    renderModalDashboard(),
    renderModalHistorique(),
    renderModalExport(),
    renderModalParametres(),
    renderModalReset(),
    renderModalPlan(),
    renderModalQR(),
    renderModalAjoutBar()
  );
};

// ==================== APP ROOT ====================
const App = () => {
  const [session, setSession] = useState(null);
  const [userName, setUserName] = useState('');
  const [role, setRole] = useState('visiteur');

  const handleLogin = (sess, user, r) => {
    setSession(sess);
    setUserName(user);
    setRole(r);
  };

  const handleLogout = () => {
    setSession(null);
    setUserName('');
    setRole('visiteur');
  };

  if (!session) return React.createElement(LoginScreen, { onLogin: handleLogin });
  return React.createElement(MainApp, { session, userName, initialRole: role, onLogout: handleLogout });
};

// Render
ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
